这些优化技术主要旨在解决 DP 状态转移复杂度过高的问题（通常将 $O(N^2)$ 降低至 $O(N \log N)$ 或 $O(N)$）。

### DP 优化最佳实践总览

**核心心法**：

1.  **先写暴力 DP**：明确状态定义（$dp[i]$ 或 $dp[i][j]$）和转移方程。
2.  **观察转移瓶颈**：
    - 是区间求和/最值？ $\to$ **前缀和 / 线段树 / 单调队列**
    - 是 $i, j$ 乘积项 ($a[i] \times b[j]$)？ $\to$ **斜率优化 (CHT)**
    - 决策点 $opt[i]$ 单调递增？ $\to$ **分治优化**
    - 代价函数满足四边形不等式(monge)？ $\to$ **Monge图d边最短路 / 四边形不等式优化**
    - 函数是凸函数叠加？ $\to$ **Slope Trick**

---

### 一、 辅助数据结构优化 (Data Structure Optimization)

最基础且常用的优化手段，用于快速获取某个范围内的状态信息。

#### 1. 前缀和优化 (Prefix Sum)

- **适用场景**：转移方程涉及连续区间的和、积、最值。
  - $dp[i] = \sum_{k=L}^{R} dp[k]$
- **最佳实践**：
  - **分离变量**：将转移方程变形，把只与 $j$ 相关的项分离出来维护前缀和。
  - **处理边界**：在实现时，注意 $index-1 < 0$ 的情况，通常使用 `padding` 或者 `max(0, ...)` 以及 `if` 检查。
  - **二维降维**：二维 DP 中，通常将连续的那个维度放在数组的第二个维度（内存局部性更好，且切片操作更方便）。
  - **滚动数组**：注意先计算 `new_dp` 再更新 `prefix_sum`。

#### 2. 单调队列优化 (Monotonic Queue)

- **适用场景**：滑动窗口最值模型。
  - $dp[i] = \min_{j \in [i-k, i-1]} \{ dp[j] + val[j] \}$
- **最佳实践**：
  - **存下标**：队列中存储下标 `index` 而不是值，这样方便判断队头是否过期 (`index < i - k`)。
  - **维护单调性**：队尾入队时，弹出所有比当前劣的元素。

#### 3. 线段树/树状数组优化

- **适用场景**：不仅仅是区间查询，涉及“权值”维度的 DP。
  - 例如：$dp[i][v]$ 表示前 $i$ 个数，当前权值为 $v$ 的最优解。如果 $v$ 值域很大但离散，或者操作涉及区间更新，使用线段树维护 $v$ 维度。
- **最佳实践**：
  - **权值线段树**：如果权值 $\le 2 \times 10^5$，直接用线段树节点索引代替 DP 的第二维。

---

### 二、 几何与代数优化 (Geometric & Algebraic)

#### 1. 斜率优化 (Convex Hull Trick - CHT)

- **适用场景**：转移方程包含 $i$ 和 $j$ 的乘积项（交叉项）。
  - $dp[i] = \min_{j < i} \{ dp[j] + A[i] \times B[j] + C[j] \} + D[i]$
  - 形式化为直线方程 $y = kx + b$，其中 $x$ 和斜率 $k$ 只与 $j$ 或 $i$ 有关。
- **技术细节**：
  - **斜率 $k$ 单调**：可以使用 **单调队列** 维护凸包，$O(N)$。
  - **斜率 $k$ 不单调**：需要在凸包上 **二分查找** 或使用 **李超线段树 (Li Chao Tree)**，$O(N \log N)$。
- **最佳实践**：
  - **化简式子**：不要死记硬背，将式子写成 $y = kx + b$ 的形式，明确 $x, y, k, b$ 分别对应什么。
  - **避免浮点数**：比较斜率 $\frac{y_2-y_1}{x_2-x_1} \le \frac{y_3-y_2}{x_3-x_2}$ 时，使用乘法形式 `(y2-y1)*(x3-x2) <= (y3-y2)*(x2-x1)` 避免精度问题。

#### 2. Slope Trick

- **适用场景**：DP 状态函数 $f(x)$ 是凸函数，且转移过程是由多个绝对值函数 $|x-a|$ 或其他简单凸函数叠加而成。
  - $dp[i][x] = \min_y (dp[i-1][y] + |x - a_i|)$
- **最佳实践**：
  - **维护转折点**：只需用两个堆（大顶堆和小顶堆）维护凸函数的拐点，而不需要记录具体的函数值。
  - **复杂度**：将 $O(NK)$ 优化至 $O(N \log N)$。

---

### 三、 决策单调性优化 (Decision Monotonicity)

这类优化基于一个核心性质：**最优决策点不回头**。即对于 $i' > i$，如果 $i$ 的最优决策点是 $opt[i]$，那么 $i'$ 的最优决策点 $opt[i'] \ge opt[i]$。

#### 1. 理论基础：Monge 理论体系

决策单调性的强弱取决于代价函数 $w(i, j)$ 的数学性质，从强到弱依次为：

- **Monge 性质 (四边形不等式)**：$\forall a < b < c < d, \, w(a, c) + w(b, d) \le w(a, d) + w(b, c)$。这是最常见的判据，绝大多数凸代价（如平方项）都满足此性质。
- **Totally Monotone (TM)**：矩阵的所有 $2 \times 2$ 子矩阵都满足 Monotone。
- **Monotone**：仅满足行最小值列号单调递增。

**核心结论**：**Monge $\implies$ TM $\implies$ 决策单调性**。满足 Monge 的问题不仅能分治，还能使用 WQS 二分（凸性保证）。

#### 2. 分治优化 DP (Divide & Conquer Optimization) - 【离线/按层】

- **适用场景**：$dp[k][j] = \min_{i < j} \{ dp[k-1][i] + w(i, j) \}$。每一层的状态仅依赖于**上一层**完整的结果。
- **最佳实践**：
  - 适用于 $k$ 较小的情况。
  - 函数签名通常为 `solve(L, R, optL, optR)`，递归计算区间。
  - 复杂度 $O(NK \log N)$。

#### 3. Online-Offline DP / 二分栈 - 【在线/同层】

- **适用场景**：$dp[i] = \min_{j < i} \{ dp[j] + w(j, i) \}$。当前状态依赖于**同层**之前已经算出的状态。
- **最佳实践**：
  - **分治诱导 (CDQ)**：先算左边，用左边更新右边（离线化），再算右边。复杂度 $O(N \log^2 N)$。
  - **二分栈**：维护一个栈，保存决策点及其“生效区间”。复杂度 $O(N \log N)$。

#### 4. Aliens DP + Monge 最短路 - 【降维打击】

- **适用场景**：划分 $k$ 段且满足 Monge 性质。
- **最佳实践**：
  - 利用 Monge 矩阵最短路函数 $f(k)$ 的凸性，通过 WQS 二分去掉 $k$ 维度。
  - **此时 2D DP 转为 1D/1D DP**，结合 Monge 最短路算法。
  - 复杂度 $O(N \log N \log V)$。

---

### 四、 状态定义优化 (State Definition)

- **正难则反**：如果正向计算很复杂，考虑补集或反向 DP。
- **更换状态**：
  - 如果背包容量特别大但价值很小，交换 DP 状态与值：$dp[val] = min\_weight$。
- **倍增/二进制分组 DP**：
  - 当需要进行极大多次转移时（如 $10^9$ 次），结合矩阵快速幂或倍增法。

### 总结：拿到 DP 题的优化路线图

1.  **写出朴素方程**：$dp[i] = \min(dp[j] +cost(j, i))$。
2.  **看 $cost(j, i)$ 的形式**：
    - 只有 $j$ 的项和常数项？ $\to$ **单调队列/前缀和**。
    - 有 $i \times j$ 交叉项？ $\to$ **斜率优化**。
    - 是任意函数但满足四边形不等式？ $\to$ **决策单调性 (分治/二分栈)**。
3.  **看限制条件**：
    - 恰好 $k$ 次？ $\to$ **WQS 二分 / Monge d-边最短路**。
    - 数据结构相关限制？ $\to$ **线段树优化 DP**。

---

### DP 优化复杂度对比表

| 优化技术              | 典型复杂度                           | 核心前提                     | 备注                                                                                                     |
| :-------------------- | :----------------------------------- | :--------------------------- | :------------------------------------------------------------------------------------------------------- |
| **朴素 DP**           | $O(N^2)$ 或 $O(NK)$                  | -                            | 暴力遍历                                                                                                 |
| **前缀和 / 差分**     | $O(N)$                               | 线性区间贡献                 | -                                                                                                        |
| **单调队列 / 栈**     | $O(N)$                               | 决策点被淘汰后永不恢复       | 滑动窗口最值                                                                                             |
| **线段树 / 树状数组** | $O(N \log N)$                        | 结合数据结构维护区间         | 涉及区间修改或权值维                                                                                     |
| **斜率优化 (CHT)**    | $O(N)$ 或 $O(N \log N)$              | 交叉项形如 $A[i] \cdot B[j]$ | $O(N)$ 仅限斜率单调时                                                                                    |
| **Slope Trick**       | $O(N \log N)$                        | 凸函数叠加、转折点维护       | 维护绝对值函数 $f(x) = \sum \vert x-a_i \vert$                                                           |
| **分治优化 DP**       | $O(NK \log N)$                       | 决策单调性 / 二维按层        | 适用于划分 $k$ 段且无前后依赖。转移函数有决策单调性使用分治，有monge性(四边形不等式)使用Monge d-边最短路 |
| **二分栈 (1D1D)**     | $O(N \log N)$                        | 四边形不等式 / 同层转移      | 适用于后面状态依赖前面计算出的值                                                                         |
| **Aliens DP (WQS)**   | $O(N \cdot T_{inner} \log V)$        | 凸性 (Convexity)             | 消除“恰好 $k$ 次”维度的终极方案                                                                          |
| **Monge 最短路**      | $O(N \log N)$或$O(N)$                | Monge 性质 (四边形不等式)    | [1D1D DP 的通用快速解](https://noshi91.hatenablog.com/entry/2023/02/18/005856)                           |
| **Monge d-边最短路**  | $O(N \log N \log V)$ 或$O(N \log V)$ | Monge + 凸性                 | [当前最强 DP 组合拳](https://noshi91.github.io/algorithm-encyclopedia/d-edge-shortest-path-monge)        |

> **注**：$N$ 为序列长度，$K$ 为划分段数，$V$ 为二分值域或权值范围。

`kitamasa法` (模 $x^n-1$ 的多项式快速幂) 和 `MongeShortestPath` (SMAWK 算法的图论应用) 属于更高级的进阶技巧，通常针对特定的竞赛难题。

### 决策单调性理论层次

https://noshi91.hatenablog.com/entry/2023/02/18/005856
https://scrapbox.io/Kodaman/Monotone_%2F_Totally_Monotone_%2F_Monge
https://lorent-kyopro.hatenablog.com/entry/2021/04/04/133958
https://topcoder-g-hatena-ne-jp.jag-icpc.org/spaghetti_source/20120923/1348327542.html

- **Monge (最强)**：满足 $w(a,c)+w(b,d) \le w(a,d)+w(b,c)$。适用于绝大多数平方/凸代价函数。
- **Totally Monotone (TM)**：任意子矩阵最小值位置单调。
- **Monotone (最弱)**：仅当前矩阵行最小值位置单调。

| 性质名称                  | 定义 / 特征                               | 关系   | 对应算法               |
| :------------------------ | :---------------------------------------- | :----- | :--------------------- |
| **Monge (四边形不等式)**  | $f(a, c) + f(b, d) \le f(a, d) + f(b, c)$ | 强约束 | **LARSCH** / **SMAWK** |
| **Totally Monotone (TM)** | 任意子矩阵都是 Monotone                   | 中间层 | **SMAWK**              |
| **Monotone (单调)**       | 每一行的最小值列号 $j_i \le j_{i+1}$      | 弱约束 | **Monotone-Minima**    |

- **Monge $\implies$ Totally Monotone $\implies$ Monotone**。
- **核心结论**：大部分 DP 优化（如平方代价、凸代价）实际上都满足 **Monge 性质**，这保证了我们可以使用最强力的 $O(N \log N)$ 甚至 $O(N)$ 算法。

---

**Monotone（单调）并不意味着 Totally Monotone（全单调），更不意味着 Monge。**

在代价矩阵的性质中，约束强度是 **Monge $\subset$ Totally Monotone $\subset$ Monotone**。

### 1. 概念回顾

假设代价矩阵为 $A$，其中 $A[i][j]$ 表示从 $j$ 转移到 $i$ 的代价：

- **Monotone（单调）**：记每行的最小值列号为 $j(i)$。如果 $i < i'$，则 $j(i) \le j(i')$。
- **Totally Monotone（全单调）**：对于 $A$ 的**任意**子矩阵，都满足 Monotone 性质。
- **Monge（四边形不等式）**：对于任意 $a < b$ 和 $c < d$，满足 $A[a][c] + A[b][d] \le A[a][d] + A[b][c]$。

### 2. 反例：满足 Monotone 但不满足 Monge/TM

我们可以构建一个简单的矩阵，它的全行最小值是单调的，但在某些局部却违背了规律。

**矩阵示例：**

$$
A = \begin{bmatrix}
2 & 0 & 2 & 2 \\
1 & 2 & 2 & 0
\end{bmatrix}
$$

- **检查 Monotone (全行)：**
  - 第 0 行最小值在索引 1（值是 0）。
  - 第 1 行最小值在索引 3（值是 0）。
  - $1 \le 3$，满足 **Monotone**。
- **检查 Totally Monotone (子矩阵)：**
  观察左上角的 $2 \times 2$ 子矩阵（列 0 和列 1）：
  $$
  \begin{bmatrix}
  2 & 0 \\
  1 & 2
  \end{bmatrix}
  $$
  - 在这个子矩阵里，第 0 行最小值是索引 1。
  - 第 1 行最小值是索引 0。
  - $1 > 0$，决策点回跳了！因此它**不满足 Totally Monotone**。
- **检查 Monge：**
  因为 Monge 必能推导出 TM，所以它也**不满足 Monge**。

### 3. 在 DP 优化中的实际意义

https://leetcode.cn/post-editor/solution/edit/?solutionSlug=jue-ce-dan-diao-xing-you-hua-dp-de-yi-xi-cfpw

虽然数学上存在这种反例，但在**自然建模**的算法题中，这种“仅 Monotone 但不满足 Monge”的情况极少见：

1.  **分治优化 DP（离线）**：只需要满足 **Monotone** 即可使用。因为它只关注当前层相对于上一层的整体决策点分布。
2.  **SMAWK 算法**：必须满足 **Totally Monotone**。如果只有 Monotone，SMAWK 会失效。
3.  **WQS 二分 (Aliens DP)**：必须满足 **Monge**。因为 WQS 二分依赖于最优解函数 $f(k)$ 的**凸性**，而凸性是由 Monge 性质（四边形不等式）严格保证的。如果只有 Monotone，函数可能不满足凸性，二分惩罚值会得到错误结果。

### 总结建议

如果你能证明每个子矩阵的决策点都不回跳（即满足 TM），或者证明了四边形不等式（即满足 Monge），那你可以放心使用最顶级的优化。如果你只能**打表发现总体的 $j(i)$ 是递增的**，那么最稳妥的选择是 **分治优化 DP**，因为它对性质的依赖最弱。

---

**闵可夫斯基和 (Minkowski Sum)** 与这些 DP 优化技术（尤其是 Aliens DP / WQS 二分）的关系可以概括为：**它是“凸性”在多个对象合并时的数学表现形式，是导致 Aliens DP 可行的根本原因之一。**

以下是它们之间的深度联系：

### 1. 什么是闵可夫斯基和？

在几何上，两个集合 $A$ 和 $B$ 的闵可夫斯基和定义为：
$$A \oplus B = \{ a + b \mid a \in A, b \in B \}$$
在算法竞赛中，我们通常关注的是**两个凸包的闵可夫斯基和**。一个核心性质是：**两个凸多边形的闵可夫斯基和仍然是一个凸多边形**，且其边是由原先两个多边形的边按斜率排序后拼接而成的。

### 2. 与 Aliens DP (WQS 二分) 的关系

Aliens DP 的核心前提是：**答案函数 $f(k)$ 关于选择个数 $k$ 是凸的。**

- **合并即和**：很多题目要求“从 $n$ 组物品中每组选一个，总共选 $k$ 个”。如果每一组物品内部的“代价-数量”关系是凸的，那么把这些组“合并”起来的过程，在数学上就相当于对这些凸包做**闵可夫斯基和**。
- **凸性保持**：因为闵可夫斯基和保持凸性，所以最终的总代价函数 $f(k)$ 也是凸的。
- **WQS 二分的几何意义**：WQS 二分本质上是在直观地利用这个合并后的凸包。二分的斜率 $\lambda$ 就像是在这堆按斜率排好序的“边”中寻找一个临界点。

### 3. 与 Monge 矩阵 / 最短路的关系

在 index.go 讨论的问题中：

- **Monge 矩阵最短路**：在 Monge 图中，求经过 $k$ 条边的最短路 $f(k)$。
- **本质**：这可以看作是 $k$ 个凸段（或满足 Monge 性质的边）进行的 **(min, +) 卷积**。
- **(min, +) 卷积与闵可夫斯基和**：两个凸序列的 (min, +) 卷积，在几何意义上等价于它们对应凸包的**闵可夫斯基和的下边界**。
- **结论**：因为 Monge 性质保证了每一段转移的“边”具有某种凸性，合并后的 $f(k)$ 必然仍是凸的。

### 4. 总结：三位一体

| 概念                | 视角          | 在 DP 优化中的角色                                     |
| :------------------ | :------------ | :----------------------------------------------------- |
| **Monge 性质**      | **局部/微观** | 保证了代价矩阵具备“不交叉”的良好结构。                 |
| **闵可夫斯基和**    | **整体/宏观** | 描述了多个凸结构合并后依然保持凸性的**数学本质**。     |
| **Aliens DP (WQS)** | **算法/工具** | 利用上述性质产生的**凸性**，通过二分斜率实现降维打击。 |

**一句话理解：**
因为代价函数满足 **Monge** 性质，使得问题的解空间在合并时遵循 **闵可夫斯基和** 的规律，从而产生了一个完美的 **凸函数 $f(k)$**，这最终让我们能用 **WQS 二分** 跑通程序。
