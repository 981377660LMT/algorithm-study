# 决策单调性优化 DP 的一些参考资料

在处理形如 $dp[k][j] = \min_{0 \le i < j} \{dp[k-1][i] + w(i, j)\}$ 的序列分割问题时，如果代价函数 $w(i, j)$ 满足**四边形不等式**，即对于所有的 $a \le b \le c \le d$，满足 $w(a, c) + w(b, d) \le w(a, d) + w(b, c)$，那么该状态转移方程具有**决策单调性**。设 $opt[k][j]$ 为 $dp[k][j]$ 的最优决策点，则有 $opt[k][j] \le opt[k][j+1]$。
利用这一性质，我们可以使用分治优化将复杂度从 $O(k \cdot n^2)$ 降低至 $O(k \cdot n \log n)$。

### 题解代码

```go
package main

const INF int = 1e18

func minPartitionScore(nums []int, k int) int64 {
	n := len(nums)
	presum := make([]int, n+1)
	for i, v := range nums {
		presum[i+1] = presum[i] + v
	}
	cost := func(l, r int, _ int) int {
		s := presum[r] - presum[l]
		return s * (s + 1) / 2
	}
	dp := DivideAndConquerOptimization(k, n, cost)
	return int64(dp[k][n])
}

// DivideAndConquerOptimization
// f(i,j,step): 左闭右开区间 [i,j) 的代价 (0<=i<j<=n)
func DivideAndConquerOptimization(k, n int, f func(i, j, step int) int) [][]int {
	dp := make([][]int, k+1)
	for i := range dp {
		dp[i] = make([]int, n+1)
		for j := range dp[i] {
			dp[i][j] = INF
		}
	}
	dp[0][0] = 0

	for k_ := 1; k_ <= k; k_++ {
		getCost := func(y, x int) int {
			if x >= y || dp[k_-1][x] == INF {
				return INF
			}
			return dp[k_-1][x] + f(x, y, k_)
		}
		res := monotoneminima(n+1, n+1, getCost)
		for j := 0; j <= n; j++ {
			dp[k_][j] = res[j][1]
		}
	}

	return dp
}

// monotoneminima 对每个 0<=i<H 求出 f(i,j) 取得最小值的 (j, f(i,j)) (0<=j<W)
func monotoneminima(H, W int, f func(i, j int) int) [][2]int {
	dp := make([][2]int, H)

	var dfs func(top, bottom, left, right int)
	dfs = func(top, bottom, left, right int) {
		if top > bottom {
			return
		}

		mid := (top + bottom) >> 1
		index := -1
		res := 0
		for i := left; i <= right; i++ {
			tmp := f(mid, i)
			if index == -1 || tmp < res {
				index = i
				res = tmp
			}
		}
		dp[mid] = [2]int{index, res}
		dfs(top, mid-1, left, index)
		dfs(mid+1, bottom, index, right)
	}

	dfs(0, H-1, 0, W-1)
	return dp
}
```

### 参考资料

- **理论详解**：
  - [Alex_Wei 的 DP 优化方法（二）](https://www.cnblogs.com/alex-wei/p/DP_optimization_method_II.html)
  - [决策单调性优化学习笔记](https://www.cnblogs.com/purplevine/p/16990286.html)
- **算法库实现**：
  - [ei1333's library - Divide and Conquer Optimization](https://ei1333.github.io/library/dp/divide-and-conquer-optimization.hpp)

### 例题

这些题目都可以直接使用分治优化DP模板，唯一的区别在于**区间代价函数 $w(i, j)$ 不同**。

- [Shopee-004 Divider](https://leetcode.cn/problems/VdG6tT/description/)
- [CF321E Ciel and Gondolas](https://codeforces.com/contest/321/problem/E)
- [CF833B The Bakery](https://codeforces.com/contest/833/problem/B)
- [CF868F Yet Another Minimization Problem](https://codeforces.com/contest/868/problem/F)
- [P5574 任务分配问题](https://www.luogu.com.cn/problem/P5574)
- [P4767 [IOI2000] 邮局](https://www.luogu.com.cn/problem/P4767)
- [LC 1478 安排邮筒](https://leetcode.cn/problems/allocate-mailboxes/)
- [Squared Ends](https://csacademy.com/contest/round-70/task/squared-ends/)
