# FST

## 一、FST 是什么？

### 1. 定义与背景

- **有限状态自动机（Finite State Automaton, FSA）**：最常见的是识别器（acceptor），接受或拒绝某个输入字符串，常用于模式匹配、词法分析、正则表达式实现等场景。

- **有限状态转换器（Finite State Transducer, FST）**：在有限状态自动机的基础上进行了扩展，不仅对输入字符串进行状态转移、判断是否接受，而且在转移过程中可以“输出”另一串符号序列。因此，FST 具有“映射”或“转换”的特性，可以把输入映射为输出。例如：
  - 将一个英文单词的“词干”映射到其复数形式或过去式形式；
  - 将拼音输入映射到汉字输出；
  - 将语音识别中的声学特征序列映射到文字序列（在加权 FST 中使用更加广泛）。

简而言之，**FST = 有限状态自动机 + 输出功能**，可以理解为一个“有穷状态的黑盒”，它读取输入序列，并根据状态转移规则输出相应的符号。

### 2. FST 的两种常见模型：Mealy 和 Moore

- **Mealy 机（Mealy Machine）**：输出发生在状态转移的边（transition）上，取决于当前状态和输入符号。
- **Moore 机（Moore Machine）**：输出发生在状态（state）本身上，取决于当前状态，而与输入无关。

在自然语言处理等领域，更常见的是“Mealy 型”的 FST，因为输出往往与转移时的输入有直接关系，如同一个“边标注”（edge label）上同时含有输入符号和输出符号。

### 3. 加权 FST（Weighted FST）

在很多实际应用（如语音识别、机器翻译）中，除了简单的符号映射外，我们还需要对转换赋予概率或权重（weight）。这时候就会使用 **Weighted FST**，它在每条边除了输入和输出符号之外，还有一个权重（可能是概率或代价）。当我们在图上进行转移、生成输出时，可以通过乘法或加法等方式累积权重，从而得到最优匹配或最优转换路径。

---

## 二、为什么需要 FST？

### 1. 处理字符串映射与转换的需求

在计算机科学和语言学中，有许多字符串到字符串的映射需求，例如：

- **形态分析**：给定一个词形（如 “cats”），推断它的词干是 “cat”，以及相应语法信息（复数形式）。或反向将词干 “cat” 转成 “cats”。
- **音形转换**：在语音识别中，把声学符号（音素序列）映射为文字序列；或在拼音输入法中，把拼音序列映射为汉字序列。
- **分词或词典查找**：把输入单词映射到某个词典中的单词表，或者生成多个可能匹配并带有相应的权重。

FST 能够在有限状态图中完成这些映射与转换，既保持了类似正则表达式或有限自动机的高效性，又具备输出功能或权重功能。

### 2. 层次化与可组合性

FST 的另一个重要优势在于它的**可组合**特性。多个 FST 可以顺序或并行地组合，以表示更加复杂的转换过程：

- 语音识别系统中，经常把声学模型（音素/发音）、语言模型（词序列概率）、词典转换模型（音素到字母或音素到单词）等多个 FST 组合成一个大的加权 FST，这样就能在一个统一结构里完成整体的识别过程。
- 在自然语言处理的形态分析中，可以把前缀变化、词干变化和后缀变化分别用 FST 表示，然后通过 FST 的组合操作（如笛卡尔积、交、组合）实现对单词各部分的自动分析和生成。

### 3. 高效算法与良好性质

- **确定性 / 最小化**：对于不带权重的 FST，可以进行类似确定化（determinization）和最小化（minimization）等操作，使之在处理相同映射时更加高效，类似于对有限自动机做最小化。
- **加权场景**：加权 FST 支持众多运算，如最短路径、词图合并、交、投影（将输入或输出投影回单串）等，使得基于 FST 的系统在大规模数据上也能保持可观的效率。

---

## 三、怎么办（如何使用与实现 FST）？

下面从建模、构建、运算和应用几个方面，介绍在实际中使用 FST 的思路。

### 1. 建模与表示

1）**状态与转换边**

- 一个 FST 可以用图结构表示：
  - \( Q \) 为状态集合；
  - \( \Sigma \) 为输入符号集，\( \Gamma \) 为输出符号集；
  - \( \delta \subseteq Q \times (\Sigma \cup \{\epsilon\}) \times (\Gamma \cup \{\epsilon\}) \times Q \) 为带有输入、输出和目标状态的转移动作，\(\epsilon\) 表示空符号。
  - 可能还包含初始状态和终止状态集合，以及加权场景下的权重函数。

2）**数据结构**

- 在编程实践中，FST 往往被表示为图或邻接表的形式，每条边包含：
  - `start_state`
  - `end_state`
  - `input_symbol`
  - `output_symbol`
  - （可选）`weight`
- 这使得我们能像在有向图上进行搜索一样，进行各种操作。

3）**符号表**

- 通常会用离散的整数 ID 来表示输入/输出符号，配合一个符号表（Symbol Table）做映射（如 “cat” -> 123， “s” -> 45），以方便在运算时进行快速比较与查找。

### 2. 构建或学习 FST

1）**手动构建**

- 对于较小或规则性强的转换（如简单的形态变化、正则匹配），可以手动编写对应的 FST 规则或使用某些语言工具（如 OpenFst、foma、XFST）把正则语法编译为 FST。
- 例如，形态规则 “cat + s -> cats” 可以表示为若干状态与边，并在读到 “s” 的时候输出 “s”。

2）**自动学习 / 训练**

- 在机器学习（尤其是统计语言学、语音识别等）中，通常会使用加权 FST。我们可以通过数据（如大规模的语料库）来估计转换概率或权重，训练出一个加权 FST。
- 典型例子：从对齐（alignment）数据中学习词间转换概率，把它映射成 FST 的边权重；或在拼音-汉字转换中，根据大规模语料学习拼音到汉字的发射概率和汉字到汉字的转移概率等。

### 3. 核心算法与操作

1）**基本运算**

- **投影**（Projection）：只保留输入或输出符号，得到一个纯粹的有限自动机（FSA）。
- **交（Intersection）**：对于两个 FST \( T_1, T_2 \)，将其中可能的路径进行组合（在 Weighted FST 中需要考虑权重的合并）。
- **连接（Concat）**：顺序连接两个 FST，代表先执行 \( T_1 \) 再执行 \( T_2 \)。
- **确定化（Determinization）** / **最小化（Minimization）**：与 FSA 类似，但需要注意加权场景下算法的适用性。

2）**搜索与路径算法**

- **最短路径**：在加权 FST 中，找到从初始状态到终止状态的最小（或最大）权重路径。常用的算法有 Dijkstra、A\* 等。
- **Viterbi 路径**：在概率语境中，对应“最大似然”路径。
- **令牌传递（Token Passing）**：一种逐帧/逐符号动态规划算法，在语音识别等实时应用中非常常见。

3）**综合实用功能**

- 在自然语言处理中，可以通过 FST 完成词形还原、单词拼写校正、分词、词与词干映射等；
- 在语音识别中，FST 能够对语音输入的多种可能性进行记录，然后通过最短路径找到最优识别结果。

### 4. 常用工具与库

- **OpenFst**：最著名的开源库，用于构建、组合和优化加权 FST。Google、Mozilla 等在语音和 NLP 工程中都常用它。
- **foma** / **XFST**：专为自然语言形态分析而设计的工具，可以把词法规则编译为 FST。
- **Kaldi**：语音识别工具中广泛使用了加权 FST 来表征声学模型、词典和语言模型的组合。

---

## 四、常见应用与案例

1. **自然语言处理**

   - **形态分析 / 生成**：如处理英语动词的时态、数的变化，俄语、芬兰语等高度黏着语的词形变化。
   - **分词与拼写校正**：可以把合法的拼写变化或常见拼写错误转换成标准单词。
   - **编译器词法分析**：正则表达式可以编译为确定的有限自动机，也能携带输出动作（如标记词法类别），形成一个简单的 FST。

2. **语音识别**

   - **HCLG 图**：在 Kaldi 等系统中，会将声学模型（H）、音素与词典转换（C、L），以及语言模型（G）组合成一个大的加权 FST（HCLG），解码时在这个大图上进行搜索。
   - **后处理 / 拼写纠正**：在语音识别后常需要用 FST 校正或转换一些特殊输入。

3. **机器翻译**

   - 如果把源语言与目标语言的对齐关系抽象成一个加权 FST，就可以对句子的翻译选择进行图搜索，寻找最优翻译。
   - 实际中或许用神经网络模型更多，但 FST 在传统统计机器翻译阶段依然很重要，比如音译、字词级别转换等。

4. **OCR 与图像文本识别**
   - 把识别出来的字符置信度表示为权重，组成加权 FST，然后与语言模型 FST 组合，得到最优的文字输出。

---

## 五、总结

1. **是什么**

   - FST 是在有限状态自动机的基础上，增加“输出”功能的自动机模型，能将输入序列转换为输出序列，或在加权场景下给出多种可能性并赋予权重。

2. **为什么**

   - 在语言学、语音识别、OCR、形态分析等大量场景中，需要从某种输入符号序列映射到另一种输出符号序列，而 FST 提供了高效且可组合的图模型。
   - FST 的确定化、最短路径等算法让它在大规模应用下依然可行，也易于与其他模型组合。

3. **怎么办**
   - **建模**：确定状态集合、输入输出符号集，设计（或学习）转移边和相应权重。
   - **构建**：可手动编写小型规则，也可通过大规模数据进行概率或权重学习。
   - **操作与算法**：熟悉投影、交、确定化、最短路径等核心算法，以及在加权场景中的变体和实现。
   - **应用与工具**：OpenFst、Kaldi、foma、XFST 等开源工具可用于工业级或研究级开发；在形态分析、语音识别、NLP 等领域有广泛应用。
