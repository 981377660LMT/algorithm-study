Quantile Sketches 是一种用于高效计算数据流近似分位数（Quantile）的数据结构，特别适用于大数据场景。以下是对其核心原理、算法及应用的详细讲解：

---

### 一、分位数与计算挑战

**分位数**（Quantile）是将数据集按大小顺序划分为多个区间的统计量，如中位数（50%分位数）。  
**核心挑战**：

- 大数据场景下存储所有数据不可行（内存限制）
- 数据流（Streaming Data）需单次遍历计算
- 需要平衡计算精度与资源消耗

---

### 二、Quantile Sketches 核心原理

通过压缩数据特征，构建可动态更新的数据结构，实现**ε-近似分位数**（误差不超过 εN，N 为数据总量）。

#### 关键特性：

1. **可合并性**（Mergeability）  
   多个 Sketch 可合并为全局 Sketch
2. **单次遍历**  
   无需存储原始数据
3. **误差有界**  
   精度通过参数 ε 控制

---

### 三、主流算法分类

#### 1. **GK Algorithm** (Greenwald-Khanna, 2001)

- **数据结构**：维护有序元组 (v, g, Δ)
  - v: 数据值
  - g: 到前一个值的跨度下限
  - Δ: 跨度上限与 g 的差值
- **压缩策略**：定期删除冗余元组
- **复杂度**：O(1/ε log εN) 空间
- **特点**：首个理论保证的流式算法

#### 2. **KLL Sketch** (2015)

- **改进点**：分层采样 + 确定性合并
- **数据结构**：多层级结构，高层级存储更稀疏样本
- **压缩**：通过权重合并相邻桶
- **复杂度**：O(1/ε log log 1/ε) 空间
- **优势**：比 GK 更优的空间效率

#### 3. **T-Digest** (2013)

- **核心思想**：自适应聚类
  - 数据密集区域使用小簇
  - 稀疏区域使用大簇
- **合并策略**：基于簇质心的插值
- **特点**：对非均匀分布数据更友好

---

### 四、算法对比

| 特性           | GK Algorithm  | KLL Sketch         | T-Digest       |
| -------------- | ------------- | ------------------ | -------------- |
| **空间复杂度** | O(1/ε log εN) | O(1/ε log log 1/ε) | O(1/ε)         |
| **合并效率**   | 低            | 高                 | 中等           |
| **数据分布**   | 均匀分布      | 均匀分布           | 非均匀分布更优 |
| **实现难度**   | 高            | 中等               | 低             |

---

### 五、应用场景

1. **数据库系统**
   - Apache Spark 的`approxQuantile`函数
   - Druid 实时 OLAP 查询
2. **监控系统**
   - Prometheus 中指标分位数计算
3. **机器学习**
   - 特征分桶（Feature Bucketization）
4. **网络流量分析**
   - 延迟分布统计

---

### 六、实现选择建议

1. **数据规模**
   - 超大数据流首选 KLL 或 T-Digest
2. **精度要求**
   - 高精度需求优先 KLL
3. **数据分布**
   - 长尾分布选择 T-Digest
4. **动态更新频率**
   - 高频更新场景推荐 GK 算法

---

### 七、代码示例（T-Digest in Python）

```python
from tdigest import TDigest
import numpy as np

# 初始化
td = TDigest()

# 添加数据
data = np.random.normal(0, 1, 100000)
td.batch_update(data)

# 查询分位数
print(td.percentile(95))  # 输出95%分位数
```

---

通过量化误差与资源消耗的权衡，Quantile Sketches 已成为现代大数据系统的核心组件。算法选择需结合实际场景需求，在精度、内存和计算成本之间找到最佳平衡点。
