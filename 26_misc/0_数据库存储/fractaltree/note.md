https://bohutang.me/2020/06/20/clickhouse-and-friends-merge-tree-algo/
目前最先进的索引算法

# 分形树 FractalTree

B树在查找方面表现良好，但在插入方面表现不佳。
LSM树在插入方面表现良好，但在查找方面表现不佳。
是否存在一种数据结构，其查找性能与B树相当，但插入性能更接近LSM树或仅追加文件？
答案是`分形树`

在 MySQL / MariaDB 生态中，**TokuDB**（由 Tokutek 公司开发，后被 Percona 收购）是一个主打**高写入性能**和**节省存储空间**的存储引擎。它与传统 B+ Tree 不同，使用的是一种名为 **Fractal Tree**（分形树索引）的数据结构，实现对大规模、高并发写入场景的良好支持。以下将结合 TokuDB，概述其内部所用的分形树（Fractal Tree）原理、特性与优势。

---

## 1. 传统 B+ Tree 的挑战

在关系型数据库（如 MySQL）中，**B+ Tree** 或其变体是最常见的索引结构（InnoDB、MyISAM 都是基于 B+ Tree）。它对于绝大多数 OLTP 读写场景都能很好地工作，但面对以下情况时，往往会遇到瓶颈：

1. **写入放大（Write Amplification）**

   - 当频繁插入或更新数据时，传统 B+ Tree 需要不断在磁盘上做随机 I/O、节点分裂或重排操作，I/O 成本较高且会导致写放大。

2. **大规模、高并发写入**

   - 例如实时数据采集、日志写入、IOT 设备上报，往往需要处理海量“小写操作”，B+ Tree 在频繁插入及索引维护时可能出现性能下降。

3. **对 SSD / HDD 的写寿命影响**
   - 大量的随机写操作也会加速 SSD 磨损、增加磁盘负载。

为缓解这些问题，人们引入了 **LSM-Tree（Log-Structured Merge Tree）**、**Fractal Tree** 等新型数据结构。其中，TokuDB 选择了 Fractal Tree 作为其核心索引结构。

---

## 2. 什么是 Fractal Tree（分形树索引）

### 2.1 数据结构核心概念

**Fractal Tree** 乍一看也像一棵“多叉树”，但它在树节点处设置了**缓冲区（Buffer）**，以支持批量更新和批量合并。可以将它简单理解为：

1. **每个非叶子节点都带有一个可存储更新消息的缓冲区**。
2. 当有新插入（Insert）、更新（Update）或删除（Delete）操作时，这些操作会被“先写入更靠近根节点的缓冲区”，而非立刻随机写入叶子节点。
3. 只有当缓冲区达到一定阈值或者触发条件时，才会进行“分批下推（Push Down）”，把这些更新操作一次性合并到更下层的节点或叶子节点里去。
4. 这样的**“缓冲 + 批量处理”**策略可以把大量频繁的小写操作转化为更少的大块顺序写。

### 2.2 “分形”的由来

之所以被称为“分形树”，一方面是因为它在多级节点上递归地设置缓冲区并执行类似的操作；另一方面也暗示其在节点分裂、合并等过程中，具备一定“自相似性”。不过，这里的分形树更多是一种**工程化命名**，重点不在几何学意义上的分形图案，而在**树形结构的“自相似”与递归缓冲**思想上。

---

## 3. Fractal Tree 在 TokuDB 中的优势

1. **高写入吞吐**

   - 通过在各层节点设置缓冲区，把频繁的随机写聚合成顺序写或批量写，极大降低 I/O 消耗。TokuDB 因此在写入密集场景中往往表现出比 InnoDB 更高的写吞吐。

2. **减少写放大**

   - 由于“先缓冲，再批量写入”可以减少磁盘上的反复更新与节点拆分（split），从而减少写放大，降低对磁盘的磨损。

3. **节省存储空间**

   - TokuDB 通常配合高效的压缩算法使用，加之 Fractal Tree 的批量处理特点，存储空间使用率往往也更优。

4. **适合大数据量与实时分析场景**

   - 当表数据量非常巨大，且需要不断进行增量更新或插入时，Fractal Tree 的结构有助于保持索引维护和查询效率。

5. **可并行化的合并与重组**
   - TokuDB 在后台维护分形树索引的过程中，可以“边用边整理”，在大多数情况下避免了像传统 B+ Tree 在重组或优化时需要较长时间锁表或大规模写操作的情况。

---

## 4. Fractal Tree 与 LSM-Tree 的比较

在数据库领域，除 Fractal Tree 外，另一类常见的高写入索引结构是 **LSM-Tree**（Log-Structured Merge Tree）。HBase、Cassandra、RocksDB、LevelDB 等都基于 LSM-Tree 思想。两者都有“批量合并”、“面向写优化”的特点，也都能显著减少写放大。但它们的方式略有不同：

- **LSM-Tree** 侧重的是**多层数据文件**（SSTable）之间的 compaction（合并/压缩）；
- **Fractal Tree** 则侧重在**树的各层节点**保留缓冲并将操作下推。

本质上都是为了**延迟小写操作**，最终批量或顺序写磁盘，从而达到高写性能和节省 I/O 的目的。不过在实现细节上，Fractal Tree 更像是对 B+ Tree 的“缓冲式改造”，而 LSM-Tree 则更像是一套“基于日志文件合并”的思路。

---

## 5. TokuDB 使用与现状

1. **安装与使用**

   - 早期需要单独安装 TokuDB 插件或使用包含 TokuDB 的 Percona Server / MariaDB 版本。
   - 使用时在创建表时指定 `ENGINE=TokuDB`，即可使用 TokuDB 的 Fractal Tree 索引。

2. **适用场景**

   - 写入密集型工作负载，如日志系统、实时分析、时间序列数据、大量传感器数据汇集等。
   - 数据量极大且需要保持良好查询性能的场景。
   - 需要更少存储和较高压缩比的场景。

3. **与 InnoDB 并存**

   - 传统 OLTP 读多写少场景下，InnoDB 通常已经足够优秀；但如果对写性能有极高需求，或单表规模动辄数亿甚至更高时，TokuDB 往往能提供很大帮助。
   - 需要权衡：TokuDB 对点查询或短事务性能不一定总是优于 InnoDB，实际效果还得看应用的查询模式、数据分布及负载特性。

4. **后续发展**
   - Tokutek 公司最初开发了 TokuDB，后来被 Percona 收购后，TokuDB 变成 Percona Server for MySQL 的一个可选存储引擎。MariaDB 也一度支持 TokuDB 插件。
   - 随着时间推移，一些新的数据库或存储引擎（RocksDB、MyRocks 等）也都针对写优化场景做了深入探索，彼此之间在功能和性能上都有竞争和优劣之分。

---

## 6. 小结

- **TokuDB** 使用 **Fractal Tree**（分形树索引）替代传统 B+ Tree，用“缓冲 + 批量处理”的机制实现了对大量、小型写操作的高效支持。
- 其优点包括：**高写入性能**、**减少写放大**、**存储空间压缩**、适合大规模数据实时插入与查询的混合场景。
- 虽然 Fractal Tree 在名字上带有“分形”二字，但更多强调的是在树节点中“自相似、分层缓冲”的机制，与几何学的分形图形并不完全相同。
- 由于 TokuDB 仍是关系型数据库生态的一部分，兼容 MySQL / MariaDB 协议，因此在“需要写优化 + 保持 SQL 功能”的应用里是一种可选方案。
- 在实际部署前，需要根据读写比例、磁盘 I/O、硬件配置等因素进行测试和权衡，来决定是否启用 TokuDB 及其分形树索引结构。

简而言之，**分形树（Fractal Tree）在 TokuDB 中扮演了“新一代索引结构”的角色，通过在内部节点设置缓冲区并批量下推写操作，显著提升了高并发写入场景的效率**。这也让 TokuDB 成为了当时 MySQL 生态中主打写优化、压缩性能的一种独特选择。
