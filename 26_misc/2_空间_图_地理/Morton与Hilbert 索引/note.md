# **Z-Order (Morton Order) / Hilbert Curve 索引**

- **要点**：将多维坐标映射到一维，使得“空间上相邻”尽可能在一维上也相邻，便于在 B+Tree/LSM 等有序结构上实现近似的“多维范围查询”。
- **使用场景**：时空数据库 (Time+Geo)、OLAP 场景(多维分析)、列式存储优化 (Snowflake, ClickHouse 中都可见类似思路)。
- **Z-Order(Morton code)**：通过交叉位拼接 (interleaving bits) 实现快速映射。
- **Hilbert 曲线**：空间局部性更好，但计算编码/解码更复杂。

## 一、Z-Order（Morton Order）

### 1. 是什么

- **Z-Order**（又称 **Morton Order**）是一种将多维数据映射到一维的空间填充曲线（Space-filling curve）算法。
- 它的核心思想是：对多维坐标（例如二维的 x、y 坐标，或者三维 x、y、z）进行“位交织（bit interleaving）”，从而把多维点“混合”成一个一维整数键，进而可以以一维的方式进行排序或存储。

以二维 (x, y) 为例：

- 假设 x 和 y 都是 8 位整数（共 8 bits），x = \(x_7 x_6 \dots x_0\)，y = \(y_7 y_6 \dots y_0\)。
- Z-Order 会把它们交错排列，如：  
  \[
  \text{Z}(x, y) = y_7 x_7 y_6 x_6 \dots y_0 x_0
  \]
- 这样就得到一个 16 位的 Morton 码（Morton code）。对于三维则是把 x、y、z 三个坐标的位按顺序交织到一个长整数中。

因为在二维情况下，Z-Order 索引所表现的“形状”像 “Z” 字或“锯齿”在 2D 空间往返穿行，因此称为 Z-Order。

### 2. 为什么需要它

1. **多维数据的一维索引**

   - 在数据库或存储系统中，如果要按二维/三维空间进行范围查询或近邻查询，直接使用多列索引往往不能很好地保留邻近性（尤其在高维时）。
   - Z-Order 通过空间填充曲线将多维映射到单一维度，使得在一维排序中，空间相近的点往往有较高概率依然靠近，可以减少访问不必要的数据块、提高查询效率。

2. **易于实现，性能可观**

   - Z-Order 的位交织计算比较简单，可以用移位和位运算在常数时间内完成。
   - 它在很多应用（如地理位置索引、图像处理、数据库分区）中能达到较好的空间局部性。

3. **常见场景**
   - **地理信息系统（GIS）**：将 (latitude, longitude) 映射到 Morton code 后排序或分桶。
   - **图像/视频编码**：在对图像块进行编排时，经常用 Morton Order 来提升缓存效率，因为二维像素邻近在一维地址上也相对集中。

### 3. 怎么办（如何使用、实现）

1. **位交织**

   - 对 (x, y) 而言，可以在代码中循环地把 x、y 各位提取出来，按交错顺序合并进一个整型变量；对于 (x, y, z) 也一样按三路交织。
   - 一些语言库或算法库有现成的 Morton encode/decode 函数，或通过查表加速。

2. **索引构建**

   - 将每个数据点 (x, y) 计算出 Morton code，并在数据库 / 存储系统中按这个一维值排序或构建 B-Tree、LSM-Tree、Skiplist 等索引结构。
   - 要执行某个空间范围查询（例如 x \(\in [x_1, x_2]\), y \(\in [y_1, y_2]\)），可以映射成若干区间的 Morton code，然后在一维索引里遍历这些区间，找到满足条件的候选点，再做精确过滤。

3. **局限性**
   - Z-Order 在维度较多时的空间局部性会变差。高维度下，最优的空间填充曲线也无法避免“维度诅咒”问题，但 Z-Order 依然常被选用因为它简单、计算便捷。
   - 在某些特定情况下，Z-Order 的局部性不如 Hilbert Curve，但 Hilbert Curve 计算更复杂。

---

## 二、Hilbert Curve

### 1. 是什么

- **Hilbert Curve**（希尔伯特曲线）也是一种经典的空间填充曲线，由数学家 David Hilbert 在 1891 年提出。
- 与 Morton Order 相比，Hilbert Curve 在映射过程中更能保留局部相邻的点，也就是**更好的空间局部性**（相邻点映射到一维上也更可能邻近）。
- Hilbert Curve 也是递归式定义，通常在 2D 平面“走”出一条连续曲线，随着迭代次数增大，可以覆盖更细分的网格。

### 2. 为什么需要它

1. **更好的局部性**

   - Hilbert Curve 在二维上将相邻单元格排布得比较紧密，一维映射顺序更好地保留二维邻近关系，使得范围查询访问的块数更少。
   - 一些实验表明，在同样的空间填充曲线中，Hilbert Curve 通常比 Z-Order 有更高的空间聚集度。

2. **常见应用**

   - **数据库、数据仓库**：在多维 OLAP 或地理坐标场景中，索引若使用 Hilbert Curve，可以减少 I/O 并带来更好的缓存命中率。
   - **图像处理**：像素储存顺序若采用 Hilbert Curve，可提高局部性，在图像缩放或多分辨率处理时带来性能优势。

3. **局限性**
   - Hilbert Curve 的计算和逆计算（从 (x, y) 得到曲线距离或从曲线距离得到 (x, y)）都比 Morton 码复杂许多，一般需要递归或更精细的位操作。
   - 在更高维度（3D、4D ...）的 Hilbert Curve 也可以定义，但实现难度更高，性能开销更大。
   - 依然无法完全消除“维度诅咒”，在极高维时效果减弱。

### 3. 怎么办（如何使用、实现）

1. **分割网格 & 递归**

   - 在 2D 里，将坐标平面划分为 2^k x 2^k 网格，Hilbert Curve 会以4个子块的递归顺序定义，每一级对 2^(k-1) x 2^(k-1) 的块再进一步递归。
   - 实际实现可使用递归或迭代的算法，对 (x, y) 做分块判断后合成 Hilbert 距离；或对给定的 Hilbert 距离反向解析 (x, y)。

2. **构建索引**

   - 类似 Z-Order：对每个点计算其 Hilbert distance，然后在一维数据库索引中进行排序或存储。
   - 范围查询同理，可以把查询空间投影到 Hilbert Curve 上，找到若干区段进行扫描，最后做精确过滤。

3. **算法库**
   - 有很多第三方库实现了 2D 或 3D 的 Hilbert Curve 编码/解码，可在数据库系统、GIS 工具中直接调用。

---

## 三、对比与应用

### 1. Z-Order vs. Hilbert Curve

1. **计算复杂度**
   - Z-Order (Morton code) 计算非常简单，只要做位交织即可；Hilbert Curve 需要更复杂的过程。
2. **空间局部性**
   - Hilbert Curve 一般比 Z-Order 更好地保留二维相邻关系。若应用对局部性有较高要求（如小范围查询）、数据分布均匀，Hilbert Curve 常表现更优。
3. **实用性**
   - Z-Order 常在实际系统中更受欢迎，原因在于其实现容易，性能足够好，适用维度多样；Hilbert Curve 在对局部性要求更高或数据查询热区比较集中的场景才会去实现（因其维护成本更高）。

### 2. 多维扩展

- **Z-Order**：扩展到 3D、4D 也比较容易，只要进行多向位交织。
- **Hilbert Curve**：可以推广到 3D，但实现愈加复杂，需要更复杂的递归或算法设计。对更高维度就更困难，也更少使用。

### 3. 在数据库 / 存储系统中的用法

1. **索引**
   - 把多列 (x, y) 或 (latitude, longitude) 映射成一个 Morton code / Hilbert distance，构建 B-Tree、LSM-Tree 或者其它一维索引；
   - 范围查询时，转成若干一维区间做扫描，再过滤结果。
2. **分桶 / 分区**
   - 大型数据湖或分布式存储可以用 Z-Order / Hilbert Curve 对数据分桶，让空间接近的记录落到相同或相邻存储分区中，减少跨分区查询开销。
   - Databricks 的 Delta Lake 就支持 **Z-Ordering** 以减少数据 Shuffle 和扫描量。
3. **缓存 / 页布局**
   - 像素数据、矩阵存储也会利用 Morton Order / Hilbert Order 来让二维邻近单元在内存地址上更接近，提升缓存命中。

---

## 四、总结

1. **是什么**

   - **Z-Order（Morton Order）** 和 **Hilbert Curve** 都是空间填充曲线，将多维空间坐标映射到一维整数，提供一定的空间邻近性。
   - Z-Order 基于简单的位交织，Hilbert Curve 基于更复杂的递归映射，局部性更好。

2. **为什么**

   - 多维索引或数据布局需要把 (x, y, …) 转成可排序的一维值，既要简单可算，又要尽量保留邻近性，用于范围查询、近邻查询、分桶等操作时可减少随机访问。
   - Z-Order 实现简单，性能良好；Hilbert Curve 有更高的局部性，但计算更复杂。

3. **怎么办**
   - **Z-Order**：进行位交织编码，把每个点映射为 Morton code，构建一维索引；
   - **Hilbert Curve**：通过递归或查表算法把 (x, y) -> Hilbert distance，再进行一维索引或排序；
   - 在数据库或存储系统中，依据应用需求选择是用 Morton 码（常见、简单）还是 Hilbert（更佳局部性），并在查询时将多维范围拆分为若干曲线区段进行扫描。
