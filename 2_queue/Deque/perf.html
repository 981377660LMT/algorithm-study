<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <title>Deque Rebalance Benchmark</title>
  </head>
  <body>
    <h1>Deque Rebalance åŸºå‡†æµ‹è¯•</h1>
    <p>è¯·æ‰“å¼€å¼€å‘è€…æ§åˆ¶å° (F12) æŸ¥çœ‹æµ‹è¯•ç»“æœã€‚</p>
    <script>
      console.log('--- Deque Rebalance æ€§èƒ½åŸºå‡†æµ‹è¯• ---')

      // --- è¦æµ‹è¯•çš„ä¸¤ä¸ªå‡½æ•°ç‰ˆæœ¬ ---

      /**
       * ç‰ˆæœ¬ A: åŸå§‹å®ç° (slice + reverse + splice)
       * @param {T[]} stack2
       * @returns {{stack1: T[], stack2: T[]}}
       * @template T
       */
      function rebalance_V1(sourceStack) {
        let stack1 = []
        // æ¯æ¬¡æµ‹è¯•éƒ½ä»åŸå§‹æ•°æ®å¤åˆ¶ï¼Œé¿å…äº’ç›¸å½±å“
        let stack2 = [...sourceStack]
        const m = stack2.length
        if (!m) return { stack1, stack2 }
        const k = (m + 1) >>> 1
        stack1 = stack2.splice(0, k).reverse()
        // splice ä¼šä¿®æ”¹åŸæ•°ç»„ï¼Œæ˜¯æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆ

        return { stack1, stack2 }
      }

      /**
       * ç‰ˆæœ¬ B: ä¼˜åŒ–å®ç° (æ‰‹åŠ¨å¾ªç¯ + slice)
       * @param {T[]} stack2
       * @returns {{stack1: T[], stack2: T[]}}
       * @template T
       */
      function rebalance_V2(sourceStack) {
        let stack1 = []
        let stack2 = [...sourceStack]
        const m = stack2.length
        if (!m) return { stack1, stack2 }
        const k = (m + 1) >>> 1
        // æ‰‹åŠ¨å¾ªç¯å®ç°é€†åºï¼Œé¿å…è°ƒç”¨ reverse
        const newStack1 = Array(k)
        for (let i = 0; i < k; i++) {
          newStack1[i] = stack2[k - 1 - i]
        }
        stack1 = newStack1
        // slice åˆ›å»ºæ–°æ•°ç»„ï¼Œé€šå¸¸æ¯”ä¿®æ”¹å¤´éƒ¨(splice)å¿«
        stack2.splice(0, k)
        return { stack1, stack2 }
      }

      // --- åŸºå‡†æµ‹è¯•æ‰§è¡Œ ---

      function runBenchmark(name, func, sourceArray, iterations) {
        console.log(`\næ­£åœ¨è¿è¡Œæµ‹è¯•: ${name}...`)
        const startTime = performance.now()
        for (let i = 0; i < iterations; i++) {
          // ä¼ å…¥ sourceArrayï¼Œå‡½æ•°å†…éƒ¨ä¼šå¤åˆ¶
          func(sourceArray)
        }
        const endTime = performance.now()
        const duration = endTime - startTime
        console.log(`âœ… ${name} å®Œæˆ! æ€»è€—æ—¶: ${duration.toFixed(2)} ms`)
        return duration
      }

      // --- æµ‹è¯•å‚æ•° ---
      const ARRAY_SIZE = 2e5 // rebalance æ“ä½œçš„æ•°ç»„å¤§å°
      const ITERATIONS = 500 // é‡å¤æ‰§è¡Œæ¬¡æ•°

      console.log(`æµ‹è¯•å‚æ•°: æ•°ç»„å¤§å° = ${ARRAY_SIZE}, è¿­ä»£æ¬¡æ•° = ${ITERATIONS}`)

      // åˆ›å»ºä¸€ä¸ªå¤§çš„æºæ•°ç»„
      const sourceArray = Array.from({ length: ARRAY_SIZE }, (_, i) => i)

      // ä¸ºäº†è®© JIT é¢„çƒ­ï¼Œå…ˆå„è·‘ä¸€æ¬¡
      rebalance_V1(sourceArray)
      rebalance_V2(sourceArray)

      // æ­£å¼å¼€å§‹æµ‹è¯•
      const timeV1 = runBenchmark(
        'ç‰ˆæœ¬ A (slice + reverse + splice)',
        rebalance_V1,
        sourceArray,
        ITERATIONS
      )
      const timeV2 = runBenchmark(
        'ç‰ˆæœ¬ B (æ‰‹åŠ¨å¾ªç¯ + slice)',
        rebalance_V2,
        sourceArray,
        ITERATIONS
      )

      // --- ç»“æœæ€»ç»“ ---
      console.log('\n--- ç»“æœæ€»ç»“ ---')
      if (timeV1 < timeV2) {
        const diff = (((timeV2 - timeV1) / timeV2) * 100).toFixed(2)
        console.log(`ğŸ† ç‰ˆæœ¬ A (åŸå§‹å®ç°) æ›´å¿«ï¼Œé¢†å…ˆ ${diff}%`)
      } else {
        const diff = (((timeV1 - timeV2) / timeV1) * 100).toFixed(2)
        console.log(`ğŸ† ç‰ˆæœ¬ B (ä¼˜åŒ–å®ç°) æ›´å¿«ï¼Œé¢†å…ˆ ${diff}%`)
      }
      console.log(`ç‰ˆæœ¬ A æ€»è€—æ—¶: ${timeV1.toFixed(2)} ms`)
      console.log(`ç‰ˆæœ¬ B æ€»è€—æ—¶: ${timeV2.toFixed(2)} ms`)
    </script>
  </body>
</html>
