# Bitmap 索引

在传统的 B+ 树索引之外，还有一种针对**低基数（low cardinality）列**非常高效的索引形式，叫做 **Bitmap 索引**（位图索引）。它最常见于数据仓库或分析型场景（OLAP），在 Oracle、PostgreSQL 等数据库中都有支持。

## 1. 什么是 Bitmap 索引？

**Bitmap 索引**的核心思想是用**位图（bit array）来表示某列每个取值对应的数据行**。设想一个表中某列可能取值并不多（列的基数低），例如性别（只有“男”、“女”两种），或者某些状态字段（只有“0”、“1”、“2”三个取值），就很适合使用位图索引。

### 举个简单例子

假设有一张表 `users`，其中有一列 `gender`，取值只有 `"M"` 和 `"F"` 两种。对应一个位图索引，可能结构是这样的（示意）：

- **位图 M**：标记行是否性别为 `"M"`
- **位图 F**：标记行是否性别为 `"F"`

每个位图可以用一串比特（bit array）来表示。例如：如果第 1 行是男，那就令位图 M 的第 1 个 bit = 1，否则为 0；以此类推。

这样，当我们需要做类似 `gender = 'M'` 的查询时，数据库只要**直接扫描“位图 M”**，就知道哪些行满足条件。

## 2. Bitmap 索引的结构与原理

### 2.1 每个不同的取值都对应一块“位图”

对于某个列可能的每个**不同取值**，Bitmap 索引会分配一段 bit array。

- Bit array 的长度与表的**行数**相同（或者可以按区段、压缩等方式存储）
- 第 i 个 bit 表示第 i 行是否等于这个取值：1 表示是，0 表示不是。

如果该列取值范围很小（比如状态码只有 0、1、2），那么就会有三块位图（bit array），每一块长与表中行数相对应。

### 2.2 位图运算

Bitmap 索引在执行**组合条件**查询时（例如 `gender = 'M' AND status = 2`），可以通过位图的**逻辑运算**（位与、位或等）直接得到结果行的集合。

- 比如 `gender = 'M'` 对应位图 M，`status = 2` 对应位图 status2，做 “M AND status2” 就是对 M 位图和 status2 位图做位与（bitwise AND）。

这种**基于位运算**的过滤在计算机底层是非常快的，而且能在一定程度上减少对表中数据块的访问。

## 3. 适用场景

### 3.1 低基数（low cardinality）列

Bitmap 索引最适合用于**列的取值不多**的情况，即**低基数**列，比如：

- 性别（`M/F`）
- 状态码（如 `0,1,2,3`）
- 布尔字段（`true/false`）
- 某些分类编码（可能只有几十个取值）

如果列的取值非常多，甚至接近行数，那么 Bitmap 索引的优点就会大打折扣，甚至还会带来额外开销。

### 3.2 读密集、批量查询多，更新很少

因为 Bitmap 索引在做**批量查询或分析**时，很容易通过位运算快速筛选出数据。但是它也有一个弱点：

- **更新成本较高**：如果某行的列值改动了，需要修改相应位图的数据（可能涉及压缩/解压缩）。因此在**频繁更新**或**高并发写入**场景下并不合适。

因此，Bitmap 索引常见于**数据仓库（OLAP）**、**分析型数据库**，而非经常需要大量写操作的 OLTP 系统。

## 4. 优点和缺点

### 4.1 优点

1. **查询效率高**：对低基数列进行过滤时，位运算非常快；组合过滤也能快速用位与、位或等运算。
2. **空间占用小**：对低基数列，位图本身可以进行压缩（例如 Oracle 用了 RLE 压缩），实际存储空间往往比想象中小。
3. **多条件组合的效率提升**：可以通过位图间的布尔运算做合并，大大减少回表读取的数据量。

### 4.2 缺点

1. **不适合频繁更新**：表中某一行的值变动，需要同步更新位图索引，对并发写会造成较大开销。
2. **对高基数列不友好**：如果字段取值很多，几乎每一行都不一样，则位图划分过多，索引空间也会剧增，性能也不佳。
3. **需要数据库自身支持**：并不是所有数据库都支持 Bitmap 索引，或者支持程度不一，比如 Oracle 中非常成熟，而 MySQL 里则是通过其它方式间接实现（InnoDB 并无原生位图索引），需要具体产品去看文档和实现细节。

## 5. 总结

- **Bitmap 索引**（位图索引）是数据库存储和检索的一种特殊索引结构，主要通过“为每个取值保留一个 bit array”来标记哪些行匹配某个值。
- 适用于**低基数、写操作少、查询多**的场景，尤其是在数据仓库、分析型环境中，可以极大提升组合过滤条件查询的性能。
- 不适合**频繁更新**、**高基数列**，在不同数据库中也会有针对性的实现和优化（如压缩算法、并行扫描、基于分区的位图索引等）。
