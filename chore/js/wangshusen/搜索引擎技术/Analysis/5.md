# 搜索引擎技术深度分析（五）：排序流水线与查询词推荐（Query Suggestion）

本阶段分析涵盖了第 19-23 章节，深入探讨了搜索排序的最终融合机制（LTR）以及如何通过查询词推荐（Query Suggestion）引导用户发现更多价值内容。

---

## 1. 深度排序流水线（Ranking Pipeline）

搜索链路通过多级漏斗实现从数亿文档到前 10 名的过滤。

### 1.1 三级排序架构

- **召回截断（Recall Truncation）**：数万 $\to$ 数千。使用简单的向量内积或线性模型，追求极致的速度。
- **粗排（Pre-ranking）**：数千 $\to$ 数百。使用双塔模型或轻量级 Cross-Encoder（如 4 层 BERT），通过后期融合降低算力开销。
- **精排（Final Ranking）**：数百 $\to$ 前 N。使用 12 层 Cross-Encoder 或复杂的深度神经网络（如 MMoE），全特征输入，追求最高的准确性。

### 1.2 融合模型（Learning to Rank, LTR）

- **目标函数**：并非单纯的 CTR，而是“综合满意度分数” $y$。
  $$y = s（教师模型打分） + \alpha \cdot Click + \beta \cdot Interaction$$
- **训练方法进化**：
  - **Pointwise**：回归目标值，简单稳定，适合项目初期。
  - **Pairwise (RankNet)**：优化正逆序比，使正样本排在负样本前面。
  - **Listwise (LambdaRank)**：核心是 **$\Delta$NDCG**。通过对梯度加权，优先保障高排名位置（Top-K）的准确性，是目前工业界解决排序问题的主流方案。

---

## 2. 查询词推荐系统（Query Suggestion, QS）

查询词推荐决定了用户“搜什么”，是搜索流量的重要增长极。

### 2.1 四大业务场景

1.  **搜索前（Pre-search）**：底纹词（底纹词）、猜你想搜、搜索热榜。核心目标是**激发搜索行为**。
2.  **搜索中（In-search）**：SUG（实时补全）。关键指标是**输入效率**（减少用户打字数）。
3.  **搜索后（Post-search）**：相关搜索。引导用户进入**深度消费**。
4.  **内容内（In-content）**：文档下方推荐。实现从**推荐到搜索**的引流（Search DAU 增长点）。

### 2.2 召回技术（QS Recall）

- **SUG 召回**：前缀匹配（如“上海” $\to$ “上海迪士尼”）、拼音匹配、分词包含匹配。
- **Q2Q（Query to Query）**：
  - **ItemCF**：基于共现关系（搜 A 的也搜 B）。
  - **Swing**：阿里提出的改进版，引入用户重合度权重，解决“刷单/小圈子”导致的误关联。
- **D2Q（Doc to Query）**：针对“文档内推词”。
  - **生成式**：Transformer/T5 模型根据文档内容自动生成 Query。
  - **ItemCF 版**：统计点击过文档 $d$ 后又搜了 Query $q$ 的用户群体。

---

## 3. 关键业务指标

- **有点比（Click-through Rate of Suggestions）**：推荐的词用户点不点。
- **转化率（Conversion）**：用户点了推荐词后，在落地页（SERP）是否有点赞、收藏等后续行为。
- **搜索渗透率（Search Penetration）**：Search DAU / App DAU。搜前推词和内容内推词是提升该指标的关键。

---

## 4. 核心洞察

1.  **LambdaRank 的本质**：它是对位置敏感的。在搜索结果中，第 1 名和第 2 名互换的代价远大于第 10 名和第 11 名互换的代价。LambdaRank 通过 $\Delta NDCG$ 完美捕捉了这一物理直觉。
2.  **SUG 的双重属性**：它既是工具（提效），也是推荐（分发）。在排序时需要平衡用户真实输入的补全（意图匹配）与系统想给用户推的热门/优质词（点击价值）。
3.  **闭环优化**：查询词推荐必须与搜索引擎后端打通。推一个后端无法承接（无结果或相关性差）的 Query 虽然 CTR 高，但会严重损害长期的搜索信用。

---

_下一阶段将进行：全景报告总结。_
