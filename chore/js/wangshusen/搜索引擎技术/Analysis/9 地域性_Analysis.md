# 9 地域性：本地搜索的意图识别、POI 融合与距离/收益混排

地域性（Locality / Geo Intent）解决的是“用户想找离我近的东西吗？”

它的工程难点不在于“算距离”，而在于：

- 如何判断 query 是否有本地意图（显式/隐式、强/弱）
- POI（Point of Interest）数据如何融合（多源、同名、歧义）
- 如何在“本地结果”和“泛内容结果”之间做召回配额与混排

本章提供了一套非常可落地的“本地搜索系统骨架”。

---

## 9.1 POI：本地搜索的基础数据层

### 9.1.1 多源 POI 的必要性

现实里 POI 不可能只来自一个来源：

- 商家库、地图 POI、UGC、第三方数据等

多源带来的典型问题：

- 同名不同店、同店不同名
- 地址/电话缺失或不一致
- 类目不统一

工程上通常需要：

- 去重与融合（以坐标/电话/地址相似等做 entity resolution）
- 统一类目体系
- 维护主键（POI ID）作为全链路锚点

---

## 9.2 QP：区分附近/同城，显式/隐式

本章给了一个非常实用的划分维度：

- **附近**：强地理约束（距离敏感）
- **同城**：弱地理约束（城市范围内即可）

以及：

- **显式地域词**：query 里直接出现“附近/周边/同城/XX市”
- **隐式地域意图**：query 没写，但用户想找本地（例如“火锅”“修电脑”“洗车”）

工程落地的关键是把“意图强弱”做出来：

- 小流量 query 可以用规则兜底（加“附近/同城”筛选看效果）
- 更稳的做法是用点击差异挖掘：同一 query 下，展示距离信息后点击是否显著提升

你可以把这当作一个在线挖掘任务：

- 给一部分流量展示距离/本地结果
- 看 CTR/满意度变化
- 推断 query 的地域意图强弱

---

## 9.3 召回：两路通道 + 配额 + 多样性

本地搜索的召回通常不是“一条路走到底”，而是两路并行：

1. **POI/本地通道**：基于 POI、地图、地理倒排
2. **泛内容通道**：常规网页/内容召回（可能也带地理实体）

本章强调配额（quota）的意义：

- 对强本地意图，必须保证本地结果有足够曝光
- 对弱本地意图，本地结果只占少量配额，防止干扰

并且要做多样性与去重：

- 同一商圈/同一品牌结果过多会降低满意度
- 同 POI 的不同内容形态（店铺页、点评、图文）需要去重或聚合

---

## 9.4 排序与混排：reward 与距离的融合

本章给了一个很典型的混排公式，把“收益（reward）”与“距离”结合。

关键经验点：

- 不直接用绝对距离值，而是用**距离的 rank**（更鲁棒、尺度无关）

示例形式（本章给出的形态）：

$$
\text{score}=\lambda\cdot \text{reward} + (1-\lambda)\cdot \frac{1+\beta}{\text{rank}^\alpha+\beta}
$$

其中：

- reward：排序模型的收益预测（点击/交互/满意度）
- rank：按距离从近到远的名次
- $\lambda$：收益与距离的权重
- $\alpha,\beta$：控制距离衰减曲线

工程理解：

- 当 query 的地域意图强时：$\lambda$ 变小，距离项更重要
- 当意图弱时：$\lambda$ 变大，主要按内容 reward 排序

### 9.4.1 多队列混排

常见实现不是把所有候选塞进一个模型，而是：

- POI 队列
- 泛内容队列
- 可能还有广告、运营位等

然后用统一 score 或者队列间策略做混排。

本章提到的“一期实验收益与指标解读”本质是在提醒你：

- 本地搜索的改动往往影响多个指标（CTR、转化、停留、满意度）
- 需要明确主指标与护栏指标，避免“点击涨了但投诉也涨了”

---

## 9.5 常见坑与检查清单

- 只靠显式词：隐式本地意图会大量漏判
- 只按距离排：用户想要的是“近且好”，不是“最近”
- 绝对距离尺度问题：不同城市/不同密度下分布差异大，rank 更稳
- POI 融合没做好：同一店铺被当作多个实体，导致去重失败
- 配额静态不变：意图强弱变化时结果分布不合理

---

## 9.6 练习（建议动手）

1. 做一个地域意图分类器：收集 200 条 query，标注“附近/同城/无地域”，并列出你用的判据。
2. 实现混排公式：给定 reward 列表与 distance 列表，计算 rank 融合分数，观察不同 $\lambda,\alpha,\beta$ 对最终排序的影响。
3. 设计 POI 去重：给出 10 个重复/近似 POI 的例子，写出你会用哪些字段做融合（坐标、电话、地址、名称相似度）。

---

## 9.7 与其它章节的连接

- 与第 6 章：地域性通常是“在相关候选上再约束”
- 与第 8 章：本地热点也会有突发性，需要新内容快速入库
- 与第 10 章：个性化会影响地域偏好（常去商圈/常点类目），但不能替代显式地理约束
