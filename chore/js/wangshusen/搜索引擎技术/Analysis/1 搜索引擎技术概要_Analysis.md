# 1 搜索引擎技术概要：从“用户满意”到“系统链路”的第一性原理

本章是全书的“总览与统一语言”。你后面学到的相关性模型、召回、排序、点击率预估、时效性、个性化、地域性……都可以回到这章，找到它们在系统中的位置。

我会用“新手可落地”的方式解释：

- 搜索里最常用的对象与日志语义（query / doc / impression / click / engagement）
- 什么决定用户满意（5 大体验因子）
- 搜索引擎的链路：每一步在解决什么不确定性

---

## 1.1 基本概念：把“搜索”看成一个随机过程

### 1) Query、Suggestion、Document

- **查询词（query）**：用户在搜索框里输入的字符串，本质上是“需求的弱表达”。
- **查询建议（SUG / suggestion）**：系统在用户输入过程中给出的候选查询词。
  - 工程上，SUG 既是产品功能，也是数据采集器：它会改变用户输入分布，进而影响后续训练数据。
- **文档（document）**：信息检索的通用术语，表示结果页上的一条候选。
  - 关键点：文档不一定是网页，也可以是商品、视频、笔记、用户等任何可被检索并排序的实体。

这三个词的意义在于：后面所有模型、特征、指标，几乎都围绕着 $(q, d, u)$（查询词、文档、用户）这个三元组展开。

### 2) Impression、Click、CTR：日志不是事实，只是“观测值”

- **曝光（impression）**：用户“看到了”文档。
- **点击（click）**：用户打开了文档。
- **点击率（CTR）**：$P(\text{click}=1\mid \text{impression}=1)$。

新手需要特别警惕：

- 曝光不是“系统给了机会”，而是“系统决定展示了什么”。因此曝光分布本身就被策略强烈干预。
- CTR 是条件概率，跟排序位置、首图、标题、摘要强相关，天然带有**位置偏差**与**展示偏差**。

### 3) Engagement：更强的满意信号

用户点击后还可能点赞/收藏/评论/转发/关注（或电商场景的加购/下单/支付）。这些行为的共同特征是：

- 发生门槛更高
- 更难被标题党骗到
- 更接近“用户获得价值”的事实

因此在很多系统里，点击是弱信号、交互是强信号。

---

## 1.2 什么决定用户满意度：5 大体验因子

本书把“用户满意度”拆成 5 个因子：

1. **相关性（Relevance）**：最重要，没有之一。
2. **内容质量（Content Quality）**：文档本身是否可信/专业/有用。
3. **时效性（Freshness）**：用户是否偏好新内容。
4. **个性化（Personalization）**：同一 query 不同用户是否应该看到不同结果。
5. **地域性（Locality）**：是否要求空间距离近（附近/同城/周边）。

### 1) 相关性：语义相关，不等于文本匹配

本章用表格强调了一个关键事实：

- 低相关的常见来源不是“完全不沾边”，而是**看似匹配但语义不满足需求**。

把相关性理解成一个更严格的命题：

> 文档 $d$ 是否能回答用户在 query $q$ 背后的问题。

这也是为什么现代搜索强调语义模型：很多 bad case 不是关键词缺失，而是意图错配、实体歧义、主题偏离。

### 2) 内容质量：不是“写得好看”，而是“可信 + 有用”

内容质量的两个维度：

- **来源可信度**：站点/作者/卖家/机构的信誉、专业性。
- **图文/媒体质量**：信息密度、事实准确、表达严谨、图片/视频清晰、美观。

工程提醒：内容质量通常更“静态”，更适合作为排序的长期特征与打压/提权规则；在 YMYL（医疗/理财/法律等）话题里权重更大。

### 3) 时效性：先判断“query 是否要新”，再谈“文档多新”

这章把时效性分成 4 类：

- **无时效性**：新旧无差别。
- **突发时效性**：热点/新闻，依赖外部信号（搜索量激增等）。
- **一般时效性**：字面表达要新（“新款…”“现在…”）。
- **周期时效性**：每年固定窗口变成热点（“高考”“双11”）。

关键思想：时效性首先是 **query-side 的意图分类**，其次才是文档侧的时间特征。

### 4) 地域性：三件事一起判断

地域性并不是“有定位就行”，而是：

- 是否有地域需求（显式 vs 隐式）
- 地域需求强度（100% 满足 vs 部分满足）
- 对距离敏感度（步行 vs 驾车范围）

这本质上仍是 query 理解问题：用 NLP/意图模型判断。

### 5) 个性化：在“query 表达不足”时补齐信息

“千人千面”的成立条件是：

- 你确实有用户行为数据能刻画兴趣
- 用户愿意登录/留痕

当 query 很宽泛（“头像”“穿搭”“耳机”）时，用户特征能显著减少不确定性。

工程上常见做法：把 $(q, d, u)$ 的特征喂给 CTR/交互率模型，预测在曝光前用户对该文档的反应。

---

## 1.3 搜索引擎链路：每一段都在减少一种不确定性

你可以把链路理解成“信息逐步补齐”的流水线：

1. **QP（Query Processing）**：把 query 变成结构化意图
   - 分词、实体识别、类目、意图、改写、纠错、归一化
2. **召回（Recall）**：从海量文档中捞出候选集合
   - 倒排索引的文本召回、向量召回、多路召回、离线日志挖掘召回
3. **排序（Ranking）**：在候选集合上估计满意度并排序
   - 相关性分、内容质量分、时效性分、个性化 CTR/交互预估、地域距离特征等
4. **结果页承接**：首屏/分页/过滤标签/多样性等
5. **反馈闭环（Logging → Training）**：曝光/点击/交互/换词形成训练数据

这章最重要的价值是：让你后面学到的每个技术点都能落在链路的某个位置。

---

## 1.4 典型工程决策：5 个因子如何“合成一个排序分”

一个实用的抽象是：

- 相关性是硬约束：先过滤掉明显不相关
- 内容质量、时效性、个性化、地域性是软约束：在相关候选里做重排

你可以想象最终排序分是某种融合：

$$
S(q,d,u) = w_r\,R(q,d) + w_q\,Q(d) + w_f\,F(q,d) + w_p\,P(q,d,u) + w_g\,G(q,d,u)
$$

- $R$：相关性
- $Q$：内容质量
- $F$：时效性（常由 query 意图与文档时间共同决定）
- $P$：个性化（CTR/交互率预估）
- $G$：地域性（距离与 POI 匹配）

这不是说一定线性加权，而是帮助你理解“为什么需要这么多章节”：每一章在提供一个可建模的分量或约束。

---

## 1.5 常见坑（新手必读）

1. **把相关性当成文本匹配**：导致“看似命中关键词但不回答问题”的结果泛滥。
2. **只优化 CTR**：容易引入标题党/美女封面等短期点击提升，长期伤害满意度与生态。
3. **不区分 query-side 与 doc-side**：例如时效性如果只看文档发布时间、不判断 query 是否要新，会把无时效 query 搞乱。
4. **忽略产品形态**：双列/单列、首屏条数不同，会改变曝光与点击分布。
5. **没画链路就开始上模型**：你不知道哪个模块在制造 bad case，也不知道数据缺口在哪里。

---

## 1.6 练习：把本章变成你自己的“搜索系统说明书”

1. 写出你常用 APP 的一个 query（例如“深度学习”），列出你认为的：
   - Top-5 相关性必须满足的条件（什么叫“相关”）
   - Top-3 内容质量的判据（什么叫“可信/有用”）
   - 它是否有时效性/地域性/个性化需求
2. 画出该 APP 的“搜索链路”，并回答：
   - 你觉得它的召回是偏文本还是偏向量？为什么？
   - 如果你只能加一个新特征进排序，你会加哪个因子？为什么？
3. 选 10 条 query，给每条标注：是否时效、是否地域、是否宽泛需要个性化。作为后续第 8/9/10 章学习的“自建标注集”。
