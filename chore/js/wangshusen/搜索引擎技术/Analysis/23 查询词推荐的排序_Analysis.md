# 23 查询词推荐的排序：先算“会不会点/会不会转化”，再做多样性

本章在 PDF 里的正文非常短（基本只列出两节标题：23.1 预估点击和转化、23.2 多样性，后面是参考文献）。因此这里的讲解会严格围绕这两个主题展开，并把它们与第 19–21 章的指标体系对齐，给出可落地的工程化理解。

你可以把推词排序理解为：

> 从候选 query 集合里选出 topN，让用户愿意点、点了以后搜索能承接、并且整体足够多样。

---

## 23.1 预估点击和转化：推词不能只“吸睛”，必须“能承接”

### 23.1.1 两段式目标：点击是前门槛，转化是最终目标

结合第 21 章的链路，完整转化是：

- 推词曝光 query → 点击 query → SERP 曝光文档 → 点击文档/发生交互

因此排序至少要同时考虑两个概率：

- $P(click\_query\mid u,context,q)$：用户会不会点这个推荐 query
- $P(conversion\mid q)$ 或 $P(click\_doc\mid u,q,context)$：点了 query 之后，搜索结果页能不能承接（有点比、首屏有点比、文档 CTR 等）

工程上常见做法是把“点击”和“转化”做成多目标或分阶段：

- 先用点击率模型粗排（保证 topN 至少有人点）
- 再融合转化/供给质量做精排（避免推“承接差”的生僻词）

### 23.1.2 供给质量（承接）可以直接变成特征

第 21 章明确讲了一个关键事实：

- 给定 query $q$，可以用历史统计推断它的承接质量（例如 SERP 有点比）

因此推词排序的特征里应包含：

- query 历史 SERP 指标：有点比、首屏有点比、文档 CTR、首点位置等
- query 的“供给规模”：相关文档数/召回量、有效文档占比
- query 的“稳定性”：是否强时效/突发（容易过时）

这类特征的作用是：

- 抑制“高点击但低承接”的诱饵 query
- 提升长期留存与用户满意

### 23.1.3 模型训练视角：这是一个 learning-to-rank 问题

推词排序可以直接复用第 19–20 章的方法论：

- pointwise：拟合 $y$（例如点击+转化的融合目标）
- pairwise/listwise：让更优的 query 排在前面（适合优化 NDCG、top1 命中等）

目标 $y$ 可以是：

- 仅点击（容易走偏）
- 点击 + 转化（更符合全链路）
- 点击 + 转化 + 搜索渗透率贡献（针对搜前推词）

---

## 23.2 多样性：避免“全是一个意思”，也避免“跑太远”

推词排序的另一个必备能力是多样性。

原因很现实：

- 候选 query 往往高度相似（Q2Q/向量召回会带来大量同义/近义/同类）
- 如果直接按分数取 topN，展示会“挤在同一语义簇里”，用户可选项变少

### 23.2.1 多样性的两层含义

结合第 21 章的“兴趣宽度”指标，可以把多样性拆成两类约束：

- **语义多样性**：避免同义/近义/改写变体占满列表
- **类目多样性**：适度覆盖不同类目，拓宽兴趣面（尤其是搜后推词、文档内推词）

但多样性要受边界约束：

- 不能为了多样性推荐到“不相关”的 query（否则有点比和承接都崩）

### 23.2.2 工程做法：重排（rerank）比端到端更常见

一个常见工程范式是两段式：

1. 模型先给候选 query 打基础分（点击/转化融合）
2. 在 topM 上做多样性重排，选出 topN

重排可用的通用策略包括：

- 去重/归一：同义词归并、改写归并
- 类目约束：每个类目最多占比/最多条数
- 相似度惩罚：选中一个 query 后，对与其相似的候选降分（可用向量相似度）

这类策略的优点：

- 可解释、好调参
- 出问题能快速定位（多样性过强/过弱）

---

## 23.3 常见坑与检查清单

- 只优化点击：会推“吸睛但承接差”的 query（第 21 章反例）
- 供给特征不做时效切片：热点词过时后仍高分，体验波动
- 多样性做得太激进：列表很“花”，但用户不点（相关性不够）
- 多样性完全不做：列表全是同义/变体，用户选择成本高

---

## 23.4 练习（建议动手）

1. 设计一个推词融合目标 $y$：点击（有点比）+ 转化（SERP 有点比）+ 供给质量，并解释你为何这样加权。
2. 做一个两段式重排：先取 top50，再做“相似度惩罚 + 类目配额”选 top10，观察展示多样性变化。
3. 对搜前推词与 SUG 分别定义多样性：为什么 SUG 的多样性通常应更弱？

---

## 23.5 与其它章节的连接

- 与第 21 章：转化必须对齐“推词→搜索承接”全链路指标
- 与第 19–20 章：推词排序本质也是 LTR，可复用 pointwise/pairwise/listwise 与 NDCG 思想
- 与第 22 章：召回越强（ItemCF/Swing/向量/多跳），候选越密集，越需要多样性重排
