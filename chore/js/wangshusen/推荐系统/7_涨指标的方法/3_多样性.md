这节课的内容是通过提升推荐物品的多样性为推荐系统涨指标。
在召回、粗排、精排三个阶段，均有提升多样性的方法。
在召回阶段，可以通过添加噪声、随机选取用户行为序列等方式提升双塔模型、I2I 的多样性。在排序阶段，结合兴趣分数与多样性分数共同给候选物品排序。

---

这节课是王树森老师“推荐系统涨指标”系列的第四篇，聚焦于**多样性 (Diversity)**。
仅仅给用户推最喜欢看的东西（Exploitation）容易导致“回音室效应”和用户审美疲劳。
工业界的数据证明，在**召回、粗排、精排**`全链路引入多样性策略`，虽然看似稍微牺牲了精准度，但实际上能显著提升 LTY（长留存）和 DAU。

以下是对这节课内容的深度逻辑拆解与总结：

### 1. 排序阶段的多样性 (Ranking Diversity)

排序阶段决定了用户最终看到什么，是多样性控制的“最后一公里”。

#### A. 精排 (Fine Ranking) —— _严控展示体验_

精排直接输出给用户，因此必须保证**视觉上的不重复**。

- **分数融合 (Score Fusion)**：
  - 最终得分 = **兴趣分数** (CTR/CVR 预估) + **多样性分数** (Diversity Score)。
  - **多样性算法**：使用 **MMR** (Maximal Marginal Relevance) 或 **DPP** (Determinantal Point Processes)。核心逻辑是：当前物品与**已选中的物品**集合差异越大，得分越高。
  - **滑动窗口 (Sliding Window)**：计算多样性时，只关注最近选出的几个物品（例如窗口大小=5）。保证“相邻的几个不要长得一样”。
- **规则打散 (Rule-based Scattering)**：
  - **硬规则**：比如“连续 5 个位置内不能出现相同的二级类目”。
  - **多模态打散**：利用视觉/文本聚类 ID，防止连续出现由不同账号发布的、但图片/文案风格非常相似的同质化内容。

#### B. 粗排 (Pre-Ranking) —— _保证候选池丰富度_

粗排不决定最终顺序，只决定候选池（比如 500 个）。如果这 500 个全是“看美女”，精排再怎么打散也无济于事。

- **策略：分段选拔**
  - **Step 1 (保准)**：先按纯兴趣分数选 Top 200。这保证了用户最爱看的东西一定能进精排。
  - **Step 2 (保广)**：在剩下的候选集中，结合“兴趣+多样性”分数，再选 300 个。
  - _目的_：强行把一些虽然分数略低、但能提供新颖性的物品塞进精排的候选池。

### 2. 召回阶段的多样性 (Recall Diversity)

如果在源头（召回）就没有多样性，后面再怎么努力也是徒劳。

#### A. 双塔召回 (Two-Tower) 的多样性

- **方法一：向量加噪 (Random Noise)**
  - **做法**：在做 ANN（近似最近邻）检索前，往 User Embedding 向量里注入随机高斯噪声。
  - **动态调整**：
    - 兴趣窄的用户 $\rightarrow$ **强噪声**（强行帮他破圈）。
    - 兴趣宽的用户 $\rightarrow$ **弱噪声**。
  - _效果_：看似损害了精准度，实测对大盘指标（留存）是正向的。
- **方法二：行为序列随机抽样 (Sequence Sampling)**
  - **做法**：用户历史行为序列长度为 $N$ (如 1000)。每次请求不全用，而是随机抽 $K$ 个 (如 50) 输入用户塔。
  - **优势**：
    1.  **随机性**：用户每次刷新的 User Vector 都不一样，召回结果自然多样。
    2.  **长短期兼顾**：因为 $K$ 小计算量小，所以可以将 $N$ 设得很大，捕捉用户很久之前的兴趣。

#### B. Item-to-Item (U2I2I) 的多样性

- **痛点**：用户的历史行为往往极不平衡（如 80% 足球，20% 美食）。如果直接用最近 $N$ 个物品做 I2I 种子，召回结果也会严重偏科。
- **解法：非均匀抽样 (Non-uniform Sampling)**
  - 不要直接取最近 $N$ 个，而是对历史行为按类目进行**平衡抽样**。
  - 强制让足球和美食的种子比例接近，从而强行拉升弱势兴趣的召回比例。

### 3. 流量探索 (Traffic Exploration)

这是一种“牺牲短期换长期”的战略手段。

- **2% 规则**：保留约 2% 的流量不做个性化推荐。
- **精选内容池**：
  - 既然不个性化，内容质量必须极高（High Quality）。
  - 通常构建一个“高交互率精品池”或“分人群精品池”（如 30-40 岁男性精品池）。
- **强制插入**：跳过排序模型，直接插在推荐流中。
- **代价与收益**：
  - _短期_：点击率肯定会掉（因为不匹配用户历史兴趣）。
  - _长期_：挖掘出用户的新兴趣点（Discovery），用户觉得“越刷越有新意”，留存率上升。

### 4. 总结

多样性是推荐系统的**润滑剂**。

- 在**精排**侧，它通过`打散`防止用户视觉疲劳。
- 在**粗排**侧，它通过`分段选拔`保留“惊喜感”的火种。
- 在**召回**侧，它通过`加噪和抽样`，打破“信息茧房”，这是提升 LT（用户生命周期）的关键手段。
