这节课介绍基于用户的召回（User Based Collaborative Filtering，缩写 UserCF）。

UserCF 的原理：如果用户 1 跟用户 2 相似，而且用户 2 喜欢某物品，那么用户 1 很可能喜欢该物品。

这节课的三个要点：

1. 如何计算两个用户之间的相似度。
2. 如何预估用户对候选物品的兴趣。
3. 如何利用索引在线上快速做召回。

---

这是王树森关于**基于用户的协同过滤 (UserCF)** 的详解。这堂课与上一节 ItemCF 形成对称，构成了传统推荐算法的“双子星”。

下面我将以逻辑清晰、一针见血的方式为您分析 UserCF 的核心原理、工业界落地细节及其与 ItemCF 的差异。

### 一、 UserCF 的核心逻辑：物以类聚，人以群分

UserCF 的推荐哲学是：**你和谁像，就推荐谁喜欢的东西给你。**

- **直觉:** 如果用户 A 和用户 B 历史上喜欢的物品高度重合，那么他们是“灵魂伴侣”或“兴趣同温层”。
- **推论:** 当 A 发现了新大陆（喜欢了一个新物品），B 大概率也会喜欢。
- **计算公式:** 最终预测用户 $u$ 对候选物品 $I$ 的兴趣分数：
  $$
  Score(u, I) = \sum_{v \in \text{SimilarUsers}(u)} \text{Sim}(u, v) \times \text{Interest}(v, I)
  $$
  - $\text{Sim}(u, v)$: 用户 $u$ 和相似用户 $v$ 的相似度。
  - $\text{Interest}(v, I)$: 相似用户 $v$ 对物品 $I$ 的喜好程度。

---

### 二、 关键技术细节：用户相似度计算与热门惩罚

UserCF 最关键的一步是算出“谁和谁像”。

#### 1. 基础版公式 (Jaccard/Cosine)

$$
\text{Sim}(u_1, u_2) = \frac{|\text{Items}(u_1) \cap \text{Items}(u_2)|}{\sqrt{|\text{Items}(u_1)| \times |\text{Items}(u_2)|}}
$$

- **分子:** 共同喜欢的物品数量。
- **分母:** 归一化。

#### 2. 进阶版：热门物品降权 (IIF - Inverse Item Frequency)

这是一个非常重要的工业界 trick。

- **问题:** 如果 $u_1$ 和 $u_2$ 都喜欢《哈利波特》（全人类都喜欢），这能说明他们兴趣独特且相似吗？不能。但这会虚高分子数值。
- **修正:** **物品越热门，对相似度的贡献越小。**
  $$
  \text{Sim}(u_1, u_2) = \frac{\sum_{i \in \text{JointItems}} \frac{1}{\log(1 + N_i)}}{\sqrt{|\text{Items}(u_1)| \times |\text{Items}(u_2)|}}
  $$
  - $N_i$: 物品 $i$ 被多少人交互过（热门程度）。
  - $\frac{1}{\log(1 + N_i)}$: 热门物品的权重被严重打压。只有共同喜欢“冷门/垂直”物品（如《深度学习在语音中的应用》），才更能证明两人是真·同行。

---

### 三、 工业界落地：双索引机制 (Two Indexes)

与 ItemCF 类似，UserCF 也必须依赖离线索引来实现毫秒级召回。

1.  **用户 -> 物品索引 (User-Item Index):**

    - **Key:** User ID
    - **Value:** `[(ItemID_1, Score), (ItemID_2, Score)...]`
    - _作用:_ 查询相似用户 $v$ 到底喜欢啥。

2.  **用户 -> 用户索引 (User-User Index):**
    - **Key:** User ID
    - **Value:** `[(SimUser_1, SimScore), ..., (SimUser_K, SimScore)]`
    - _作用:_ 快速找到当前用户的 $K$ 个“灵魂伴侣”。
    - _挑战:_ 全量计算 $U \times U$ 矩阵非常耗时（如果用户量是亿级，计算量是天文数字），通常需要通过 LSH (局部敏感哈希) 或倒排索引剪枝来加速。

---

### 四、 UserCF vs ItemCF：一针见血的对比

面试或工作中，选择 UserCF 还是 ItemCF 取决于业务场景。

| 维度         | UserCF (基于用户)                                                                                                              | ItemCF (基于物品)                                                                                   |
| :----------- | :----------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------- |
| **推荐逻辑** | 推荐**相似人群**喜欢的东西。                                                                                                   | 推荐**相似物品**（买了又买）。                                                                      |
| **核心假设** | **人以群分。**                                                                                                                 | **物以类聚。**                                                                                      |
| **适用场景** | **社交性强、新闻资讯类**。 <br> 原因：热门新闻突发性强，ItemCF 还没来得及算相似度，UserCF 可以通过那群最活跃的人迅速分发出去。 | **电商、电影、长视频**。 <br> 原因：用户兴趣通常比较稳定，且物品库相对静态，Item 相似度计算更稳健。 |
| **可解释性** | 弱。“因为和你像的人都看了”——这就有点抽象。                                                                                     | 强。“因为你看了 A，所以推荐 B”——直观。                                                              |
| **冷启动**   | 对**新物品**友好（只要有人点，就能扩散）。                                                                                     | 对**新物品**不友好（没交互就没相似度）。                                                            |
| **实时性**   | 较难。用户行为变了，相似用户群可能没那么快变。                                                                                 | 容易。用户一点新东西，推荐列表立刻根据新 Item 刷新。                                                |

### 五、 总结

1.  **原理:** 利用用户共现的物品来计算用户相似度，进而通过相似用户进行物品分发。
2.  **关键 Trick:** 必须对热门物品进行降权（Inverse Item Frequency），否则算出来的相似用户全是“大众脸”。
3.  **落地:** 依然是离线算相似度索引 + 线上查表召回的模式。
4.  **定位:** 在小红书/微信看点等内容社区，UserCF 能够捕捉社会热点和圈层文化，通常与 ItemCF 并存，互为补充。
