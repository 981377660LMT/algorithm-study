这节课以小红书为例讲解推荐系统的链路。链路包括召回、粗排、精排、重排。
召回（retrieval）：快速从海量数据中取回几千个用户可能感兴趣的物品。
粗排：用小规模的模型的神经网络给召回的物品打分，然后做截断，选出分数最高的几百个物品。
精排：用大规模神经网络给粗排选中的几百个物品打分，可以做截断，也可以不做截断。
重排：对精排结果做多样性抽样，得到几十个物品，然后用规则调整物品的排序。

这段内容是王树森关于**推荐系统工业界架构**的宏观综述，重点在于解构从海量内容到最终展示的**漏斗型（Funnel）处理链路**。

以下是逻辑清晰、一针见血的深度分析：

### 一、 核心架构：漏斗模型（The Funnel）

推荐系统的本质是一个**层层筛选**的过程。面对几亿篇笔记（Item Base），系统不可能对每一篇都进行精细计算。因此，设计思路是**在不同阶段平衡“计算代价”与“预估准确率”**。

- **海量数据 (数亿):** 数据库底层。
- **召回 (几千):** 快速筛选，低计算量。
- **粗排 (几百):** 初步评分，中等计算量。
- **精排 (几百):** 精确打分，高计算量。
- **重排 (几十):** 业务逻辑与多样性，最终展示。

---

### 二、 链路各环节深度拆解

#### 1. 召回 (Recall) —— 撒大网

- **目标:** 从几亿篇笔记中快速取回几千篇候选。
- **策略:** **多路召回 (Multi-channel Recall)**。
  - 单一算法无法覆盖所有用户兴趣，必须并发调用多种通道（协同过滤、双塔模型、关注作者、热门内容等）。
- **必要步骤:** 融合、去重、过滤。
  - _过滤逻辑:_ 必须剔除用户明确屏蔽的作者或话题，这是用户体验的底线。
- **特点:** 追求**速度**和**覆盖率**，允许一定的准确率损失（宁可错杀，不可漏网）。

#### 2. 粗排 (Rough Ranking) —— 过滤器

- **目标:** 从几千篇中筛选出几百篇给精排。
- **方法:** 使用**小规模**的机器学习模型。
- **存在意义:** **算力预算的妥协**。因为精排模型太重，无法支撑几千篇的实时打分，粗排起到了“预筛选”的作用，剔除明显不靠谱的内容。

#### 3. 精排 (Fine Ranking) —— 裁判员

- **目标:** 对粗排送来的几百篇笔记进行精确打分。
- **方法:** **大规模深度神经网络 (Deep Neural Networks)**。
- **输入特征:**
  - 用户特征 (User Profile)
  - 物品特征 (Item Features)
  - **统计特征** (Statistical Features): 这一点很关键，如历史点击率等。
- **输出机制:** 多目标预测。
  - 不只是预测“点击”，而是同时预测点击率、点赞率、收藏率、转发率等。
  - **最终分数:** 多目标的**加权和** (Weighted Sum)。
- **小红书特有的策略:** 王树森提到在小红书，精排后**不做截断**，而是带着分数全部进入重排。这说明小红书非常看重后续的多样性调整，不希望在精排阶段就过早丢弃可能增加多样性的候选项。

#### 4. 重排 (Re-ranking) —— 策展人

- **目标:** 决定最终展示给用户的几十篇内容及其顺序。
- **依据:** 精排分数 + **多样性 (Diversity)** + 业务规则。
- **核心动作:**
  - **多样性抽样:** 使用 MMR (Maximal Marginal Relevance) 或 DPP (Determinantal Point Processes) 算法。
    - _目的:_ 防止推荐结果过于单一（比如全屏都是 NBA）。哪怕用户喜欢，也会产生审美疲劳。
  - **打散规则 (Scattering):** 强行将相似内容（如同类话题、同类图片风格）隔开。
  - **插入业务内容:** 广告 (Ads)、运营推广、冷启动内容。
- **工程复杂度:** 这一步往往包含数千行代码的硬规则 (Hard Rules)，是算法与产品策略结合最紧密的地方。

---

### 三、 关键洞察与技术权衡

1.  **算力与精度的博弈:**
    整个链路的设计完全是围绕着计算资源转的。

    - **召回/粗排:** 数据量大 $\to$ 模型简单 $\to$ 计算快。
    - **精排/DPP:** 数据量小 $\to$ 模型复杂 $\to$ 计算慢 $\to$ 精度高。
      如果不先做漏斗筛选，直接上大模型，系统会瞬间崩溃。

2.  **分数不仅仅是排序:**
    精排的所谓“分数”，不是一个简单的 ranking score，它是对用户**潜在行为概率的预估**。这为后续的流量分配提供了数学依据。

3.  **重排决定生态健康:**
    王树森特别强调了重排中的**规则打散**和**美女图片限制**。这说明工业级推荐系统不仅仅迎合用户（那是精排的事），更要**引导社区氛围**（这是重排的事）。如果不加控制，只按 CTR 排序，社区很容易滑向低俗或单一化（信息茧房）。

### 总结

推荐系统不仅仅是把分数最高的物品拿出来，而是一个精密的工业流水线：
**召回**负责“广”，**粗排**负责“快”，**精排**负责“准”，**重排**负责“稳”（多样性与生态健康）。算法工程师需要在每一环中寻找最优解。

---

- 模型训练和在线部署：embedding 太大了，所以用自研的，基于 TF
- 召回有 bloomfilter
- 统计特征：物品的点击率、用户的点击率、物品分男女用户两桶的点击率、用户按物品类目分桶的点击率
