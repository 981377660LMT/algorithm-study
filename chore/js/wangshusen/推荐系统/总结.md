这是一份关于**推荐系统（Recommender System）**的工业界深度总结。

这份总结基于王树森教授的理论体系以及小红书、YouTube、Facebook 等一线的工业级实践，剥离了学术界不实用的花哨技巧，只保留经过大规模流量验证的**核心架构 (Architecture)**、**关键算法 (Algorithms)** 和 **实战心法 (Takeaways)**。

---

### 一、 宏观架构：漏斗模型 (The Funnel)

推荐系统本质上是一个**信息过滤系统**。面对数亿的内容库，我们不可能对每一个物品进行精准算分。因此，工业界的通用解法是设计一个层层筛选的**“漏斗”**。

```mermaid
graph TD
    A[海量物品池 (Billions)] --> B(召回 Retrieval)
    B -->|选出几千| C(粗排 Pre-Ranking)
    C -->|选出几百| D(精排 Ranking)
    D -->|打分排序| E(重排 Re-Ranking)
    E -->|选出几十| F[展示给用户 Display]
```

| 阶段     | 核心任务                                                   | 特点                                                                    | 典型模型                       |
| :------- | :--------------------------------------------------------- | :---------------------------------------------------------------------- | :----------------------------- |
| **召回** | **大浪淘沙**。快速从海量物品中捞出用户可能感兴趣的候选集。 | **快、并发、多路**。计算简略，追求覆盖率 (Recall)，允许一定的低准确率。 | 双塔模型 (DSSM), Swing, ItemCF |
| **粗排** | **初级过滤**。为了给精排减负，剔除明显不靠谱的物品。       | 算力与精度的折中。                                                      | 三塔模型, 轻量级 MLP           |
| **精排** | **精准裁判**。对每一条候选进行“显微镜”级别的打分。         | **准、慢**。使用包含几百个特征的大模型，计算代价高昂。                  | MMoE, DIN, DCN                 |
| **重排** | **排兵布阵**。考虑多样性、业务规则、广告插入。             | **规则强**。决定最终用户体验和生态健康。                                | MMR, DPP, 滑动窗口             |

---

### 二、 召回层：决定系统的上限

如果召回漏掉了用户喜欢的物品，后面的排序模型再厉害也无济于事。

#### 1. 双塔模型 (Two-Tower / DSSM) —— _召回的基石_

- **架构**：**用户塔**和**物品塔**完全独立（Late Fusion）。用户塔输入用户特征，物品塔输入物品特征，最后算出两个向量的内积（余弦相似度）。
- **为什么必须是双塔？** 为了**速度**。物品向量可以离线算好存入向量数据库（如 Faiss, Milvus），线上只实时计算一次用户向量，然后做 ANN（近似最近邻）搜索。
- **训练 Takeaway**：
  - 不要用 Pointwise（把召回当二分类），由于正负样本极度不平衡，效果很差。
  - **推荐用 Listwise (Softmax)** 或 Pairwise (Triplet Loss)。YouTube 和 Facebook 均证明 Listwise 效果最好。
  - **正负样本**：正样本是点击；负样本要包含“简单负样本”（随机采样）和“困难负样本”（虽然没点击但相关性很高的，如被粗排淘汰的）。

#### 2. Swing —— _解决“小圈子”噪声_

- **痛点**：传统的 ItemCF 认为“同时点击了 A 和 B 的人越多，A 和 B 越相似”。但在微信群等场景下，一个小团体的跟风行为会导致完全无关的物品被关联。
- **核心逻辑**：**降低“穿一条裤子”的人的权重**。
- **公式精髓**：计算共现时，如果两个用户 $u_1, u_2$ 的历史行为重合度（Overlap）很高，说明他们互为冗余信息，他们对物品相似度的贡献要做除法打折。

#### 3. Look-Alike (人群扩散) —— _冷启动的大杀器_

- **逻辑**：利用种子用户画像去“钓”相似用户。
- **流程**：新物品发布 $\to$ 获得前 10 个点击用户 $\to$ 计算这 10 个用户的平均向量（物品的受众画像）$\to$ 推荐给全网跟这个受众画像相似的人。

---

### 三、 排序层：决定系统的精度

这是算力消耗最大的环节，也是利用 DNN 拟合能力最强的环节。这里是 **Early Fusion** 的主场，用户和物品特征在这里尽早交叉。

#### 1. MMoE (多目标学习) —— _解决“既要又要”_

- **场景**：你要同时预测点击率 (CTR)、点赞率、收藏率、转发率、完播率等。单纯共享底层参数 (Shared-Bottom) 会出现“跷跷板效应”（优化点击导致完播率下降）。
- **解法**：**Expert（专家） + Gate（门控）**。
  - 设置多个底层专家网络，每个目标（Task）有一个“门控”来动态决定听哪个专家的建议。
- **避坑**：**Gate 极化**。训练中容易出现 Gate 只选一个 Expert 的情况，导致模型退化。解决方案是给 Gate 的输出加 **Dropout**，强迫它“雨露均沾”。

#### 2. DIN (Deep Interest Network) —— _捕捉动态兴趣_

- **痛点**：传统模型把用户历史行为取平均（Average Pooling）。这无法区分用户当下的意图（看球鞋时，你也把历史记录里的“口红”算进来，就是噪音）。
- **解法**：**Attention 机制**。
  - 输入：候选物品 (Candidate) + 用户历史序列 (History)。
  - 计算：候选物品去 query 历史序列，算出每个历史物品的**权重**。看球鞋时，历史里的球鞋权重变大，口红权重归零。

#### 3. DCN (Deep & Cross Network) —— _特征显式交叉_

- **痛点**：DNN 其实不擅长做乘法（特征交叉）。
- **解法**：在 DNN 旁边并联一个 **Cross Network**，显式地每一层都乘以原始输入 $x_0$，高效构造 $x_i \times x_j \times x_k$ 这种高阶组合特征。

---

### 四、 重排层：决定用户体验与生态

#### 1. MMR (Maximal Marginal Relevance) —— _多样性核心_

- **逻辑**：打分不仅仅看“喜好程度 (Reward)”，还要减去“与已选物品的相似度 (Penalty)”。
- **公式**：$Score = \theta \cdot Reward - (1-\theta) \cdot \max Similarity(Candidate, Selected)$。
- **Takeaway**：也就是“如果不像已选的，就加分；太像了，就扣大分”。

#### 2. 滑动窗口 (Sliding Window)

- **实战技巧**：计算多样性时，不要跟已选列表里所有的物品比，**只跟最近的 $N$ 个比**。用户能接受第 10 个推荐跟第 1 个相似，但不能接受第 2 个跟第 1 个相似。

---

### 五、 核心 Takeaways 与避坑指南

#### 1. 关于指标 (Metrics)

- **别只看 CTR/AUC**：工业界的终极目标是 **DAU (日活)** 和 **LT (用户留存时长, LT7/LT30)**。
- **跷跷板**：点击率高了，可能时长变短了（全是标题党）；时长长了，可能曝光少了（全是长视频）。需要多目标加权融合。

#### 2. 关于冷启动 (Cold Start)

- **没有万能药**：必须分阶段。
  - **0 曝光阶段**：利用**内容 (Content-based)**，如类目、关键词、图像聚类召回。
  - **低曝光阶段**：利用 **Look-Alike**，抓住第一批种子用户进行扩散。
  - **高曝光阶段**：进入 **双塔/ItemCF** 主流池，完全依赖行为数据。

#### 3. 关于特征 Engineering

- **User ID / Item ID 很重要**：但对冷启动不友好。
- **统计特征最强**：物品的历史 CTR、用户的历史 CTR、用户在特定类目下的 CTR。这些特征对模型的贡献度往往超过 Embedding。
- **不要用前期融合做召回**：这是初学者最容易犯的错。前期融合只能做精排，召回必须双塔解耦。

#### 4. 关于学术研究 vs 工业落地

- **重工业，轻学术**：很多顶会论文（如 GNN 在推荐中的应用）在工业界因为延迟太高根本跑不起来。
- **推荐阅读**：多读 Google (YouTube), Meta (Facebook), Alibaba, TikTok 的工程论文。

#### 5. 交互行为的权重

- **关注**：给低粉作者高权重（扶持生态），给高粉作者低权重（防止马太效应）。
- **转发**：通常代表高质量传播，应给予高权重，特别是向站外引流。
- **评论**：对 0 评论的新笔记给高权重，诱导即时反馈。
