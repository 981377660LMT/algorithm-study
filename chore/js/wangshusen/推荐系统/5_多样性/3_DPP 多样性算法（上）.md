行列式点过程 (determinantal point process, DPP) 是一种经典的机器学习方法，在 1970's 年代提出，在 2000 年之后有快速的发展。DPP 是目前推荐系统重排多样性公认的最好方法。

DPP 的数学比较复杂，这节课先介绍数学基础，下节课再介绍它在推荐系统的应用。这节课的内容主要是超平行体、超平行体的体积、行列式与体积的关系。

---

这节课是 **DPP (Determinantal Point Process, 行列式点过程)** 算法的上半部分，主要讲解其背后的**数学原理**。

DPP 被认为是目前推荐系统领域中**效果最好的多样性算法**（通常优于 MMR），但其数学门槛稍高。这节课的核心逻辑建立在几何学之上：**用“体积”来衡量“多样性”**。

以下是对这节课数学基础的深度逻辑拆解与总结：

### 1. 核心隐喻：体积 = 多样性 (Volume = Diversity)

这是理解 DPP 的一把钥匙。

- **设定**：

  - 选取 $K$ 个物品，每个物品用一个向量 $v_i$ 表示（建议使用 CLIP 等基于内容的 Embedding，并且归一化为单位向量，即 $\|v\| = 1$）。
  - 这 $K$ 个向量在 $D$ 维空间中，可以张成一个 **超平行体 (Hyper-parallelepiped)**。
    - _2D 空间_：2 个向量张成平行四边形。
    - _3D 空间_：3 个向量张成平行六面体。

- **极端情况分析**：

  - **情况 A：物品高度相似**
    - 几何表现：向量 $v_1$ 和 $v_2$ 方向几乎相同（夹角接近 0）。
    - 后果：张成的平行四边形被“压扁”了。
    - 体积：**接近 0**。
  - **情况 B：物品完全不同**
    - 几何表现：向量 $v_1$ 和 $v_2$ **正交 (Orthogonal)**，即互相垂直（夹角 90 度）。
    - 后果：张成的平行四边形“撑得最开”（变成了矩形/正方体）。
    - 体积：**最大 (等于 1)**。

- **结论**：**超平行体的体积 (Volume) 可以完美地作为物品集合多样性的度量指标。** 体积越大，向量之间越不相关，物品组合的多样性就越好。

### 2. 几何计算：由底和高算体积

如何计算这组向量张成的体积？王树森老师通过中学几何知识进行了推导：

- **基本公式**：面积/体积 = 底 $\times$ 高。
- **计算高 (Height)**：
  - 若以 $v_1$ 为底，计算 $v_2$ 带来的面积。
  - 需要计算 $v_2$ 在 $v_1$ 上的投影 (Projection)。
  - **高 (Residual Vector)** = 原向量 $v_2$ - 投影向量。
  - 高 $q_2$ 垂直于底 $v_1$。
- **推广到 K 维**：
  - 第 $K$ 个向量带来的“高”，是它垂直于前 $K-1$ 个向量所确定的超平面的分量。
  - 如果第 $K$ 个向量能被前面的向量线性表示（线性相关），说明它落在底面上，高为 0，体积为 0。这也解释了为什么冗余物品会导致多样性得分为 0。

### 3. 核心桥梁：行列式 (Determinant)

我们在工程中很难直接去算几何体积（涉及到复杂的格拉姆-施密特正交化），DPP 的精髓在于把几何问题转化为了代数问题。

- **矩阵定义**：
  - 构造一个矩阵 $V$，大小为 $D \times K$。每一列是一个物品的向量 $v_i$。
- **行列式性质**：
  - 数学定理：**矩阵 $V$ 张成的超平行体的体积的平方，等于矩阵 $V^T V$ 的行列式。**
  - 公式：
    $$ \text{Volume}^2(v_1, \dots, v_K) = \det(\mathbf{V}^T \mathbf{V}) $$
  - 其中 $\mathbf{L} = \mathbf{V}^T \mathbf{V}$ 被称为 **Gram Matrix (格拉姆矩阵)**。它的第 $(i, j)$ 个元素就是向量 $v_i$ 和 $v_j$ 的内积（即相似度）。

### 4. 总结

这节课建立了一个严密的逻辑链条：

1.  **目标**：我们要最大化重排列表的**多样性**。
2.  **几何映射**：多样性越好 $\Leftrightarrow$ 向量越正交 $\Leftrightarrow$ 张成的**体积越大**。
3.  **代数求解**：体积越大 $\Leftrightarrow$ **行列式 $\det(V^T V)$ 越大**。

因此，下一节课要讲的 DPP 算法的核心任务就是：**从 $N$ 个候选物品中选出 $K$ 个，使得这 $K$ 个物品组成的 Gram Matrix 的行列式最大。**

这个数学转换非常优雅，它把抽象的“多样性”变成了一个可以直接计算和优化的数学指标。
