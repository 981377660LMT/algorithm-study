行列式点过程 (determinantal point process, DPP) 是一种经典的机器学习方法，在 1970's 年代提出，在 2000 年之后有快速的发展。DPP 是目前推荐系统重排多样性公认的最好方法。

这节课介绍 DPP 及其再推荐系统重排中的应用。求解 DPP 是比较困难的，需要计算行列式很多次，而计算行列式需要矩阵分解，代价很大。这节课介绍 Hulu 论文中的算法，可以用较小的代价求解 DPP。

---

这节课是 **DPP (Determinantal Point Process, 行列式点过程)** 的下半部分。
如果说上半部分是在“修内功”（理解体积和行列式的关系），那么下半部分就是“练招式”（如何工程落地）。

王树森老师这节课的核心在于解决一个问题：**虽然 DPP 很完美，但是计算量太大了（暴力算行列式是 $O(K^3)$），如何在 10ms 的延迟限制下把它算出来？** 答案是：**Cholesky 分解更新算法 (Chen et al. 2018, Hulu)**。

以下是对这节课内容的深度逻辑拆解与总结：

### 1. DPP 的优化目标 (The Objective)

我们要选出一个集合 $S$，使得它同时满足“价值高”和“多样性好”。
在 DPP 框架下，目标函数变为：

$$ \text{Maximize } \sum\_{i \in S} \text{Reward}\_i + \alpha \cdot \log \det(\mathbf{L}\_S) $$

- **第一项**：$Reward$ 之和。代表相关性。
- **第二项**：**Gram 矩阵 $\mathbf{L}_S$ 的行列式的对数**。代表多样性（体积）。
  - $\mathbf{L} = \mathbf{V}^T \mathbf{V}$。$\mathbf{L}_S$ 是 $\mathbf{L}$ 关于集合 $S$ 的子矩阵。
  - $\det(\mathbf{L}_S)$ 就是集合 $S$ 张成的超平行体体积的平方。

### 2. 贪心算法求解 (Greedy Algorithm)

直接求全局最优解是 NP-Hard 的。我们依然采用贪心策略，一次选一个。
假设当前已选集合为 $S$，我们要从剩余集合 $R$ 中选下一个物品 $i$，使得增益最大：

$$ i^\* = \arg\max*{i \in R} \left( \text{Reward}\_i + \alpha \cdot (\log \det(\mathbf{L}*{S \cup \{i\}}) - \log \det(\mathbf{L}\_S)) \right) $$

**计算瓶颈：**

- 每一轮都要对每一个候选物品 $i$，去算一个新的矩阵 $\mathbf{L}_{S \cup \{i\}}$ 的行列式。
- 矩阵大小是 $(|S|+1) \times (|S|+1)$。算一次行列式就要 $O(|S|^3)$。
- 总复杂度爆炸：$O(N \cdot K^4)$。直接上线肯定超时。

### 3. 用 Cholesky 分解加速 (The Acceleration)

这是 DPP 能在推荐系统中落地的关键技术（Hulu 在 2018 年发表的算法）。

- **Cholesky 分解**：

  - 对于对称正定矩阵 $\mathbf{A}$，可以分解为 $\mathbf{A} = \mathbf{L} \mathbf{L}^T$，其中 $\mathbf{L}$ 是**下三角矩阵**。
  - **行列式性质**：$\det(\mathbf{A}) = \det(\mathbf{L})^2 = (\prod \text{diag}(\mathbf{L}))^2$。
  - _意义_：只要维护好下三角矩阵 $\mathbf{L}$，算行列式只需要把对角线乘起来，复杂度 $O(K)$，极快。

- **增量更新 (Incremental Update)**：
  - 当集合 $S$ 增加一个物品 $i$ 时，新的 Gram 矩阵只是增加了一行一列。
  - 其对应的 Cholesky 因子 $\mathbf{L}_{new}$ 也只需要在 $\mathbf{L}_{old}$ 的基础上增加一行。
  - 这个新增的一行可以通过简单的向量运算求出来（不需要重新做矩阵分解）。
  - **加速效果**：计算复杂度从 $O(K^3)$ 降到了 $O(K^2)$ 甚至更低。
- **最终复杂度**：$O(N \cdot K^2)$。这是可以在线上实时运行的。

### 4. 工业界实战技巧

和 MMR 一样，DPP 上线也需要配备“左右护法”：

1.  **滑动窗口 (Sliding Window)**：

    - **问题**：随着 $S$ 变大，向量很容易线性相关，导致行列式趋近 0，$\log 0 = -\infty$，算法失效。
    - **解法**：只取最近 $W$ 个物品计算行列式。$\mathbf{L}_S \rightarrow \mathbf{L}_{Window}$。

2.  **规则约束 (Constraints)**：
    - **问题**：不能让纯数学公式主导一切，比如要强插广告。
    - **解法**：在贪心选择前，先对候选集合 $R$ 进行 `filter`，只保留符合业务规则的物品，再算 DPP 分数。

### 5. 总结

| 对比维度       | MMR                          | DPP                                                  |
| :------------- | :--------------------------- | :--------------------------------------------------- |
| **多样性度量** | Pair-wise (两两相似度最大值) | **Set-wise (整体体积/行列式)**                       |
| **理论完备性** | 启发式，只看局部最差情况     | 数学严密，考虑整体正交性                             |
| **计算复杂度** | 低 $O(N \cdot K)$            | 较高 $O(N \cdot K^2)$ (优化后)                       |
| **推荐场景**   | 通用，简单粗暴               | **精品内容分发** (如视频/长文)，对整体排列组合要求高 |

**一句话总结这节课**：利用线性代数中的 Cholesky 分解性质，将原本计算昂贵的“最大体积搜索”问题，变成了可以毫秒级响应的实时重排算法。
