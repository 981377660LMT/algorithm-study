这节课介绍推荐系统和搜索引擎重排中常用的 Maximal Marginal Relevance (MMR)，它根据精排打分和物品相似度，从 n 个物品中选出 k 个价值高、且多样性好的物品。这节课还介绍滑动窗口 (sliding window)，它可以与 MMR、DPP 等多样性算法结合，实践中滑动窗口的效果更优。

---

这节课详细讲解了推荐系统重排阶段最经典和常用的多样性算法——**MMR (Maximal Marginal Relevance，最大边际相关性)**，并介绍了在工业界落地时必不可少的**滑动窗口**优化技巧。

以下是对这节课核心内容的深度解析：

### 1. MMR 算法背景与目标

- **来源**：最早源于搜索排序（Search Ranking），后被引入推荐系统。
- **位置**：处于精排（Fine Ranking）之后的**重排/后处理**阶段。
- **输入**：
  1.  $N$ 个候选物品的精排分数 $Reward_i$（代表用户对物品的兴趣/价值）。
  2.  任意两个物品之间的相似度 $Sim(i, j)$（基于标签或向量计算）。
- **目标**：从 $N$ 个候选物品中选出 $K$ 个，组成最终的曝光列表。这个列表需要同时满足**高价值（用户喜欢）**和**高多样性（避免重复）**。

### 2. MMR 核心公式详解

算法的核心是计算每个待选物品 $i$ 的 **Marginal Relevance（边际相关性）** 分数 $MR_i$，公式如下：

$$ MR*i = \theta \cdot \underbrace{Reward_i}*{\text{价值项}} - (1 - \theta) \cdot \underbrace{\max*{j \in S} Sim(i, j)}*{\text{惩罚项 (多样性)}} $$

- **$Reward_i$ (价值项)**：物品本身的精排得分（点击率、点赞率等融合分）。分越高越容易被选中。
- **$\max_{j \in S} Sim(i, j)$ (惩罚项)**：
  - **$S$**：当前**已经选中**的物品集合。
  - **$i$**：当前**待选**的物品。
  - **含义**：算出物品 $i$ 与已选集合 $S$ 中**最像它的那个物品**的相似度。
  - **作用**：如果 $i$ 跟已经选出来的某个东西特别像，这一项就很大，导致最终 $MR_i$ 变小（被抑制/打压），从而避免因为重复而被选中。
- **$\theta$ (平衡系数)**：介于 $0$ 到 $1$ 之间。
  - $\theta$ 越大，越看重相关性（Reward）；$\theta$ 越小，越看重多样性。

### 3. 算法执行流程 (Greedy Strategy)

MMR 是一个**贪心算法**，通过 $K$ 轮循环，逐步构建列表：

1.  **初始化**：已选集合 $S$ 为空，候选集合 $R$ 为所有物品。
2.  **第 1 轮**：此时 $S$ 为空，惩罚项为 0。直接选择 $Reward$ 最高的物品，存入 $S$。
3.  **后续轮次 (共 $K-1$ 次)**：
    - 对于 $R$ 中剩下的每一个物品 $i$，套用上述公式计算 $MR_i$。
    - **注意**：因为 $S$ 变了，所以惩罚项 $\max Sim(i, j)$ 每一轮都要重新计算。
    - 选出 $MR_i$ 最高的物品，移入 $S$。
4.  **结束**：直到选够 $K$ 个物品。

### 4. 关键工程优化：滑动窗口 (Sliding Window)

- **痛点**：随着已选集合 $S$ 越来越长，新的待选物品 $i$ 很容易与 $S$ 中的某一个物品撞车（相似），导致惩罚项总是很大（接近 1）。这会使算法失效，变成了只看 Reward 或者选出低质物品。
- **解决方案**：只与**最近选中的一小部分物品**做比较，而不是全部。
- **应用**：定义一个窗口 $W$（例如大小为 10），$W$ 是 $S$ 的尾部子集。
  - **修正后的惩罚项**：$\max_{j \in \mathbf{W}} Sim(i, j)$
- **物理意义**：
  - 用户浏览 Feed 流时，只关注**局部多样性**。
  - 第 30 个推荐的物品，跟第 1 个物品相似是可以接受的（用户早忘了），但跟第 29 个、28 个物品相似则是不可接受的。
- **结论**：工业界实际应用中，**MMR 几乎总是配合滑动窗口使用**，这样既保证了体验，又保护了算法的稳定性。

### 总结

MMR 是一种简单、直观且解释性极强的多样性算法。它通过“**如果不像已选的物品，就给它加分；如果太像，就扣大分**”的逻辑，在推荐列表的生成过程中实现了去重和打散。配合滑动窗口技术，它是目前重排阶段最主流的基线算法之一。
