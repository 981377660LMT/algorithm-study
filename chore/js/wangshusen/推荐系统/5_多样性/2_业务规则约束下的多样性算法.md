推荐系统有很多业务规则，比如不能连续出多篇某种类型的物品、某两种类型的物品笔记间隔多少。这些业务规则应用在重排阶段，可以与 MMR、DPP 等多样性算法相结合。

---

这节课的内容非常接地气，直接触及了工业界推荐系统（特别是像小红书这种内容平台）重排阶段最头疼但也最现实的问题——**业务规则 (Business Rules)**。

理论上的 MMR 只要平衡好相关性和相似度就行了，但在实际业务中，产品经理和运营会提出各种千奇百怪的“硬性要求”。这些要求往往优先级高于算法模型。

以下是对这节课内容的深度逻辑拆解与总结：

### 1. 常见的业务规则类型

王树森老师将这些规则归纳为三大类（以小红书为例）：

- **类型 A：强制插入 / 强制打散 (Hard Antagonism)**

  - _规则_：连续 $K$ 篇不能是同一类，或者必须插入一类。
  - _场景_：图文 vs 视频。
  - _例子_：如果前 5 篇全是图文，第 6 篇**必须**是视频（哪怕这时候视频的分数很低）。防止用户觉得“这里只有看图的，没视频看”。

- **类型 B：频控 / 密度控制 (Frequency Control)**

  - _规则_：每 $K$ 篇里最多出现 1 篇某类内容。
  - _场景_：广告 (Ads) / 运营推广 (Boost) / 营销号。
  - _例子_：强推的内容往往用户体验（CTR）一般。为了不引起反感，规定每 10 篇里最多插 1 篇运营推广笔记。

- **类型 C：首屏保护 / 关键位置保护 (Prime Spot Protection)**
  - _规则_：前 $T$ 篇里最多出现 $K$ 篇某类内容，或者完全不能出现。
  - _场景_：商业化内容（电商卡片）。
  - _例子_：不仅要控总量，还要控位置。比如“首屏（前 4 篇）不能有广告”，或者“第一篇必须是纯内容（不能带货）”。这是为了保证用户第一眼的好感度（留存率 Is King）。

### 2. 规则与 MMR 的结合：Pre-Filtering

如何在算法中优雅地执行这些规则？最简单有效的方法就是在 MMR 的贪心循环中加一步 **过滤 (Filter)**。

#### 算法流程修正：

1.  **Current State**：目前已选列表 $S$（长度为 $m$），待选集合 $R$。
2.  **Filter (规则筛选)**：
    - 遍历 $R$ 中的每一个候选品。
    - 检查如果把它放到位置 $m+1$，会不会违反任何一条业务规则？
      - _Check 1_：前面连续 5 个是图文了，这货也是图文吗？是 -> 踢掉。
      - _Check 2_：最近 9 个里已经有一个广告了，这货也是广告吗？是 -> 踢掉。
      - _Check 3_：现在是选第 1 名，这货带电商卡片吗？是 -> 踢掉。
    - 把所有**不违规**的候选品组成一个新的子集 $R'$。
3.  **Select (MMR 打分)**：
    - 仅在 **$R'$** 中计算 MMR 分数：
      $$ \arg\max\_{i \in R'} \left( \text{Reward}\_i - \lambda \cdot \text{Diversity}(i, S) \right) $$
    - 选分最高的那个放入 $S$。

### 3. 潜在风险：死锁 (Deadlock)

虽然课里没细讲，但这是一个显而易见的工程坑点：

- **情况**：如果你把所有视频笔记都过滤掉了（因为分太低没进 $R$，或者前面用光了），然后规则要求“下一篇必须是视频”。
- **结果**：$R'$ 为空集。算法直接崩了，或者选不出东西来。
- **对策**：通常要有**兜底策略 (Fallback Strategy)**。
  - 比如：如果 $R'$ 为空，尝试放松优先级最低的规则（比如允许图文继续连着出）。
  - 或者：在粗排阶段就强制通过 DPP 等算法保证视频的供给量足够多。

### 4. 总结

这节课揭示了推荐系统重排层的真实面貌：**算法只是带着镣铐跳舞**。
MMR 负责在**可行域**内找最优解，而业务规则负责定义这个**可行域 ($R'$)**。一个成熟的重排系统，核心往往不仅仅是那个相似度公式，而是一个强大、灵活、可配置的**规则引擎 (Rule Engine)**。
