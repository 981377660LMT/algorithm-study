视频播放的建模主要有两个目标：视频播放时长、视频完播率。这节课讨论如何在多目标排序模型添加与播放时长、完播率相关的预估任务。

---

这份内容专门深入探讨视频推荐场景下特有的两个关键指标：**播放时长 (Watch Time)** 和 **完播率 (Completion Rate)**。相比于图文笔记简单的点赞/收藏，视频的这两个指标能更细腻地反映用户对内容的真实兴趣，是视频排序模型的重中之重。

以下是对这节课逻辑的深度拆解与梳理：

### 1. 核心差异：视频 VS 图文

- **图文笔记**：互动（点赞、收藏、转发）是核心指标。点击即消费。
- **视频**：
  - **播放时长 & 完播率** 是核心指标（尤其是长视频平台）。
  - 原因：用户可能看得很爽（完播），但懒得点赞。如果只看互动，会漏掉大量优质但非“诱导型”的视频。

### 2. 播放时长建模 (Watch Time Modeling)

这是本节课最硬核的部分，王老师特别强调了不能直接做回归，而是采用了 YouTube 论文中提出并优化的 **Weighted Logistic Regression** 方法。

#### A. 为什么不用直接回归 (MSE Loss)？

直接用神经网络输出一个数值去拟合时长 $T$，通常效果不好。时长的分布往往是长尾的（大部分几秒，少部分几十分钟），直接回归容易受到异常值影响，且梯度难以训练稳定。

#### B. 改进方案：加权逻辑回归 (Weighted Logistic Regression)

做訓練的時候用 P, 預測的時候用 exponential z

- **模型结构**：最后一层输出实数 $Z$。
- **训练阶段**：

  - **变换**：将 $Z$ 通过 Sigmoid 变为概率 $P = \frac{e^Z}{1 + e^Z}$。
  - **Label 构造**：构造伪标签 $Y = \frac{T}{1+T}$ （$T$ 是真实时长）。
    - _注意_：如果是未点击样本，时长 $T=0 \implies Y=0$。
  - **Loss**：使用 $P$ 和 $Y$ 之间的交叉熵损失 (Cross Entropy)。
  - **简化版 Loss (工业界常用)**：直接把时长 $T$ 当作样本的**权重 (Sample Weight)**，对正样本（点击样本）进行加权训练标准 Logistic Regression。即：正样本权重为 $T$，负样本权重为 1。

- **推理 (Inference) 阶段**：
  - 根据推导，当模型收敛，$P \approx Y$，即 $\frac{e^Z}{1+e^Z} \approx \frac{T}{1+T}$。
  - 解得：$e^Z \approx T$。
  - **结论**：线上预估时，直接取 $e^Z$ (也就是 odds)，这就是对播放时长 $T$ 的无偏估计。

### 3. 完播率建模 (Completion Rate Modeling)

完播率反映用户是否坚持看完了，但它有一个天然的 Bias：**短视频天然比长视频完播率高**。

#### A. 两种建模方式

1.  **回归任务**：预测播放百分比（如 0.73）。Label 是实际播放比例 $Y \in [0, 1]$。
2.  **二分类任务**：人为定义“完播”阈值（如 >80% 算完播，Label=1；否则 Label=0）。

#### B. 关键问题：长短视频偏差 (Duration Bias)

- **现象**：15 秒视频完播率平均 50%，15 分钟视频完播率平均 10%。如果直接用预估完播率排序，长视频会死得很惨。
- **解决方案：去偏 (Debiasing)**
  1.  **统计**：离线统计所有的“视频时长-平均完播率”曲线，拟合出一个函数 $F(duration)$。这个函数告诉你：对于长度为 $X$ 的视频，平均完播率应该是多少。
  2.  **校准**：
      $$ P*{adjusted} = \frac{P*{predict}}{F(duration)} $$
  - **逻辑**：
    - 15 秒视频预估完播 0.6，平均水平 $F(15s)=0.5 \implies$ 得分 1.2（表现不错）。
    - 15 分钟视频预估完播 0.2，平均水平 $F(15min)=0.1 \implies$ 得分 2.0（表现非常好）。
    - 这样长视频就有了和短视频公平竞争的机会。

### 4. 总结与应用

- **输入**：User/Item 特征。
- **输出**：
  - $e^Z \to$ **预估时长 (pTime)**。
  - $P_{finish\_adjusted} \to$ **去偏后的预估完播率 (pFinish)**。
- **融合**：将这两个分数代入上一节课的融分公式：
  $$ Score = (1 + w*1 \cdot e^Z)^{\alpha} \times (1 + w_2 \cdot P*{finish_adjusted})^{\beta} \dots $$

**一针见血的结论**：
视频推荐的核心在于**时长的准确预估**和**完播率的公平性校准**。掌握了 Weighted Logistic Regression 预估时长和 Bias Correction 校准完播率，就掌握了视频排序模型的精髓。

---

- 听说 p 站是用用户最后看的视频作为最重要的指标
