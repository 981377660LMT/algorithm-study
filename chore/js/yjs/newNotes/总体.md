好的，我们用一个模块化的、易于掌握的方式来重新梳理 Yjs。

想象一下，你要搭建一个乐高模型，这个模型就是一个协作应用。Yjs 为你提供了几套标准化的积木，你只需要将它们拼在一起。

---

### Yjs 的四大核心模块

你可以将 Yjs 理解为由以下四个核心模块（积木）组成的系统：

1.  **核心数据容器 (`Y.Doc`)** - 大脑
2.  **共享数据类型 (Shared Types)** - 骨架与器官
3.  **连接提供者 (Providers)** - 神经网络
4.  **感知状态 (Awareness)** - 表情与姿态

---

### 模块一：核心数据容器 (`Y.Doc`) - 大脑 🧠

`Y.Doc` 是你所有协作数据的中心。把它想象成一个**共享的、有记忆的笔记本**。

- **职责**:
  - 作为所有共享数据的“根”容器。
  - 为你的客户端（浏览器标签页）分配一个唯一的 ID。
  - 记录所有发生的变更（谁、在何时、做了什么）。
- **核心特性**:
  - **独立**: 一个 `Y.Doc` 本身不包含任何网络代码。它只关心数据和历史。
  - **唯一**: 在一个协作会话中（例如，编辑同一份文档的所有人），虽然每个人都有自己的 `Y.Doc` 副本，但它们最终会通过同步变得一模一样。

**简单来说：`Y.Doc` 就是协作的起点和中心。**

```javascript
import * as Y from 'yjs'

// 创建一个大脑/笔记本
const ydoc = new Y.Doc()
```

---

### 模块二：共享数据类型 (Shared Types) - 骨架与器官 🦴

你不能直接把普通的 JavaScript 对象（如 `{}` 或 `[]`）放进 `Y.Doc` 里让它协作。你需要使用 Yjs 提供的**特殊数据类型**，它们就像是为协作而生的骨架和器官。

- **`Y.Text`**: 用于协作编辑**文本**。就像 Google Docs 的段落。
- **`Y.Array`**: 用于协作编辑**列表/数组**。就像一个共享的 Trello 看板列表。
- **`Y.Map`**: 用于协作编辑**键值对**。就像一个共享的配置对象。
- **`Y.XmlFragment`**: 用于协作编辑**富文本或 XML/HTML**。这是与 ProseMirror、Tiptap 等编辑器集成的关键。

**简单来说：选择合适的共享类型来构建你的数据结构。**

```javascript
// 在大脑中获取一个用于协作的 "Map" 结构
const ymap = ydoc.getMap('my-shared-data')

// 在大脑中获取一个用于协作的 "Text" 结构
const ytext = ydoc.getText('my-shared-text')

// 修改这些特殊类型，Yjs 会自动记录变更
ymap.set('name', 'Alice')
ytext.insert(0, 'Hello World!')
```

---

### 模块三：连接提供者 (Providers) - 神经网络 🌐

你的 `Y.Doc` 只是一个离线的笔记本。**Provider** 负责连接你的笔记本和其他人的笔记本，并同步所有内容。它就是神经网络。

- **职责**:
  - 监听你的本地 `Y.Doc` 发生的变更。
  - 将这些变更通过网络发送出去。
  - 接收来自他人的变更，并应用到你的本地 `Y.Doc` 上。
- **常见类型**:
  - **`WebsocketProvider`**: 通过一个**中央服务器**来同步数据。所有人都连接到这个服务器。这是最常见和最可靠的方式。
  - **`WebrtcProvider`**: 通过 **P2P (点对点)** 直接连接浏览器。无需中央服务器中转数据，但建立连接更复杂。
  - **`IndexeddbProvider`**: **不联网**。它将你的 `Y.Doc` 变更保存在浏览器的数据库中，实现**离线支持**。

**简单来说：Provider 让你的数据“活”起来，在不同用户和设备间流动。**

```javascript
import { WebsocketProvider } from 'y-websocket'
import { IndexeddbProvider } from 'y-indexeddb'

// 模块组合：将大脑(ydoc)连接到 WebSocket 服务器
const wsProvider = new WebsocketProvider(
  'wss://your-server.com', // 服务器地址
  'my-document-room', // 房间名
  ydoc // 要同步的大脑
)

// 模块组合：同时将大脑(ydoc)的数据保存到本地数据库，实现离线支持
const dbProvider = new IndexeddbProvider('my-document-db', ydoc)
```

---

### 模块四：感知状态 (Awareness) - 表情与姿态 👋

文档内容（文本、列表等）是需要永久保存的。但有些状态是临时的，比如**谁在线、他们的光标在哪里、他们选中了什么**。这些就是“感知”状态。

- **职责**:
  - 广播临时的、非持久化的用户状态。
  - 它不属于 `Y.Doc` 的历史记录，不会被保存。
- **核心特性**:
  - 当用户关闭浏览器，他们的 Awareness 状态会自动消失。
  - 非常轻量，专门用于实现“在场感”。

**简单来说：Awareness 用来同步那些“此时此刻”的状态。**

```javascript
// Awareness 通常附加在网络 Provider 上
const awareness = wsProvider.awareness

// 设置我自己的状态（会被广播）
awareness.setLocalStateField('user', {
  name: 'Bob',
  color: '#ff0000' // 光标颜色
})

// 监听所有人的状态变化
awareness.on('change', () => {
  const states = Array.from(awareness.getStates().values())
  console.log(
    '当前在线用户:',
    states.map(s => s.user)
  )
  // 在这里你可以根据这些状态来渲染其他用户的光标
})
```

### 总结：如何拼装

1.  **创建大脑**: `const ydoc = new Y.Doc();`
2.  **定义骨架**: `const ymap = ydoc.getMap('shared-stuff');`
3.  **连接网络**: `const provider = new WebsocketProvider(..., ydoc);`
4.  **添加表情**: `const awareness = provider.awareness;`

这四个模块清晰地分离了各自的职责，你可以根据需求灵活组合。例如，如果你只需要离线功能，可以只使用 `Y.Doc` 和 `IndexeddbProvider`。如果你需要构建一个功能完备的协作编辑器，那么这四个模块你都会用到。
