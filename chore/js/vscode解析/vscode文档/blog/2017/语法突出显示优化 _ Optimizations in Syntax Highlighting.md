# 语法突出显示优化

链接：https://code.visualstudio.com/blogs/2017/02/08/syntax-highlighting-optimizations

## 一针见血的分析

这篇文章揭示了 VS Code 在性能优化上的“极致实用主义”：

1.  **从 CSS 到二进制的范式转移**：早期 VS Code 试图利用浏览器的原生 CSS 解析能力进行语法高亮，通过生成大量类似于 `.token.keyword.js` 的 CSS 类。虽然这在初期很有效，但在处理超大文件或实现 **Minimap**（代码缩略图）时，渲染数万个 DOM 节点的性能开销无法接受。
2.  **32位元数据的统一表示**：VS Code 1.9 引入了二进制词法标记。每个 Token 被压缩成一个 32 位整数，包含语言 ID、Token 类型（用于括号匹配）、字体样式、前景和背景色索引。这种紧凑的表示极大地降低了内存占用（在大型文件如 `sqlite3.c` 上减少了约 22.8%）。
3.  **Trie 树加速主题匹配**：为了快速确定 TextMate 作用域的颜色，VS Code 构建了一棵 Trie 树（前缀树）。这使得主题匹配从复杂的字符串处理变成了高效的路径查找。
4.  **Minimap 的技术基建**：这次重构最直接的驱动力是 Minimap。只有将 Token 转换成纯数据的二进制格式，才能在 Canvas 上通过像素点直接绘制，而完全绕过缓慢的 DOM。

## 摘要

VS Code 1.9 对语法高亮进行了深度重构。原本基于字符串和 CSS 的机制被替换为基于二进制 `Uint32Array` 的新架构。新方案不仅让 TextMate 主题的一致性得到了显著提升，还将 tokenization 的速度提高了 15%-46%，并减少了 20% 以上的内存占用。
