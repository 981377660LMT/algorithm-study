# 括号对着色快 10,000 倍

链接：https://code.visualstudio.com/blogs/2021/09/29/bracket-pair-colorization

## 深入分析

### 1. 算法的正义：从 $O(N)$ 到 $O(\log N)$

流行的插件在处理 4 万行代码时需 10 秒才能更新颜色，因为它是全量重新扫描。VS Code 原生实现引入了 **(2,3)-平衡树** 存储括号状态。最关键的设计是：**节点不存储绝对位置，仅存储相对长度**。这使得单次编辑只需更新父链，复杂度实现了指数级下降。

### 2. 绕过插件 API 的限制

插件无法实时访问渲染层的 Token 信息，且必须通过异步 API 与主进程通信。原生实现通过复用渲染层的 Token 探测（区分注释、字符串中的括号），并直接在渲染循环中介入，彻底消除了“异步闪烁”和“主线程阻塞”的问题。

### 3. 工程细节：平衡树与增量解析

文章详细描述了如何利用增量解析（Incremental Parsing）重用旧树节点。通过“Position Mapper”将旧坐标映射到新坐标，仅对受编辑影响的极小范围内进行重新解析。这种极致的算法优化是 VS Code 能保持丝滑体验的基石。
