# 1.7 Rollback 事故报告

链接：https://code.visualstudio.com/blogs/2016/11/3/rollback

## 一针见血的分析

这是一篇程序员必读的“故障复盘”教科书，记录了 VS Code 历史上最严重的线上事故之一：

1.  **无心之失的 DDoS 攻击**：VS Code 1.7 引入了 **自动类型获取（ATA）** 功。为了优化 JS 的智能提示，TypeScript 服务会自动去 npm 下载对应的 `@types` 包。然而，由于算法中对不存在的包（404）缺乏缓存机制，导致全球百万级用户在打开项目时同时向 npm 发起海量请求。在峰值时，这些请求占到了 npm 全球总流量的 **10%**（相当于整个印度的流量）。
2.  **快速响应与透明度**：微软在收到 npm 的反馈后，仅用了不到两个小时就决定撤回（Rollback）整个 1.7 版本的发布。这种“宁可错杀、不留隐患”的决断力，以及公开、透明的事故报告，赢得了社区的信任，化解了潜在的品牌危机。
3.  **缓存失效的代价**：事故的根源在于一个简单的逻辑错误——认为未来可能会有新的 `@types` 包，所以对 404 请求不进行持久化记录。这提醒了所有客户端开发者：当你拥有数百万用户时，任何一个细小的“激进抓取”逻辑都可能变成一个恐怖的分布式拒绝服务武器。
4.  **工程纪律的进步**：这次事故促使 VS Code 和 TypeScript 团队建立了更严格的 API 限流、指数退避（Exponential Backoff）和服务端预取机制。

## 摘要

2016年11月，VS Code 1.7 版本发布后不久被迫撤回。原因是新功能 Automatic Type Acquisition (ATA) 在处理 JavaScript 类型定义文件时，向 npm 注册表发送了海量的 404 请求，导致 npm 遭遇类似 DDoS 的流量冲击。这篇文章记录了从发现问题到决定撤回的全过程，是 VS Code 历史上重要的工程治理案例。
