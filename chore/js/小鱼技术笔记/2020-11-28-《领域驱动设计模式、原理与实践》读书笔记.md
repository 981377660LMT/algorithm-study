2020-11-28-《领域驱动设计模式、原理与实践》读书笔记 DDD

## 概述

在阅读前我一直有几个大的困惑没有解决：

- `如何划分系统模块，让模块之间轻松加代码满足不断变化的需求`。正常情况下，我们是设计好了以后，后期加需求就会遇到困难，一个需求需要改好几个地方的代码。要小心翼翼，如履薄冰。并且这样的代码，`新来的人看起来会很头痛`，因为理解这个模块的代码需要牵涉多个模块和需求。
- 如何让模块像乐高一样堆起来，可以`动态地组合`。例如一个库存模块，可以支持多种不同类型的销售单据。或者一个销售单据，如何支持多个不同的库存模块。
- 如何做`单元测试`，单元测试现在的做法是对外部依赖加 mock，然后进行测试。但是 mock 的数量越多，测试就越脆弱，稍微的代码改动都会造成好几个单元测试重新改。更理想的情况是，mock 的数量小，同时单元测试的覆盖率也高。
- 如何做`多表的查询`。对于涉及多个模块的数据的筛选和查询功能，我的方法是在每个模块筛选后，组合结果，然后通过 getBatch 来组合数据，但是这样的性能很差。但是，当这些逻辑放在数据库来做的话，感觉各个模块的数据就会泄漏到数据库上。每个模块的功能就不再是内聚的，它可能会涉及多模块的数据。
- `面向对象编程模式的意义在哪里`。编程的时候，我既需要考虑数据库的表结构应该如何涉及，也要考虑业务模块- 如何划分，写逻辑的时候全部都是过程式代码。找不到 OOP 编程的意义在哪里，感觉 OOP 是多此一举。
- `事务问题`一直依赖于数据库的串行化隔离级别，因为一个命令，可能涉及多次的表操作，我们要保证写入的原子性。另一方面，要考虑并发情况下产生的数据竞争的问题。串行化的并发性能很低，但能保证结果一旦可靠和准确。如何在更好的并发性能下，实现原子性和隔离性。显然，在分布式环境下，我们更没有串行化隔离的级别，那么我们如何实现原子性和隔离性。

从建模，开发，测试，数据事务，这些问题一直困惑着我，使我没有往分布式的方向往前走。直到看到了这本书，这上面的大部分问题都得到了答案。而且令人惊讶的是，答案不是通过技术来实现的，而是**跳出了技术的思维，用业务的角度去考虑问题。**

## 启发

如果你手里拿的是锤子，那你看到的都是钉子。
`如果你是一个擅长技术的人，你就会将所有的问题都尝试用技术的方法来解决它，也没有考虑其他方法。而现实世界不是这样的，每个问题的背后，其实你可以用不同的角度和方法来解决它`。我们要做的是，综合多个方法的成本和结果，去选择最好的方法。而不是永远都在一个角度，一个方法上思考问题，这是非常悲哀的。
与此同时，DDD 教会了一个重要方法论，`永远要抓住核心是什么`。只有抓住核心矛盾才能解决问题，而不是要去尝试解决所有矛盾。
`一个项目的成功与否不是与项目最薄弱的地方决定的，而是由项目最核心价值是否实现来决定的`

## 核心理论

2020-11-28-《领域驱动设计模式、原理与实践》读书笔记
https://blog.fishedee.com/2020/11/28/%E3%80%8A%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%81%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/#%E6%A6%82%E8%BF%B0

如何划分系统模块，划分子域，然后用一个上下文对应一个子域来实现它。
如何让模块像乐高一样堆起来，每个上下文都是逻辑自治的，用松耦合的方式组合它们。
如何做单元测试，三段开发模式从根本上避免了数据库 mock，更好地做业务逻辑的单元测试。
如何做多表的查询。CQRS 提供了使用领域事件来构建非范式化数据，以实现最优化的查询。
面向对象编程模式的意义在那里。三段开发模式的第二段就是 OOP。
事务问题一直依赖于数据库的串行化隔离级别。聚合就是解决这个问题的。

---

如何复用一套代码满足多样化的需求？
https://zhuanlan.zhihu.com/p/181731816

## 模块切分的好坏标准是什么？

如果所有的需求都要集中到一个模块去等排期，那必然会拖慢速度

- 公共模块应该稳定(库代码)
- 避免超级繁忙的顶层模块
- 通过新增模块来扩展功能

如果一个需求动辄就要数个模块联合开发和调试，那必然会拖慢速度

- 要更关注“易变性”而不是“功能切分”(eg:如何添加权限校验功能)

## 这些经典的解决方案用了也就那样

如果原则一直都在那里，那为什么我们过去看过的代码都没遵守这些原则呢?

- 最容易想到的解决方案未必是最佳的方案
- 真正松耦合的接口定义形式并没有被大众所熟知
- 按照这些松耦合的接口去分解模块并不容易落地

**调整模块边界，重塑接口，这个是要触及灵魂的。痛彻心扉。 最容易想到也是最容易办到的方案，未必就是最好的方案**

## 松耦合的接口应该定义成什么样子？

- 基于 UI 的组合
- 不要返回值

## 为什么实际的业务代码都没有写成你说的那个样子？

- 当你听到别人的一个想法的时候，先想想为什么行得通
- 当你要提出一个想法的时候，先想想为什么行不通
