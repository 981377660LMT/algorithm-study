# ARIES 恢复算法详解

`数据库恢复原型算法`

`Crash Recovery`

ARIES（Algorithms for Recovery and Isolation Exploiting Semantics）是一种数据库恢复算法，最初由IBM研究院在20世纪90年代初期为DB2数据库系统开发。虽然并非所有系统都完全按照论文中定义的方式实现ARIES，但大多数现代数据库系统采用的恢复机制与ARIES非常相似。

## ARIES 的核心思想

ARIES 基于三个主要思想：

1. **预写日志 (Write-Ahead Logging)**：

   - 任何数据库变更在写入磁盘前，必须先将其记录到稳定存储的日志中
   - 使用STEAL（允许未提交事务的脏页刷盘）和NO-FORCE（提交事务时不强制脏页刷盘）的缓冲池策略

2. **在重做阶段重演历史 (Repeating History During Redo)**：

   - 系统重启时，重放操作并将数据库恢复到崩溃前的确切状态

3. **撤销过程中记录日志 (Logging Changes During Undo)**：
   - 在撤销操作时记录日志，确保在多次失败的情况下操作不会重复执行

## 日志序列号 (LSN)

ARIES使用日志序列号(Log Sequence Numbers)来跟踪和管理恢复过程：

| LSN名称      | 位置   | 定义                             |
| ------------ | ------ | -------------------------------- |
| flushedLSN   | 内存   | 已写入磁盘的最后一条日志的LSN    |
| pageLSN      | 页面x  | 页面x的最新更新的LSN             |
| recLSN       | 页面x  | 页面x自上次刷盘以来的最早更新LSN |
| lastLSN      | 事务Ti | 事务Ti创建的最新日志记录         |
| MasterRecord | 磁盘   | 最新检查点的LSN                  |

### 写入日志记录的规则

- 每个数据页包含pageLSN，代表该页最近一次更新的LSN
- 系统跟踪flushedLSN，即目前为止已刷盘的最大LSN
- 在DBMS将页面x写入磁盘前，必须先刷新日志至少到以下点：
  - pageLSNx ≤ flushedLSN

## 正常执行过程

### 事务提交

当事务提交时：

1. DBMS将COMMIT记录写入日志
2. 确保该事务的所有日志记录（直到COMMIT记录）都已刷盘
   - 日志刷盘是顺序的、同步的磁盘写入
   - 每个日志页可以包含多条日志记录
3. 提交成功后，写入特殊的TXN-END记录到日志
   - 表示该事务不会再有新日志记录
   - 这条记录不需要立即刷盘

### 事务中止

中止事务是ARIES撤销操作的特例，只应用于单个事务。需要在日志记录中添加额外字段：

- prevLSN：事务的前一个LSN，形成每个事务的链表以便遍历

#### 补偿日志记录 (CLR)

CLR描述为撤销先前更新记录而采取的操作：

- 包含更新日志记录的所有字段，外加undoNext指针（下一个待撤销的LSN）
- CLR添加到日志中，但DBMS不会等待它们刷盘就通知应用程序事务已中止

#### 中止算法

1. 首先为事务写入ABORT记录到日志
2. 按照相反顺序分析事务的更新
3. 对于每条更新记录：
   - 写入CLR条目到日志
   - 恢复旧值
4. 最后，写入TXN-END记录并释放锁

**注意**：CLR从不需要被撤销

## 检查点机制

### 非模糊检查点（影响性能）

DBMS在创建检查点时停止所有操作以确保一致的快照：

- 暂停任何新事务的启动
- 等待所有活动事务完成
- 将脏页刷新到磁盘

### 稍好的检查点策略

DBMS在创建检查点时暂停修改事务：

- 阻止查询获取表/索引页面的写锁
- 不必等待所有事务完成
- 记录检查点开始时的内部状态：
  - 活动事务表(ATT)
  - 脏页表(DPT)

### 模糊检查点

模糊检查点允许活动事务在系统写入检查点日志记录时继续运行：

- 不尝试强制将脏页刷新到磁盘
- 新增日志记录类型跟踪检查点边界：
  - CHECKPOINT-BEGIN：表示检查点开始
  - CHECKPOINT-END：包含ATT和DPT信息
- 检查点完成时，CHECKPOINT-BEGIN记录的LSN写入MasterRecord

## 活动事务表和脏页表

### 活动事务表 (ATT)

每个当前活动的事务一个条目：

- txnId：唯一事务标识符
- status：事务的当前"模式"
  - R → 运行中
  - C → 提交中
  - U → 需要撤销的候选
- lastLSN：事务创建的最新LSN

当TXN-END记录写入后，从表中移除条目

### 脏页表 (DPT)

跟踪缓冲池中哪些页面包含尚未刷新到磁盘的更改：

- 缓冲池中每个脏页一个条目
- recLSN：首次导致页面变脏的日志记录的LSN

## ARIES 恢复阶段

ARIES的恢复过程分为三个阶段：

### 1. 分析阶段

- 从MasterRecord开始，向前检查WAL确定崩溃时缓冲池中的脏页和活动事务
- 从最后一个成功的检查点开始扫描日志
- 如果找到TXN-END记录，从ATT中移除相应事务
- 对于其他记录：
  - 如果事务不在ATT中，添加它并设状态为UNDO
  - 提交时，将事务状态更改为COMMIT
- 对于更新日志记录：
  - 如果页面P不在DPT中，将P添加到DPT并设置recLSN=LSN

分析阶段结束时：

- ATT识别崩溃时哪些事务处于活动状态
- DPT识别哪些脏页可能未写入磁盘

### 2. 重做阶段

目标是重演历史以重建崩溃时的数据库状态：

- 重新应用所有更新（甚至已中止的事务！）和重做CLR
- 从DPT中最小recLSN的日志记录开始向前扫描
- 对于每条LSN的更新日志记录或CLR，重做操作，除非：
  - 受影响的页面不在DPT中，或
  - 受影响的页面在DPT中但记录的LSN小于页面的recLSN

重做操作时：

- 重新应用记录的更新
- 将pageLSN设置为日志记录的LSN
- 不需要额外记录日志，不强制刷盘

重做阶段结束时，为所有状态为C的事务写入TXN-END日志记录并从ATT中移除它们

### 3. 撤销阶段

撤销崩溃时处于活动状态且永远不会提交的所有事务：

- 分析阶段后ATT中状态为U的所有事务
- 使用lastLSN按照相反的LSN顺序处理，加速遍历
- 为每个修改写入CLR

## 崩溃中的崩溃处理

- 如果在分析阶段恢复期间崩溃：
  - 无需特殊处理，再次运行恢复即可
- 如果在重做阶段恢复期间崩溃：
  - 同样无需特殊处理，再次重做所有操作
- 恢复期间提高重做阶段性能：
  - 假设不会再次崩溃，在后台异步将所有更改刷新到磁盘
- 恢复期间提高撤销阶段性能：
  - 在新事务访问页面前懒惰地回滚更改
  - 重写应用程序以避免长时间运行的事务

## 总结

ARIES的主要思想：

- 使用STEAL/NO-FORCE策略的预写式日志
- 模糊检查点（脏页ID的快照）
- 从最早的脏页开始重做所有操作
- 撤销从未提交的事务
- 撤销时写入CLR，以在重启期间的故障中幸存

日志序列号：

- LSN标识日志记录；通过prevLSN链接成每个事务的反向链
- pageLSN允许比较数据页和日志记录

---

从根本上理解和记忆 ARIES 恢复算法，可以抓住以下几个核心“关键词”和“比喻”：

---

## 1. 日志优先，数据后写（WAL）

**关键词**：日志先于数据  
**比喻**：像写日记，先把要做的事记下来，之后再去做。  
**记忆法**：只要有变更，先写日志，后写数据，出事了就翻日记还原。

---

## 2. 三步恢复流程（分析、重做、撤销）

**关键词**：分析（谁活着/脏了）、重做（重演历史）、撤销（回滚未完成）  
**比喻**：

- 分析：事故现场调查，谁还活着，哪些地方被破坏了。
- 重做：把事故前的所有动作再演一遍，恢复到出事那一刻。
- 撤销：把没做完的动作撤回去，保证没人“假装”做完。

**记忆法**：

- 先查清楚（分析），
- 再全部重做一遍（重做），
- 最后把没做完的撤销（撤销）。

---

## 3. 日志序列号（LSN）和链表

**关键词**：LSN、prevLSN、pageLSN  
**比喻**：每条日志像有编号的快递单，事务的日志用链表串起来，页面记住最新的快递单号。

**记忆法**：

- 日志有编号（LSN），
- 事务日志串成链（prevLSN），
- 页面记最新编号（pageLSN）。

---

## 4. 补偿日志记录（CLR）

**关键词**：撤销时也要记日志  
**比喻**：撤销动作也要写进日记，`防止撤销时又出事故`。

**记忆法**：撤销也要写日志，保证多次崩溃也能恢复。

---

## 5. 模糊检查点（Fuzzy Checkpoint）

**关键词**：快照+继续运行  
**比喻**：拍照时人还在动，但把当时的状态记下来，方便以后恢复。

**记忆法**：检查点不是暂停一切，而是边拍照边干活。

---

## 6. STEAL/NO-FORCE 策略

**关键词**：允许脏页提前写盘，提交时不强制写盘  
**比喻**：可以提前把未完成的作业交给老师，但不要求作业一交就必须存档。

**记忆法**：脏页可以提前写，提交不用强制写。

---

## 总结口诀

**先记日志，后写数据；三步恢复，分析重做撤销；撤销也写日志，检查点边拍边干；编号串链，脏页可提前。**

---

只要记住这些关键词和比喻，遇到ARIES相关问题时，脑中自然浮现出“先写日志、三步恢复、撤销也写日志、模糊检查点”等核心思想，理解和记忆就会变得非常容易。
