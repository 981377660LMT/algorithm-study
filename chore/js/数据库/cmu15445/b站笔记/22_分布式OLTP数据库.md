# 分布式 OLTP 数据库系统

基于[CMU 15-445/645 数据库系统](https://15445.courses.cs.cmu.edu/fall2022/slides/)课程，本文档包含有关分布式 OLTP(在线事务处理)数据库系统的重要概念和设计特点。

## 一、OLTP 与 OLAP 比较

| OLTP (在线事务处理) | OLAP (在线分析处理)  |
| ------------------- | -------------------- |
| 短期的读写事务      | 长时间运行的只读查询 |
| 占用资源少          | 复杂的连接操作       |
| 重复性操作          | 探索性查询           |

## 二、原子提交协议

当跨多节点的事务完成时，DBMS 需要询问所有相关节点是否可以安全提交。这需要特定的协议确保事务的原子性。

### 1. 两阶段提交协议 (2PC)

两阶段提交是一种原子提交协议，包括以下两个阶段：

#### 成功提交流程

1. **准备阶段 (Phase 1)**

   - 协调者向参与者发送准备消息
   - 参与者回复 OK 或 ABORT

2. **提交阶段 (Phase 2)**
   - 如果所有参与者回复 OK，协调者发送提交消息
   - 参与者确认并执行实际提交

#### 中止流程

- 任何参与者回复 ABORT，协调者会向所有参与者发送中止消息
- 所有参与者执行回滚操作

#### 容错机制

- 每个节点在非易失性存储日志中记录入站/出站消息和每个阶段的结果
- 恢复时检查日志中的 2PC 消息：
  - 如果本地事务处于准备状态，联系协调者
  - 如果本地事务未准备，中止它
  - 如果本地事务正在提交且节点是协调者，向节点发送 COMMIT 消息

#### 故障处理

- 协调者崩溃：参与者必须在超时后决定如何处理，此期间系统不可用
- 参与者崩溃：如果尚未发送确认，协调者假定其回复了中止，使用超时确定参与者已死亡

#### 优化技术

1. **提前准备投票**（不常见）

   - 如果向远程节点发送你确定是最后执行的查询，该节点也会在查询结果中返回准备阶段的投票

2. **准备后提前确认**（常见）
   - 如果所有节点投票提交事务，协调者可以在提交阶段完成前向客户端发送成功确认

### 2. Paxos 协议

Paxos 是一种共识协议，其中协调者提议一个结果（例如提交或中止），然后参与者对该结果是否应该成功进行投票。

#### 特点

- 只要大多数参与者可用，就不会阻塞
- 在最佳情况下具有可证明的最小消息延迟

#### 基本流程

1. **提议阶段**

   - 提议者向接受者发送提议
   - 接受者回复同意或拒绝

2. **提交阶段**
   - 获得多数同意后，提议者发送提交消息
   - 接受者接受并执行提交

#### Multi-Paxos

- 如果系统选举单一领导者监督提议变更一段时间，可以跳过提议阶段
- 在出现故障时回退到完整 Paxos
- 系统使用另一次 Paxos 轮次定期更新领导者（称为租约）
- 节点必须在领导者选举期间交换日志条目，确保每个人都是最新的

#### 2PC 与 Paxos 比较

- **两阶段提交**：如果协调者在发送准备消息后失败，会阻塞直到协调者恢复
- **Paxos**：如果大多数参与者活跃且后续没有更多故障发生，则不阻塞

## 三、数据复制

DBMS 可以跨冗余节点复制数据以提高可用性。

### 1. 复制配置

#### 主-从复制 (Primary-Replica)

- 所有更新都发送到指定的主节点
- 主节点将更新传播到副本，无需原子提交协议
- 只读事务可访问副本
- 如果主节点宕机，进行选举选择新的主节点

#### 多主复制 (Multi-Primary)

- 事务可以在任何副本更新数据对象
- 副本必须使用原子提交协议相互同步

### 2. K-安全性 (K-Safety)

K-安全性是确定复制数据库容错能力的阈值。

- K 值表示每个数据对象必须始终可用的副本数量
- 如果副本数量低于此阈值，DBMS 将停止执行并使自己离线

### 3. 传播方案

当事务在复制数据库上提交时，DBMS 决定是否必须等待该事务的更改传播到其他节点，然后才能向应用程序发送确认。

#### 同步传播 (强一致性)

- 主节点向副本发送更新，然后等待它们确认完全应用（记录）更改
- 提供强一致性保证但增加延迟

#### 异步传播 (最终一致性)

- 主节点立即向客户端返回确认，不等待副本应用更改
- 降低延迟但可能导致不一致

### 4. 传播时机

#### 连续传播

- DBMS 生成日志消息时立即发送
- 还需要发送提交/中止消息

#### 提交时传播

- DBMS 仅在事务提交时将日志消息发送到副本
- 避免为中止事务发送日志记录
- 假设事务的日志记录完全适合内存

### 5. 更新方法

#### 主动-主动 (Active-Active)

- 事务在每个副本上独立执行
- 需要在最后检查事务在每个副本上是否获得相同结果

#### 主动-被动 (Active-Passive)

- 每个事务在单一位置执行并将更改传播到副本
- 可以执行物理或逻辑复制
- 与主-从复制和多主复制不同

## 四、Google Spanner

Google 的地理复制 DBMS（2011 年后）

### 架构特点

- 模式化、半关系型数据模型
- 去中心化共享磁盘架构
- 日志结构的磁盘存储

### 并发控制

- 严格两阶段锁定 + MVCC + Multi-Paxos + 2PC
- 带同步复制的外部一致性全局写事务
- 无锁只读事务

### 事务排序

- DBMS 基于物理"挂钟"时间对事务排序，确保严格的可串行化
- 如果 T1 在 time1 完成，T2 在 time2 开始（time2 > time1），则 T1 的时间戳应小于 T2 的
- 每个 Paxos 组根据时间戳决定事务提交顺序

## 五、分片架构

### Tablet 架构

- 数据库被分解为 tablet（分区）
- 使用 Paxos 在 tablet 组中选举领导者
- 使用 2PC 处理跨 tablet 的事务
- 在不同数据中心复制 tablet，形成 Paxos 组
- 读操作可以从任何副本进行，写操作通过 leader 进行

## 六、CAP 定理

由 Eric Brewer 提出，分布式系统不可能同时保证以下三点：

- **一致性 (Consistency)**：线性一致性
- **可用性 (Availability)**：所有活跃节点都能满足所有请求
- **分区容忍 (Partition Tolerance)**：即使消息丢失也能正确操作

### CAP 应用于 OLTP DBMS

DBMS 处理故障的方式决定了它们支持 CAP 定理的哪些要素：

#### 传统/分布式关系型 DBMS

- 在大多数节点重新连接前停止允许更新，保证一致性（CA）

#### NoSQL DBMS

- 提供机制在节点重新连接后解决冲突，优先保证可用性（AP）

---

分布式 OLTP 数据库系统结合了数据库、分布式系统和事务处理的多个复杂方面。维护跨多个节点的事务一致性是一个非常具有挑战性的问题，需要在性能、一致性和可用性之间做出权衡。
