`Generated by gpt4.1`

## 1. 崩溃恢复的目标

- **一致性**：数据库始终保持一致状态。
- **原子性**：事务要么全部完成，要么全部不做。
- **持久性**：已提交事务的修改必须在系统崩溃后依然存在。

恢复算法分两部分：

1. 正常事务处理时的准备（如日志记录）。
2. 崩溃后恢复数据库到正确状态。

---

## 2. ARIES 算法核心思想

- **Write-Ahead Logging (WAL)**：先写日志，再写数据。
  - 日志必须先于数据页落盘。
  - 采用 STEAL + NO-FORCE 策略（缓冲区页可被替换，事务提交时不强制写脏页）。
- **重做历史**：崩溃后重放所有操作，恢复到崩溃前的状态。
- **撤销时也写日志**：撤销操作也要写日志（CLR），以防恢复过程中再次崩溃。

---

## 3. WAL 日志与 LSN

- **LSN（Log Sequence Number）**：每条日志的唯一编号，单调递增。
- **pageLSN**：每个数据页记录最近一次修改它的日志 LSN。
- **flushedLSN**：内存中记录的，已经落盘的最大 LSN。
- **WAL 规则**：写数据页前，必须保证该页的 pageLSN ≤ flushedLSN。

---

## 4. 事务提交与中止

- **提交**：
  - 写 COMMIT 日志并强制刷新到磁盘。
  - 之后写 TXN-END 日志（可延迟）。
- **中止**：
  - 写 ABORT 日志。
  - 按 LSN 倒序撤销操作，每撤销一步写 CLR（Compensation Log Record）。
  - 最后写 TXN-END 日志。

---

## 5. 检查点（Checkpoint）

- **非模糊检查点**：暂停所有事务，等待所有脏页落盘，影响性能。
- **模糊检查点（Fuzzy Checkpoint）**：允许事务继续运行，只记录当前活跃事务表（ATT）和脏页表（DPT）。
  - CHECKPOINT-BEGIN 和 CHECKPOINT-END 日志。
  - MasterRecord 记录最近一次 CHECKPOINT-BEGIN 的 LSN。

---

## 6. ARIES 恢复三阶段

1. **分析（Analysis）**：
   - 从上次 CHECKPOINT 开始，重建 ATT 和 DPT。
   - 确定崩溃时哪些事务未完成，哪些页是脏的。
2. **重做（Redo）**：
   - 从 DPT 中最小 recLSN 开始，重放所有操作（包括未提交事务）。
   - 只重做需要的操作（页在 DPT 且 LSN ≥ recLSN，且 pageLSN < 日志 LSN）。
3. **撤销（Undo）**：
   - 撤销所有未提交事务的操作，写 CLR。
   - CLR 记录撤销链，保证多次崩溃也能正确恢复。

---

## 7. 关键数据结构

- **ATT（Active Transaction Table）**：记录活跃事务及其状态、最后 LSN。
- **DPT（Dirty Page Table）**：记录脏页及其首次变脏的 LSN（recLSN）。

---

## 8. 其他注意事项

- 恢复过程中再次崩溃，直接重跑恢复流程即可（幂等）。
- 性能优化：重做阶段可异步刷盘，撤销阶段可懒惰回滚。

---

## 9. 总结

- ARIES = WAL + STEAL/NO-FORCE + Fuzzy Checkpoint + Redo/Undo + CLR。
- LSN 串联日志、数据页和事务，保证恢复正确性。
- 恢复流程高效、健壮，能应对多次崩溃。
