作为一名骨灰级程序员，我必须告诉你：**第 12 章是让游戏世界变得“可信”的关键。**

如果说渲染是“看起来像真的”，那么物理就是“动起来像真的”。
当玩家把一个箱子推下悬崖，它应该加速下落、翻滚、撞击地面并反弹。
如果它只是匀速飘下去，沉浸感瞬间归零。这一章将带你深入物理引擎（Physics Engine）的内部。

以下是第 12 章的核心干货剖析：

### 12.1 - 12.2 物理中间件 (Physics Middleware)

- **造轮子 vs 用轮子**：
  - 写一个稳定的物理引擎极其困难（涉及高深的微积分和数值稳定性问题）。
  - **工业界标准**：
    - **PhysX (NVIDIA)**：Unity 和 Unreal 的默认物理引擎。性能强悍，支持 GPU 加速。
    - **Havok**：老牌王者（《半条命 2》、《刺客信条》）。极其稳定，擅长处理复杂的堆叠。
    - **Box2D**：2D 物理的霸主（《愤怒的小鸟》）。
- **核心决策**：除非你是为了学习，否则**不要在商业项目中自己写物理引擎**。学会如何**整合**和**调优**现有的中间件才是正道。

### 12.3 碰撞检测系统 (Collision Detection System)

这是物理引擎的第一半壁江山：**“谁撞到了谁？”**

- **碰撞图元 (Collision Primitives)**：
  - 不要用复杂的角色模型（10 万个三角形）去算碰撞，CPU 会熔化。
  - 使用**代理几何体 (Proxy Geometry)**：球体、胶囊体（Capsule，角色常用）、盒体（Box）、凸包（Convex Hull）。
- **宽阶段 (Broad Phase)**：
  - **目的**：`快速排除`那些“绝对不可能相撞”的物体。
  - **算法**：
    - **SAP (Sweep and Prune)**：在轴上排序，检查重叠区间。
    - **BVH (Bounding Volume Hierarchy)** / **八叉树**：空间分割结构。
- **窄阶段 (Narrow Phase)**：
  - **目的**：对宽阶段筛选出的候选对，进行`精确计算`。
  - **GJK 算法**：计算两个凸包之间距离的神级算法。
  - **EPA 算法**：如果相交了，计算“穿透深度”和“接触点”，以便把它们推开。

### 12.4 刚体动力学 (Rigid Body Dynamics)

这是物理引擎的第二半壁江山：**“撞完之后怎么动？”**

- **牛顿定律的数值模拟**：
  - $F = ma$。
  - **积分器 (Integrator)**：
    - **显式欧拉 (Explicit Euler)**：$x_{new} = x + v \cdot dt$。简单，但**极不稳定**，能量会无中生有，导致物体飞出宇宙。
    - **半隐式欧拉 / Verlet**：游戏常用的积分方法，在速度和稳定性之间取得平衡。
- **约束 (Constraints)**：
  - 物理引擎不仅仅是模拟碰撞，更是模拟**连接**。
  - **关节 (Joints)**：铰链（门）、球窝（肩膀）、滑块（电梯）。
  - **求解器 (Solver)**：这是一个巨大的方程组求解过程（通常使用迭代法，如 PGS）。它要保证门不会掉下来，铁链不会被拉长。

### 12.5 整合物理引擎至游戏 (Integrating Physics)

- **物理世界 vs 渲染世界**：
  - 物理引擎有自己的世界副本。
  - **同步**：
    1.  **Kinematic（运动学）物体**：游戏逻辑控制位置（如移动平台），物理引擎只负责检测碰撞。
    2.  **Dynamic（动力学）物体**：物理引擎计算位置（如被炸飞的石头），渲染引擎读取位置并绘制。
- **步长陷阱**：
  - 再次强调第 7 章的内容：**必须使用固定时间步长 (Fixed Time Step)**。如果 $\Delta t$ 忽大忽小，物理模拟会变得不可预测（箱子可能会穿过地板）。

### 12.6 展望：高级物理功能

- **布料 (Cloth)**：披风、旗帜。
- **流体 (Fluid)**：水流、岩浆。
- **破坏 (Destruction)**：墙壁被打碎。
- **布娃娃系统 (Ragdoll)**：
  - 当角色死亡时，从“动画驱动”切换到“物理驱动”。所有的骨骼变成通过关节连接的刚体，顺着重力倒下。

---

**总结第十二章：**
这一章是在教你**“模拟上帝的规则”**。
物理引擎是游戏中最不可控、最容易出 Bug（穿模、鬼畜抖动）的系统。**理解“碰撞代理”、“积分稳定性”和“约束求解”，能让你在面对物理 Bug 时不再抓狂，而是冷静地调整参数（如 Solver Iterations）来解决问题。**
