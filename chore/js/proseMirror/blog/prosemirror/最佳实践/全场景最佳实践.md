# ProseMirror 全场景开发最佳实践盘点

本文档旨在盘点富文本编辑器开发中的常见业务场景，并提供基于 ProseMirror 的最佳技术选型与实践建议。

## 1. 基础编辑能力

| 场景/功能              | 技术选型                           | 最佳实践 & 避坑指南                                                                                         |
| :--------------------- | :--------------------------------- | :---------------------------------------------------------------------------------------------------------- |
| **加粗、斜体、下划线** | `Mark`                             | 使用 `toggleMark` 命令。注意定义 `parseDOM` 规则以兼容粘贴的 HTML（如 `<b>` 和 `<strong>` 都映射到 bold）。 |
| **链接 (Link)**        | `Mark`                             | 链接应包含 `href` 属性。建议设置 `inclusive: false`，防止用户在链接末尾输入时自动延续链接样式。             |
| **标题、段落、引用**   | `Node`                             | 基础块级元素。使用 `setBlockType` 命令切换。                                                                |
| **列表 (无序/有序)**   | `Node` + `prosemirror-schema-list` | **不要自己写列表逻辑**。列表的嵌套、缩进、回车跳出逻辑非常复杂，直接使用官方包提供的 schema 和 commands。   |
| **Markdown 快捷输入**  | `InputRules`                       | 使用 `prosemirror-inputrules`。例如输入 `# ` 自动变标题，`* ` 自动变列表。这是提升写作体验的关键。          |
| **快捷键 (Ctrl+B 等)** | `Keymap`                           | 使用 `prosemirror-keymap`。务必加载 `baseKeymap` 以保证回车、删除键行为正常。                               |

## 2. 富媒体与复杂组件

| 场景/功能               | 技术选型             | 最佳实践 & 避坑指南                                                                                                             |
| :---------------------- | :------------------- | :------------------------------------------------------------------------------------------------------------------------------ |
| **图片 (Image)**        | `Node`               | 基础图片可用 `toDOM`。如果需要**上传进度条**、**拖拽调整大小**、**失败重试**，必须使用 **`NodeView`**。                         |
| **视频/音频**           | `Node` + `NodeView`  | 必须用 `NodeView` 来处理播放器控件的事件冒泡 (`stopEvent`)，防止点击播放暂停导致编辑器光标乱跳。                                |
| **代码块 (Code Block)** | `Node` + `NodeView`  | 推荐使用 `NodeView` 集成 PrismJS/Highlight.js 实现语法高亮。**不要在 Schema 里存高亮后的 HTML**，只存纯文本代码，渲染时再高亮。 |
| **表格 (Table)**        | `prosemirror-tables` | **千万不要自己造轮子**。表格的合并单元格、列宽拖拽、行/列操作极其复杂，直接用官方维护的 `prosemirror-tables`。                  |
| **数学公式 (Math)**     | `Node` + `NodeView`  | 使用 `NodeView` 结合 KaTeX 或 MathJax 渲染。建议定义为 `atom: true`，把公式当做一个整体字符处理。                               |
| **Iframe 嵌入**         | `Node` + `NodeView`  | 给 Iframe 加一个遮罩层 (Overlay)，在编辑状态下拦截点击事件，防止鼠标被 Iframe 捕获导致无法选中节点。                            |

## 3. 交互与辅助功能

| 场景/功能                | 技术选型                 | 最佳实践 & 避坑指南                                                                                                                     |
| :----------------------- | :----------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| **提及 (@Mentions)**     | `Inline Node` + `Plugin` | **不要用 Mark**，因为 @人名 是一个整体。使用 Plugin 监听 `@` 输入触发建议列表。建议列表 UI 独立于编辑器，通过 `view.coordsAtPos` 定位。 |
| **占位符 (Placeholder)** | `Decoration`             | 当文档为空时，在首行插入一个 CSS `::before` 的 Widget Decoration。不要真的插入文字节点，否则会污染文档数据。                            |
| **字数统计**             | `Plugin` (State)         | 写一个 Plugin，在 `state.doc` 变化时计算文本长度。不要直接读 DOM 的 `innerText`，要读 Model 的 `textContent`。                          |
| **搜索/替换**            | `Plugin` + `Decoration`  | 搜索结果用 Inline Decoration 高亮。**不要修改文档内容**来实现高亮。                                                                     |
| **拼写检查/语法纠错**    | `Plugin` + `Decoration`  | 异步请求后端检查接口，返回错误位置，用 Decoration 绘制波浪线。                                                                          |
| **只读模式**             | `view.setProps`          | 设置 `editable: () => false`。但注意，只读模式下某些插件（如光标绘制）可能仍需特殊处理。                                                |

## 4. UI 集成与工程化

| 场景/功能                  | 技术选型               | 最佳实践 & 避坑指南                                                                                                                                                |
| :------------------------- | :--------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **工具栏 (Toolbar)**       | 外部 UI 组件           | 工具栏应独立于 ProseMirror 视图。通过监听 `transaction` 事件更新工具栏按钮状态（如光标在加粗文本中，加粗按钮高亮）。                                               |
| **气泡菜单 (Bubble Menu)** | `Plugin` + `Popper.js` | 选中文字后弹出的菜单。使用 Plugin 监听 `selection` 变化，利用 `view.coordsAtPos` 获取选区坐标，传给 Popper.js 定位。                                               |
| **React/Vue 组件嵌入**     | `NodeView`             | 使用 `NodeView` 作为桥梁。**关键点**：在 `ignoreMutation` 中返回 `true`，防止 PM 也就是 ProseMirror 干扰框架的 DOM 更新；在 `destroy` 中销毁框架实例防止内存泄漏。 |
| **粘贴处理 (Paste)**       | `transformPasted`      | 在 `props` 中配置 `transformPasted` 或 `handlePaste`。用于清洗 Word 粘贴的脏 HTML，或将粘贴的 URL 自动转换为卡片。                                                 |
| **拖拽上传**               | `handleDrop`           | 监听 `handleDrop` 事件，检测文件类型，执行上传逻辑并插入占位节点。                                                                                                 |

## 5. 数据与协同

| 场景/功能                | 技术选型                   | 最佳实践 & 避坑指南                                                                                                                |
| :----------------------- | :------------------------- | :--------------------------------------------------------------------------------------------------------------------------------- |
| **协同编辑**             | `prosemirror-collab`       | 必须使用官方插件。服务端作为 Source of Truth。**坑点**：断网重连时需要重新拉取服务端版本，不要盲目提交本地积压的 Steps。           |
| **Markdown 支持**        | `prosemirror-markdown`     | 如果需要双向转换（编辑时是富文本，保存为 MD），使用官方的 Serializer 和 Parser。                                                   |
| **历史记录 (Undo/Redo)** | `prosemirror-history`      | 必须加载。如果实现了协同编辑，History 插件必须放在 Collab 插件**之后**加载，否则撤销会乱。                                         |
| **大文档性能**           | 优化 `Plugin` & `NodeView` | 1. 减少 `toDOM` 重绘（NodeView `update` 返回 true）。<br>2. 避免在 `apply` 中做全量文档扫描。<br>3. 只有在保存时才序列化整个文档。 |

## 总结：核心原则

1.  **数据优先 (Schema First)**: 先想清楚数据结构，再想怎么渲染。
2.  **状态不可变 (Immutable State)**: 永远不要直接修改 `state` 或 `doc`，必须通过 `tr` (Transaction)。
3.  **视图隔离 (View Isolation)**: 复杂的交互逻辑（如点击、拖拽、渲染框架组件）交给 `NodeView`，不要塞在核心逻辑里。
4.  **插件化 (Plugin System)**: 任何非核心编辑逻辑（如字数统计、快捷键、菜单状态）都应该是 Plugin。

---

```
# ProseMirror 全场景开发最佳实践盘点

本文档旨在盘点富文本编辑器开发中的常见业务场景，并提供基于 ProseMirror 的最佳技术选型与实践建议。

## 1. 基础编辑能力

| 场景/功能 | 技术选型 | 最佳实践 & 避坑指南 |
| :--- | :--- | :--- |
| **加粗、斜体、下划线** | `Mark` | 使用 `toggleMark` 命令。注意定义 `parseDOM` 规则以兼容粘贴的 HTML（如 `<b>` 和 `<strong>` 都映射到 bold）。 |
| **链接 (Link)** | `Mark` | 链接应包含 `href` 属性。建议设置 `inclusive: false`，防止用户在链接末尾输入时自动延续链接样式。 |
| **标题、段落、引用** | `Node` | 基础块级元素。使用 `setBlockType` 命令切换。 |
| **列表 (无序/有序)** | `Node` + `prosemirror-schema-list` | **不要自己写列表逻辑**。列表的嵌套、缩进、回车跳出逻辑非常复杂，直接使用官方包提供的 schema 和 commands。 |
| **Markdown 快捷输入** | `InputRules` | 使用 `prosemirror-inputrules`。例如输入 `# ` 自动变标题，`* ` 自动变列表。这是提升写作体验的关键。 |
| **快捷键 (Ctrl+B 等)** | `Keymap` | 使用 `prosemirror-keymap`。务必加载 `baseKeymap` 以保证回车、删除键行为正常。 |

## 2. 富媒体与复杂组件

| 场景/功能 | 技术选型 | 最佳实践 & 避坑指南 |
| :--- | :--- | :--- |
| **图片 (Image)** | `Node` | 基础图片可用 `toDOM`。如果需要**上传进度条**、**拖拽调整大小**、**失败重试**，必须使用 **`NodeView`**。 |
| **视频/音频** | `Node` + `NodeView` | 必须用 `NodeView` 来处理播放器控件的事件冒泡 (`stopEvent`)，防止点击播放暂停导致编辑器光标乱跳。 |
| **代码块 (Code Block)** | `Node` + `NodeView` | 推荐使用 `NodeView` 集成 PrismJS/Highlight.js 实现语法高亮。**不要在 Schema 里存高亮后的 HTML**，只存纯文本代码，渲染时再高亮。 |
| **表格 (Table)** | `prosemirror-tables` | **千万不要自己造轮子**。表格的合并单元格、列宽拖拽、行/列操作极其复杂，直接用官方维护的 `prosemirror-tables`。 |
| **数学公式 (Math)** | `Node` + `NodeView` | 使用 `NodeView` 结合 KaTeX 或 MathJax 渲染。建议定义为 `atom: true`，把公式当做一个整体字符处理。 |
| **Iframe 嵌入** | `Node` + `NodeView` | 给 Iframe 加一个遮罩层 (Overlay)，在编辑状态下拦截点击事件，防止鼠标被 Iframe 捕获导致无法选中节点。 |

## 3. 交互与辅助功能

| 场景/功能 | 技术选型 | 最佳实践 & 避坑指南 |
| :--- | :--- | :--- |
| **提及 (@Mentions)** | `Inline Node` + `Plugin` | **不要用 Mark**，因为 @人名 是一个整体。使用 Plugin 监听 `@` 输入触发建议列表。建议列表 UI 独立于编辑器，通过 `view.coordsAtPos` 定位。 |
| **占位符 (Placeholder)** | `Decoration` | 当文档为空时，在首行插入一个 CSS `::before` 的 Widget Decoration。不要真的插入文字节点，否则会污染文档数据。 |
| **字数统计** | `Plugin` (State) | 写一个 Plugin，在 `state.doc` 变化时计算文本长度。不要直接读 DOM 的 `innerText`，要读 Model 的 `textContent`。 |
| **搜索/替换** | `Plugin` + `Decoration` | 搜索结果用 Inline Decoration 高亮。**不要修改文档内容**来实现高亮。 |
| **拼写检查/语法纠错** | `Plugin` + `Decoration` | 异步请求后端检查接口，返回错误位置，用 Decoration 绘制波浪线。 |
| **只读模式** | `view.setProps` | 设置 `editable: () => false`。但注意，只读模式下某些插件（如光标绘制）可能仍需特殊处理。 |

## 4. UI 集成与工程化

| 场景/功能 | 技术选型 | 最佳实践 & 避坑指南 |
| :--- | :--- | :--- |
| **工具栏 (Toolbar)** | 外部 UI 组件 | 工具栏应独立于 ProseMirror 视图。通过监听 `transaction` 事件更新工具栏按钮状态（如光标在加粗文本中，加粗按钮高亮）。 |
| **气泡菜单 (Bubble Menu)** | `Plugin` + `Popper.js` | 选中文字后弹出的菜单。使用 Plugin 监听 `selection` 变化，利用 `view.coordsAtPos` 获取选区坐标，传给 Popper.js 定位。 |
| **React/Vue 组件嵌入** | `NodeView` | 使用 `NodeView` 作为桥梁。**关键点**：在 `ignoreMutation` 中返回 `true`，防止 PM 也就是 ProseMirror 干扰框架的 DOM 更新；在 `destroy` 中销毁框架实例防止内存泄漏。 |
| **粘贴处理 (Paste)** | `transformPasted` | 在 `props` 中配置 `transformPasted` 或 `handlePaste`。用于清洗 Word 粘贴的脏 HTML，或将粘贴的 URL 自动转换为卡片。 |
| **拖拽上传** | `handleDrop` | 监听 `handleDrop` 事件，检测文件类型，执行上传逻辑并插入占位节点。 |

## 5. 数据与协同

| 场景/功能 | 技术选型 | 最佳实践 & 避坑指南 |
| :--- | :--- | :--- |
| **协同编辑** | `prosemirror-collab` | 必须使用官方插件。服务端作为 Source of Truth。**坑点**：断网重连时需要重新拉取服务端版本，不要盲目提交本地积压的 Steps。 |
| **Markdown 支持** | `prosemirror-markdown` | 如果需要双向转换（编辑时是富文本，保存为 MD），使用官方的 Serializer 和 Parser。 |
| **历史记录 (Undo/Redo)** | `prosemirror-history` | 必须加载。如果实现了协同编辑，History 插件必须放在 Collab 插件**之后**加载，否则撤销会乱。 |
| **大文档性能** | 优化 `Plugin` & `NodeView` | 1. 减少 `toDOM` 重绘（NodeView `update` 返回 true）。<br>2. 避免在 `apply` 中做全量文档扫描。<br>3. 只有在保存时才序列化整个文档。 |

## 总结：核心原则

1.  **数据优先 (Schema First)**: 先想清楚数据结构，再想怎么渲染。
2.  **状态不可变 (Immutable State)**: 永远不要直接修改 `state` 或 `doc`，必须通过 `tr` (Transaction)。
3.  **视图隔离 (View Isolation)**: 复杂的交互逻辑（如点击、拖拽、渲染框架组件）交给 `NodeView`，不要塞在核心逻辑里。
4.  **插件化 (Plugin System)**: 任何非核心编辑逻辑（如字数统计、快捷键、菜单状态）都应该是 Plugin。

```

已进行更改。

我已经为你整理了一份详尽的 **ProseMirror 全场景最佳实践清单**，并保存到了 `全场景最佳实践.md` 文件中。这份清单涵盖了从基础文本编辑到复杂的协同、富媒体处理等 20+ 个常见业务场景。

除了文件中的内容，针对一些**非功能性**但至关重要的场景，我再补充几点“隐形”的最佳实践：

### 补充场景：那些容易被忽略的“深水区”

#### 1. 移动端适配 (Mobile Support)

- **痛点**: Android 浏览器的软键盘输入（Composition Input）非常诡异，经常导致光标乱跳或内容重复。
- **最佳实践**:
  - **少拦截**: 尽量不要在 `handleDOMEvents` 中拦截 `input` 或 `composition` 相关事件，除非你非常清楚自己在做什么。
  - **Selection 保护**: 在移动端，用户点击屏幕唤起键盘时，Selection 可能会瞬间丢失。如果你的插件依赖 Selection（如气泡菜单），务必做空值检查。

#### 2. 国际化 (i18n)

- **现状**: ProseMirror 核心库没有 UI，所以没有 i18n 问题。但 `prosemirror-tables`、`prosemirror-menu` 等官方 UI 插件有硬编码的英文提示。
- **最佳实践**:
  - 不要直接修改 node_modules。
  - 对于官方 UI 插件，通常可以通过配置项传入自定义的 DOM 生成函数，或者使用 CSS `::after { content: "..." }` 这种黑魔法覆盖简单的提示文本。
  - 对于自己开发的 Plugin（如 Slash Menu），务必将文本抽离为配置项。

#### 3. 导出与转换 (Export)

- **场景**: 用户写完文档，要导出 PDF 或 Word。
- **最佳实践**:
  - **前端**: 负责产出标准的 HTML 或 Markdown。不要试图在前端生成 Word（虽然有库，但样式很难完美）。
  - **服务端**: 使用 **Pandoc** (神器) 将 Markdown/HTML 转换为 Docx/PDF。这是目前业界最稳健的方案。

#### 4. 埋点与监控 (Telemetry)

- **场景**: 产品经理通过数据分析用户最常用的功能。
- **最佳实践**:
  - 监听 `transaction`。
  - 检查 `tr.steps` 中的 metadata。例如，当用户点击“加粗”按钮时，给这个 Transaction 附加一个 meta: `tr.setMeta('analytics', { event: 'bold_click' })`。
  - 在全局 Plugin 中拦截这个 meta 并上报。

### 总结

ProseMirror 开发的核心哲学是 **"Schema 定义上限，Plugin 决定下限，NodeView 决定体验"**。

- **Schema**: 决定了你的编辑器能存什么数据（别让脏数据进来）。
- **Plugin**: 决定了编辑器的基本行为是否正常（撤销重做、快捷键）。
- **NodeView**: 决定了用户觉得你的编辑器“好不好用”（交互是否丝滑、UI 是否美观）。
