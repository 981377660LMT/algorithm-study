CodeMirrorï¼ˆç‰¹åˆ«æ˜¯ v6 ç‰ˆæœ¬ï¼‰ç¡®å®æ˜¯ä¸€ä¸ªæ¶æ„éå¸¸ç°ä»£ä½†ä¹Ÿç›¸å¯¹å¤æ‚çš„åº“ã€‚å®ƒé‡‡ç”¨äº†å‡½æ•°å¼ç¼–ç¨‹æ€æƒ³å’Œä¸å¯å˜æ•°æ®ç»“æ„ï¼Œè¿™ä¸ä¼ ç»Ÿçš„ DOM æ“ä½œæ–¹å¼æœ‰å¾ˆå¤§ä¸åŒã€‚

ä»¥ä¸‹æ˜¯ç†è§£ CodeMirror æ ¸å¿ƒæ¦‚å¿µçš„æŒ‡å—ã€æœ€ä½³å®è·µå’Œè®¾è®¡åŸåˆ™ï¼š

### 1. æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹ï¼šMVC æ¨¡å¼çš„å˜ä½“

CodeMirror 6 å°†ç¼–è¾‘å™¨æ‹†åˆ†ä¸ºä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œç†è§£è¿™ç§åˆ†ç¦»æ˜¯å…³é”®ï¼š

- **State (Model):** `EditorState`

  - è¿™æ˜¯å•ä¸€äº‹å®æ¥æºï¼ˆSingle Source of Truthï¼‰ã€‚
  - å®ƒåŒ…å«æ–‡æ¡£å†…å®¹ï¼ˆTextï¼‰ã€å½“å‰é€‰åŒºï¼ˆSelectionï¼‰ä»¥åŠå„ç§é…ç½®ï¼ˆFacetsï¼‰ã€‚
  - **å…³é”®ç‚¹ï¼š** State æ˜¯**ä¸å¯å˜ï¼ˆImmutableï¼‰**çš„ã€‚ä½ ä¸èƒ½ç›´æ¥ä¿®æ”¹å®ƒï¼Œåªèƒ½é€šè¿‡ Transaction ç”Ÿæˆä¸€ä¸ªæ–°çš„ Stateã€‚

- **View (View):** `EditorView`

  - è¿™æ˜¯ DOM çš„ç›´æ¥æ˜ å°„ã€‚å®ƒè´Ÿè´£å°† State æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œå¹¶ç›‘å¬ç”¨æˆ·çš„è¾“å…¥äº‹ä»¶ã€‚
  - **å…³é”®ç‚¹ï¼š** View ä¾èµ–äº Stateã€‚å½“ State æ›´æ–°æ—¶ï¼ŒView ä¼šé«˜æ•ˆåœ°æ›´æ–° DOMï¼ˆç±»ä¼¼ React çš„ diff ç®—æ³•ï¼‰ã€‚

- **Transaction (Update):** `Transaction`
  - è¿™æ˜¯æ”¹å˜ State çš„å”¯ä¸€æ–¹å¼ã€‚
  - å®ƒæè¿°äº†â€œå‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–â€ï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·è¾“å…¥äº†å­—ç¬¦ 'a'ï¼Œæˆ–è€…æ’ä»¶è¯·æ±‚æŠ˜å ä»£ç ï¼‰ã€‚

### 2. å…³é”® API ä¸å®šä¹‰è§£æ

#### Facet (åˆ‡é¢/é…ç½®é¡¹)

è¿™æ˜¯æœ€éš¾ç†è§£ä½†ä¹Ÿæœ€å¼ºå¤§çš„æ¦‚å¿µã€‚

- **å®šä¹‰ï¼š** Facet æ˜¯æ‰©å±•ç³»ç»Ÿçš„åŸºç¡€ã€‚å®ƒå…è®¸ä¸åŒçš„æ‰©å±•å‘åŒä¸€ä¸ªé…ç½®ç‚¹æä¾›å€¼ã€‚
- **ç±»æ¯”ï¼š** æƒ³è±¡ä¸€ä¸ª React Context æˆ–è€… Redux çš„ Reducer ç»„åˆã€‚
- **ç”¨é€”ï¼š** å®šä¹‰å¿«æ·é”®ã€äº‹ä»¶ç›‘å¬å™¨ã€æ ·å¼ç±»åç­‰ã€‚
- **åŸåˆ™ï¼š** å¤šä¸ªæ’ä»¶å¯ä»¥å‘åŒä¸€ä¸ª Facet æ·»åŠ æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå¤šä¸ªæ’ä»¶éƒ½å¯ä»¥æ·»åŠ å¿«æ·é”®ç»‘å®šï¼‰ã€‚

#### Extension (æ‰©å±•)

- **å®šä¹‰ï¼š** CodeMirror çš„ä¸€åˆ‡åŠŸèƒ½ï¼ˆåŒ…æ‹¬è¡Œå·ã€è¯­æ³•é«˜äº®ã€æ’¤é”€é‡åšï¼‰éƒ½æ˜¯æ‰©å±•ã€‚
- **æœ€ä½³å®è·µï¼š** æ„å»ºç¼–è¾‘å™¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç»„è£…ä¸€ä¸ªæ‰©å±•æ•°ç»„ã€‚

#### Decoration (è£…é¥°)

- **å®šä¹‰ï¼š** ç”¨äºåœ¨ä¸æ”¹å˜æ–‡æ¡£å®é™…å†…å®¹çš„æƒ…å†µä¸‹ï¼Œæ”¹å˜æ–‡æ¡£çš„è§†è§‰è¡¨ç°ã€‚
- **ç±»å‹ï¼š**
  - `MarkDecoration`: æ”¹å˜æ–‡æœ¬æ ·å¼ï¼ˆå¦‚è¯­æ³•é«˜äº®é¢œè‰²ï¼‰ã€‚
  - `WidgetDecoration`: åœ¨æ–‡æœ¬ä¸­æ’å…¥ DOM å…ƒç´ ï¼ˆå¦‚æŠ˜å åçš„çœç•¥å·ã€Lint é”™è¯¯å›¾æ ‡ï¼‰ã€‚
  - `LineDecoration`: æ”¹å˜æ•´è¡Œæ ·å¼ï¼ˆå¦‚å½“å‰è¡Œé«˜äº®ï¼‰ã€‚

#### ViewPlugin (è§†å›¾æ’ä»¶)

- **å®šä¹‰ï¼š** å½“ä½ éœ€è¦ç›´æ¥æ“ä½œ DOM æˆ–è€…éœ€è¦åŸºäº View çš„çŠ¶æ€ï¼ˆå¦‚æ»šåŠ¨ä½ç½®ã€è§†å£å¯è§èŒƒå›´ï¼‰è¿›è¡Œè®¡ç®—æ—¶ä½¿ç”¨ã€‚
- **åœºæ™¯ï¼š** æ¯”å¦‚å®ç°ä¸€ä¸ªâ€œä»£ç å°åœ°å›¾â€æˆ–è€…â€œå½“å‰ä½œç”¨åŸŸé«˜äº®â€ã€‚

### 3. æœ€ä½³å®è·µä¸åŸåˆ™

#### åŸåˆ™ 1ï¼šä¸å¯å˜æ€§ä¼˜å…ˆ (Immutability First)

æ°¸è¿œä¸è¦å°è¯•ç›´æ¥ä¿®æ”¹ `view.state.doc`ã€‚
**é”™è¯¯åšæ³•ï¼š**

```javascript
view.state.doc.toString() = "new content"; // æŠ¥é”™æˆ–æ— æ•ˆ
```

**æ­£ç¡®åšæ³• (Dispatch Transaction)ï¼š**

```javascript
view.dispatch({
  changes: { from: 0, to: view.state.doc.length, insert: 'new content' }
})
```

#### åŸåˆ™ 2ï¼šæ•°æ®æµå•å‘æµåŠ¨

`State` -> `View` -> `DOM Event` -> `Transaction` -> `New State` -> `View Update`ã€‚
å¦‚æœä½ åœ¨ç¼–å†™æ’ä»¶ï¼Œç¡®ä¿ä½ çš„é€»è¾‘éµå¾ªè¿™ä¸ªå¾ªç¯ã€‚ä¸è¦åœ¨æ¸²æŸ“å‘¨æœŸï¼ˆView Updateï¼‰ä¸­è§¦å‘æ–°çš„ Transactionï¼Œè¿™ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚

#### åŸåˆ™ 3ï¼šæŒ‰éœ€å¼•å…¥ (Tree Shaking)

CodeMirror 6 æ˜¯æ¨¡å—åŒ–çš„ã€‚ä¸è¦å¼•å…¥æ•´ä¸ªåº“ï¼Œåªå¼•å…¥ä½ éœ€è¦çš„åŠŸèƒ½ã€‚

```javascript
import { EditorState } from '@codemirror/state'
import { EditorView, keymap } from '@codemirror/view'
import { defaultKeymap } from '@codemirror/commands'
// åªå¼•å…¥éœ€è¦çš„æ¨¡å—
```

#### åŸåˆ™ 4ï¼šç†è§£åæ ‡ç³»

- CodeMirror ä½¿ç”¨ä¸€ç»´åæ ‡ï¼ˆoffsetï¼‰ï¼Œä» 0 å¼€å§‹ã€‚
- è¡Œå’Œåˆ—çš„æ¦‚å¿µæ˜¯è®¡ç®—å‡ºæ¥çš„ï¼Œä¸æ˜¯å­˜å‚¨çš„ã€‚
- **æ³¨æ„ï¼š** æ¢è¡Œç¬¦åœ¨ä¸åŒç³»ç»Ÿä¸‹é•¿åº¦ä¸åŒï¼ˆ`\n` vs `\r\n`ï¼‰ï¼ŒCodeMirror å†…éƒ¨é€šå¸¸è§„èŒƒåŒ–ä¸º `\n` (é•¿åº¦ä¸º 1)ï¼Œä½†åœ¨å¤„ç†å¤–éƒ¨è¾“å…¥æ—¶è¦å°å¿ƒã€‚

### 4. è°ƒè¯•æŠ€å·§

åœ¨å¼€å‘æ—¶ï¼Œåˆ©ç”¨ `EditorView.updateListener` æ¥è§‚å¯Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼š

```javascript
const debugExtension = EditorView.updateListener.of(update => {
  if (update.docChanged) {
    console.log('æ–‡æ¡£å†…å®¹å˜äº†')
  }
  if (update.selectionSet) {
    console.log('å…‰æ ‡ä½ç½®å˜äº†', update.state.selection.main.head)
  }
  // æŸ¥çœ‹å…·ä½“çš„ Transaction
  update.transactions.forEach(tr => {
    console.log('Transaction:', tr)
  })
})
```

### æ€»ç»“

CodeMirror 6 çš„å­¦ä¹ æ›²çº¿é™¡å³­æ˜¯å› ä¸ºå®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªç¼–è¾‘å™¨åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ª**ç”¨äºæ„å»ºç¼–è¾‘å™¨çš„æ¡†æ¶**ã€‚

- å¦‚æœä½ åªæ˜¯æƒ³ç”¨ï¼šå…³æ³¨ `EditorView` çš„é…ç½®å’Œç°æˆçš„ `Extensions`ã€‚
- å¦‚æœä½ è¦å¼€å‘æ’ä»¶ï¼šå¿…é¡»æ·±å…¥ç†è§£ `Facet` å’Œ `Transaction` æœºåˆ¶ã€‚

---

CodeMirror v6 çš„ API ç¡®å®è®¾è®¡å¾—éå¸¸åº•å±‚å’ŒæŠ½è±¡ï¼Œå› ä¸ºå®ƒä¼˜å…ˆè€ƒè™‘çš„æ˜¯çµæ´»æ€§å’Œæ€§èƒ½ï¼Œè€Œä¸æ˜¯â€œå¼€ç®±å³ç”¨â€çš„ç®€å•æ€§ã€‚

é’ˆå¯¹â€œAPI éš¾æ‡‚â€è¿™ä¸ªé—®é¢˜ï¼Œä»¥ä¸‹æ˜¯é’ˆå¯¹å‡ ä¸ªæœ€å¸¸ç”¨ã€æœ€æ˜“é”™çš„ API åœºæ™¯çš„**æœ€ä½³å®è·µæ¨¡å¼**ã€‚è®°ä½è¿™äº›æ¨¡å¼å¯ä»¥å¸®ä½ é¿å¼€ 80% çš„å‘ã€‚

### 1. ä¿®æ”¹æ–‡æ¡£å†…å®¹ (Document Changes)

**ç—›ç‚¹ï¼š** å¾ˆå¤šäººä¸çŸ¥é“å¦‚ä½•æ­£ç¡®æ›¿æ¢æ–‡æœ¬ï¼Œæˆ–è€…åœ¨å¾ªç¯ä¸­å¤šæ¬¡ä¿®æ”¹å¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–åæ ‡é”™ä¹±ã€‚

**æœ€ä½³å®è·µï¼š**

- **ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰å˜æ›´**ï¼šä¸è¦åœ¨ä¸€ä¸ªå¾ªç¯é‡Œå¤šæ¬¡è°ƒç”¨ `dispatch`ã€‚
- **ä½¿ç”¨ `changes` æ•°ç»„**ï¼šTransaction æ”¯æŒä¸€æ¬¡æ€§ä¼ å…¥å¤šä¸ªå˜æ›´å¯¹è±¡ã€‚
- **åæ ‡è‡ªåŠ¨æ˜ å°„**ï¼šå½“ä½ ä¼ å…¥å¤šä¸ªå˜æ›´æ—¶ï¼ŒCodeMirror ä¼šè‡ªåŠ¨å¤„ç†åæ ‡åç§»ï¼ˆåé¢çš„å˜æ›´ä¸éœ€è¦æ‰‹åŠ¨è®¡ç®—å‰é¢å˜æ›´å¯¼è‡´çš„ä½ç§»ï¼‰ã€‚

```javascript
// âŒ é”™è¯¯åšæ³•ï¼šå¤šæ¬¡ dispatchï¼Œæ€§èƒ½å·®ï¼Œä¸”å®¹æ˜“å¯¼è‡´è§†å›¾æŠ–åŠ¨
for (const line of lines) {
    view.dispatch({ changes: { from: ..., insert: "..." } });
}

// âœ… æœ€ä½³å®è·µï¼šæ„å»ºå˜æ›´è¯´æ˜æ•°ç»„ï¼ˆChangeSpecï¼‰ï¼Œä¸€æ¬¡æ€§æäº¤
const changes = [
    { from: 0, to: 5, insert: "Hello" }, // æ›¿æ¢å‰5ä¸ªå­—ç¬¦
    { from: 10, insert: " World" }       // åœ¨ç¬¬10ä¸ªå­—ç¬¦å¤„æ’å…¥ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„10æ˜¯åŸºäºåŸå§‹æ–‡æ¡£çš„åæ ‡ï¼‰
];

view.dispatch({
    changes: changes,
    // å¯é€‰ï¼šé¡ºä¾¿ç§»åŠ¨å…‰æ ‡åˆ°æœ€å
    selection: { anchor: 11 },
    scrollIntoView: true
});
```

### 2. è¯»å–æ–‡æ¡£å†…å®¹ (Reading Content)

**ç—›ç‚¹ï¼š** `state.doc` æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼ˆText Leafï¼‰ï¼Œä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ã€‚ç›´æ¥æ“ä½œå®ƒå¾ˆæ…¢ã€‚

**æœ€ä½³å®è·µï¼š**

- **åˆ‡ç‰‡è¯»å–**ï¼šå°½é‡åªè·å–ä½ éœ€è¦çš„èŒƒå›´ï¼Œè€Œä¸æ˜¯ `toString()` æ•´ä¸ªæ–‡æ¡£ã€‚
- **æŒ‰è¡Œè¿­ä»£**ï¼šå¦‚æœä½ éœ€è¦å¤„ç†æ¯ä¸€è¡Œï¼Œä½¿ç”¨è¿­ä»£å™¨è€Œä¸æ˜¯åˆ†å‰²å­—ç¬¦ä¸²ã€‚

```javascript
// âŒ é¿å…åšæ³•ï¼šå¤§æ–‡ä»¶æ—¶å†…å­˜çˆ†ç‚¸
const allText = view.state.doc.toString()
const lines = allText.split('\n')

// âœ… æœ€ä½³å®è·µï¼šä½¿ç”¨è¿­ä»£å™¨æˆ–åˆ‡ç‰‡
const doc = view.state.doc

// è·å–ç‰¹å®šè¡Œ
const line = doc.line(5) // è·å–ç¬¬5è¡Œå¯¹è±¡
console.log(line.text) // è¡Œå†…å®¹
console.log(line.from, line.to) // è¡Œçš„èµ·å§‹å’Œç»“æŸä½ç½®

// éå†æ‰€æœ‰è¡Œï¼ˆé«˜æ•ˆï¼‰
for (let i = 1; i <= doc.lines; i++) {
  const line = doc.line(i)
  // å¤„ç† line.text
}
```

### 3. çŠ¶æ€ç®¡ç†ä¸é…ç½® (State Fields & Facets)

**ç—›ç‚¹ï¼š** å¦‚ä½•åœ¨ç¼–è¾‘å™¨é‡Œå­˜å‚¨è‡ªå®šä¹‰æ•°æ®ï¼ˆæ¯”å¦‚ï¼šå½“å‰æ˜¯å¦å¼€å¯äº†â€œåªè¯»æ¨¡å¼â€ï¼Œæˆ–è€…å­˜å‚¨ä¸€ä¸ªå¤–éƒ¨çš„ IDï¼‰ï¼Ÿ

**æœ€ä½³å®è·µï¼š**

- **ä½¿ç”¨ `StateField`**ï¼šè¿™æ˜¯åœ¨ CodeMirror å†…éƒ¨å­˜å‚¨è‡ªå®šä¹‰çŠ¶æ€çš„æ ‡å‡†æ–¹å¼ã€‚å®ƒç±»ä¼¼äº Redux çš„ reducerã€‚
- **ä¸è¦æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ**ï¼šä¸è¦æŠŠå˜é‡å­˜åœ¨ `window` æˆ–ç»„ä»¶ `this` ä¸Šï¼Œå°½é‡å­˜åœ¨ `StateField` é‡Œï¼Œè¿™æ ·çŠ¶æ€ä¼šè·Ÿéšç¼–è¾‘å™¨å®ä¾‹ã€‚

```javascript
import { StateField, Effect } from '@codemirror/state'

// 1. å®šä¹‰ä¸€ä¸ª Effect æ¥è§¦å‘ä¿®æ”¹
const toggleReadOnly = StateField.defineEffect()

// 2. å®šä¹‰ Field
const readOnlyField = StateField.define({
  create() {
    return false
  }, // åˆå§‹å€¼
  update(value, transaction) {
    // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šçš„ Effect å‘ç”Ÿ
    for (let effect of transaction.effects) {
      if (effect.is(toggleReadOnly)) return effect.value
    }
    return value
  }
})

// 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
// è¯»å–çŠ¶æ€
const isReadOnly = view.state.field(readOnlyField)

// ä¿®æ”¹çŠ¶æ€
view.dispatch({
  effects: toggleReadOnly.of(true)
})
```

### 4. è§†å›¾æ›´æ–°ä¸æ’ä»¶ (ViewPlugins)

**ç—›ç‚¹ï¼š** æƒ³åœ¨ DOM ä¸Šåšç‚¹äº‹ï¼ˆæ¯”å¦‚ç»™ç¼–è¾‘å™¨åŠ ä¸ªè¾¹æ¡†ï¼Œæˆ–è€…æ ¹æ®æ»šåŠ¨ä½ç½®æ˜¾ç¤ºå…ƒç´ ï¼‰ï¼Œä½†ä¸çŸ¥é“æ—¶æœºã€‚

**æœ€ä½³å®è·µï¼š**

- **ä½¿ç”¨ `ViewPlugin`**ï¼šè¿™æ˜¯è¿æ¥ CodeMirror çŠ¶æ€å’Œ DOM çš„æ¡¥æ¢ã€‚
- **åˆ©ç”¨ `update` æ–¹æ³•**ï¼šè¿™æ˜¯ React `componentDidUpdate` çš„ CodeMirror ç‰ˆæœ¬ã€‚
- **æ£€æŸ¥ `docChanged` æˆ– `selectionSet`**ï¼šä¸è¦æ¯æ¬¡ update éƒ½é‡ç»˜ï¼Œå…ˆæ£€æŸ¥ flagã€‚

```javascript
import { ViewPlugin } from '@codemirror/view'

const myPlugin = ViewPlugin.fromClass(
  class {
    constructor(view) {
      this.dom = document.createElement('div')
      this.dom.textContent = 'Status: Ready'
      view.dom.appendChild(this.dom) // æŒ‚è½½åˆ°ç¼–è¾‘å™¨ DOM ä¸­
    }

    update(update) {
      // âœ… æœ€ä½³å®è·µï¼šæ€§èƒ½ä¼˜åŒ–ï¼Œåªæœ‰æ–‡æ¡£å˜äº†æ‰æ›´æ–° DOM
      if (update.docChanged) {
        this.dom.textContent = `Length: ${update.state.doc.length}`
      }
    }

    destroy() {
      this.dom.remove() // æ¸…ç†
    }
  }
)
```

### 5. åæ ‡è½¬æ¢ (Positions)

**ç—›ç‚¹ï¼š** é¼ æ ‡ç‚¹å‡»çš„ä½ç½®ï¼ˆx, yï¼‰æ€ä¹ˆè½¬æ¢æˆæ–‡æ¡£é‡Œçš„å­—ç¬¦ä½ç½®ï¼ˆoffsetï¼‰ï¼Ÿ

**æœ€ä½³å®è·µï¼š**

- **ä½¿ç”¨ `view.posAtCoords` å’Œ `view.coordsAtPos`**ã€‚
- **æ³¨æ„ `side` å‚æ•°**ï¼šè¿™å†³å®šäº†å¦‚æœç‚¹å‡»åœ¨å­—ç¬¦çš„å·¦åŠè¾¹è¿˜æ˜¯å³åŠè¾¹æ—¶ï¼Œå…‰æ ‡åº”è¯¥å½’å±å“ªä¸€è¾¹ã€‚

```javascript
// è·å–å…‰æ ‡å½“å‰åœ¨å±å¹•ä¸Šçš„åæ ‡ï¼ˆç”¨äºæ˜¾ç¤ºè‡ªåŠ¨è¡¥å…¨å¼¹çª—ç­‰ï¼‰
const pos = view.state.selection.main.head
const coords = view.coordsAtPos(pos)
// coords = { left: 100, top: 200, bottom: 220, ... }

// æ ¹æ®é¼ æ ‡äº‹ä»¶è·å–æ–‡æ¡£ä½ç½®
document.addEventListener('click', e => {
  const pos = view.posAtCoords({ x: e.clientX, y: e.clientY })
  if (pos !== null) {
    console.log('ç‚¹å‡»äº†æ–‡æ¡£çš„ç¬¬', pos, 'ä¸ªå­—ç¬¦')
  }
})
```

### æ€»ç»“ï¼šå¿ƒæ³•å£è¯€

1.  **æ”¹å†…å®¹**ï¼šç”¨ `dispatch({ changes: [...] })`ï¼Œåˆ«ç›´æ¥æ”¹ã€‚
2.  **è¯»å†…å®¹**ï¼šç”¨ `doc.line(n)` æˆ–è¿­ä»£å™¨ï¼Œåˆ« `toString()` æ•´ä¸ªå¤§æ–‡ä»¶ã€‚
3.  **å­˜çŠ¶æ€**ï¼šç”¨ `StateField`ï¼Œåˆ«ç”¨å…¨å±€å˜é‡ã€‚
4.  **åŠ¨ DOM**ï¼šç”¨ `ViewPlugin`ï¼Œå¹¶åœ¨ `update` é‡Œæ£€æŸ¥ `docChanged`ã€‚
5.  **æ‰¾ä½ç½®**ï¼šç”¨ `posAtCoords` / `coordsAtPos`ã€‚

---

CodeMirror 6 çš„è®¾è®¡å“²å­¦æ˜¯â€œç»„åˆä¼˜äºç»§æ‰¿â€ï¼Œè¿™å¯¼è‡´å®ƒæœ‰å¾ˆå¤šç»†ç²’åº¦çš„æŠ½è±¡æ¦‚å¿µã€‚æ¥ä¸‹æ¥çš„è®²è§£å°†æ·±å…¥è¿™äº›â€œæ·±æ°´åŒºâ€ï¼Œå¸®ä½ å»ºç«‹å®Œæ•´çš„å¿ƒç†æ¨¡å‹ã€‚

### 1. æ·±å…¥æŠ½è±¡ï¼šRangeSet ä¸ Decorator ä½“ç³»

è¿™éƒ¨åˆ†æ˜¯å®ç°è¯­æ³•é«˜äº®ã€æŠ˜å ã€Lint æç¤ºçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚

#### RangeSet (èŒƒå›´é›†åˆ)

- **å®šä¹‰**ï¼š`RangeSet` æ˜¯ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„æ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯ B æ ‘çš„å˜ä½“ï¼‰ï¼Œç”¨äºå­˜å‚¨â€œå¸¦æœ‰ä½ç½®èŒƒå›´çš„å€¼â€ã€‚
- **ä¸ºä»€ä¹ˆéš¾ç†è§£**ï¼šå®ƒä¸æ˜¯æ•°ç»„ã€‚ä½ ä¸èƒ½ç”¨ `index` è®¿é—®ã€‚å®ƒå¿…é¡»å¤„ç†é‡å ã€åµŒå¥—å’Œå·¨å¤§çš„æ–‡æ¡£è·¨åº¦ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - **ä¸è¦æ‰‹åŠ¨æ„å»º**ï¼šæ€»æ˜¯ä½¿ç”¨ `RangeSetBuilder`ã€‚å®ƒè¦æ±‚ä½ æŒ‰é¡ºåºï¼ˆä½ç½®ä»å°åˆ°å¤§ï¼‰æ·»åŠ å…ƒç´ ï¼Œè¿™æ ·æ„å»ºé€Ÿåº¦æå¿«ã€‚
  - **ç”¨é€”**ï¼šä¸»è¦ç”¨äºå­˜å‚¨ `Decoration`ï¼ˆè£…é¥°ï¼‰ï¼Œä½†ä¹Ÿå¯ä»¥å­˜å‚¨ä»»ä½•è‡ªå®šä¹‰æ•°æ®ã€‚
  - **è¿­ä»£**ï¼šä½¿ç”¨ `iter()` æ–¹æ³•è·å–æ¸¸æ ‡ï¼ˆCursorï¼‰æ¥éå†ï¼Œè€Œä¸æ˜¯è½¬æ¢æˆæ•°ç»„ã€‚

#### MatchDecorator (åŒ¹é…è£…é¥°å™¨)

- **å®šä¹‰**ï¼šè¿™æ˜¯ä¸€ä¸ªè¾…åŠ©å·¥å…·ç±»ï¼Œç”¨äºâ€œåŸºäºæ­£åˆ™è¡¨è¾¾å¼è‡ªåŠ¨ç»´æŠ¤è£…é¥°â€ã€‚
- **åœºæ™¯**ï¼šä½ æƒ³é«˜äº®æ‰€æœ‰çš„ `#hashtag` æˆ–è€… `TODO` æ ‡è®°ã€‚
- **å·¥ä½œåŸç†**ï¼šå®ƒä¼šè‡ªåŠ¨ç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œåªé‡æ–°æ‰«æå—å½±å“çš„è¡Œï¼Œå¹¶æ›´æ–° `Decoration`ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - é…åˆ `ViewPlugin` ä½¿ç”¨ã€‚è¿™æ˜¯å®ç°ç®€å•é«˜äº®çš„æœ€å¿«è·¯å¾„ï¼Œä¸éœ€è¦å†™å®Œæ•´çš„ Parserã€‚

```javascript
import { MatchDecorator, ViewPlugin, Decoration } from '@codemirror/view'

// 1. å®šä¹‰è£…é¥°æ ·å¼
const hashtagMark = Decoration.mark({ class: 'cm-hashtag' })

// 2. åˆ›å»ºåŒ¹é…å™¨
const hashtagMatcher = new MatchDecorator({
  regexp: /#\w+/g,
  decoration: match => hashtagMark
})

// 3. å°è£…è¿› ViewPlugin
const hashtagPlugin = ViewPlugin.fromClass(
  class {
    constructor(view) {
      this.decorations = hashtagMatcher.createDeco(view)
    }
    update(update) {
      // è‡ªåŠ¨å¢é‡æ›´æ–°ï¼Œæ€§èƒ½æé«˜
      this.decorations = hashtagMatcher.updateDeco(update, this.decorations)
    }
  },
  {
    decorations: v => v.decorations // å‘Šè¯‰ç¼–è¾‘å™¨è¿™é‡Œæœ‰è£…é¥°è¦æ¸²æŸ“
  }
)
```

### 2. EditorView ä¸Šçš„é™æ€ API (Static APIs)

`EditorView` ä¸ä»…ä»…æ˜¯å®ä¾‹ï¼Œå®ƒçš„ç±»ä¸ŠæŒ‚è½½äº†å¾ˆå¤šç”¨äº**é…ç½®**å’Œ**æ‰©å±•å®šä¹‰**çš„æ–¹æ³•ã€‚

#### `EditorView.theme(spec, options)`

- **ç”¨é€”**ï¼šå®šä¹‰ç¼–è¾‘å™¨çš„ä¸»é¢˜ï¼ˆCSS æ ·å¼ï¼‰ã€‚
- **æ ¸å¿ƒæ¦‚å¿µ**ï¼šCodeMirror çš„æ ·å¼æ˜¯ JS-in-CSS çš„å˜ä½“ã€‚å®ƒä¼šç”Ÿæˆå”¯ä¸€çš„ç±»åï¼Œå®ç°æ ·å¼éš”ç¦»ã€‚
- **ç‰¹æ®Šé€‰æ‹©å™¨**ï¼š`&` ä»£è¡¨ç¼–è¾‘å™¨æ ¹å…ƒç´ ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - åŒºåˆ† `Base Theme` (åº“ä½œè€…ç”¨) å’Œ `Theme` (æœ€ç»ˆç”¨æˆ·ç”¨)ã€‚
  - ä½¿ç”¨ `&.cm-focused` æ¥å®šä¹‰èšç„¦æ—¶çš„æ ·å¼ã€‚

#### `EditorView.domEventHandlers(handlers)`

- **ç”¨é€”**ï¼šè¿™æ˜¯ç›‘å¬ DOM äº‹ä»¶çš„**æ­£ç¡®æ–¹å¼**ã€‚
- **ä¸ºä»€ä¹ˆä¸ç”¨ addEventListener**ï¼šç›´æ¥åœ¨ DOM ä¸Šç›‘å¬å¯èƒ½ä¼šå¹²æ‰° CodeMirror å†…éƒ¨çš„äº‹ä»¶å¤„ç†ï¼ˆå¦‚è¾“å…¥æ³•åˆæˆã€æ‹–æ‹½ï¼‰ã€‚è¿™ä¸ª API å…è®¸ä½ ä»¥â€œæ’ä»¶â€çš„æ–¹å¼æ³¨å†Œäº‹ä»¶ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - è¿”å› `true` è¡¨ç¤ºâ€œæˆ‘å¤„ç†äº†è¿™ä¸ªäº‹ä»¶ï¼ŒCodeMirror ä½ åˆ«ç®¡äº†â€ï¼ˆé˜»æ­¢é»˜è®¤è¡Œä¸ºï¼‰ã€‚
  - è¿”å› `false` è¡¨ç¤ºâ€œæˆ‘åªæ˜¯çœ‹çœ‹ï¼Œç»§ç»­ä¼ é€’â€ã€‚

```javascript
import { EditorView } from '@codemirror/view'

const clickHandler = EditorView.domEventHandlers({
  mousedown(event, view) {
    if (event.altKey) {
      console.log('Alt + Click detected!')
      return true // é˜»æ­¢ç¼–è¾‘å™¨å¤„ç†è¿™ä¸ªç‚¹å‡»ï¼ˆä¾‹å¦‚é˜»æ­¢å…‰æ ‡ç§»åŠ¨ï¼‰
    }
  }
})
```

#### `EditorView.updateListener`

- **ç”¨é€”**ï¼šå…¨å±€çš„â€œè§‚å¯Ÿè€…â€ã€‚
- **æœ€ä½³å®è·µ**ï¼šç”¨äºå‘å¤–éƒ¨æ¡†æ¶ï¼ˆReact/Vueï¼‰åŒæ­¥æ•°æ®ã€‚

### 3. æ·±å…¥ Changeï¼šå¦‚ä½•æ¶ˆè´¹å˜æ›´ (ChangeSet)

å½“ `update.docChanged` ä¸º true æ—¶ï¼Œ`update.changes` æ˜¯ä¸€ä¸ª `ChangeSet` å¯¹è±¡ã€‚ç†è§£å®ƒå¯¹äºååŒç¼–è¾‘ã€æ’¤é”€é‡åšã€æˆ–è€…ä½ç½®æ˜ å°„è‡³å…³é‡è¦ã€‚

#### æ¶ˆè´¹å˜æ›´ (iterChanges)

`ChangeSet` å†…éƒ¨æ˜¯å‹ç¼©å­˜å‚¨çš„ã€‚ä½ ä¸èƒ½ç›´æ¥çœ‹â€œæ”¹äº†ä»€ä¹ˆâ€ï¼Œå¿…é¡»è¿­ä»£å®ƒã€‚

```javascript
// å‡è®¾ç”¨æˆ·æŠŠ "Hello" å˜æˆäº† "He123llo"
// update.changes åŒ…å«äº†è¿™ä¸ªå˜åŒ–

update.changes.iterChanges((fromA, toA, fromB, toB, inserted) => {
  // fromA, toA: å˜åŒ–å‘ç”Ÿå‰ï¼Œåœ¨æ—§æ–‡æ¡£ä¸­çš„èŒƒå›´ (2, 2)
  // fromB, toB: å˜åŒ–å‘ç”Ÿåï¼Œåœ¨æ–°æ–‡æ¡£ä¸­çš„èŒƒå›´ (2, 5)
  // inserted: æ’å…¥çš„æ–‡æœ¬å¯¹è±¡ ("123")

  console.log(`åœ¨æ—§ä½ç½® ${fromA} åˆ é™¤äº† ${toA - fromA} ä¸ªå­—ç¬¦`)
  console.log(`åœ¨æ–°ä½ç½® ${fromB} æ’å…¥äº†: ${inserted.toString()}`)
})
```

#### ä½ç½®æ˜ å°„ (MapPos) - **è¿™æ˜¯æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€**

**åœºæ™¯**ï¼šä½ æœ‰ä¸€ä¸ªæ’ä»¶è®°å½•äº†ç¬¬ 100 ä¸ªå­—ç¬¦å¤„æœ‰ä¸€ä¸ªâ€œé”™è¯¯æç¤ºâ€ã€‚ç”¨æˆ·åœ¨ç¬¬ 0 ä¸ªå­—ç¬¦å¤„æ’å…¥äº† 5 ä¸ªå­—ã€‚ä½ çš„é”™è¯¯æç¤ºç°åœ¨åº”è¯¥åœ¨ç¬¬ 105 ä¸ªå­—ç¬¦å¤„ã€‚
**API**ï¼š`ChangeSet.mapPos(pos)`

```javascript
let myErrorPos = 100

// å½“å‘ç”Ÿ transaction æ—¶
const changes = update.changes
// è‡ªåŠ¨è®¡ç®—æ–°ä½ç½®
myErrorPos = changes.mapPos(myErrorPos)
// å¦‚æœè¯¥ä½ç½®è¢«åˆ é™¤äº†ï¼ŒmapPos é»˜è®¤ä¼šå¸é™„åˆ°åˆ é™¤ç‚¹çš„å·¦ä¾§æˆ–å³ä¾§ï¼ˆå¯é…ç½® assoc å‚æ•°ï¼‰
```

### 4. å…¶ä»–å…³é”®æŠ½è±¡æ¦‚å¿µ

#### Prec (Precedence / ä¼˜å…ˆçº§)

- **é—®é¢˜**ï¼šä½ å®šä¹‰äº† `Enter` é”®çš„å¿«æ·é”®ï¼Œä½†æ²¡ç”Ÿæ•ˆï¼Œå› ä¸ºé»˜è®¤çš„æ¢è¡Œè¡Œä¸ºæŠ¢å…ˆäº†ã€‚
- **è§£å†³**ï¼šCodeMirror çš„æ‰©å±•æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œä½†ä½ å¯ä»¥ç”¨ `Prec` å¼ºåˆ¶æ’é˜Ÿã€‚
- **çº§åˆ«**ï¼š
  - `Prec.highest`: æœ€é«˜ä¼˜å…ˆçº§ï¼ˆæ…ç”¨ï¼‰ã€‚
  - `Prec.high`: é«˜äºé»˜è®¤ã€‚
  - `Prec.default`: é»˜è®¤ã€‚
  - `Prec.low`: ä½äºé»˜è®¤ã€‚

```javascript
import { keymap } from '@codemirror/view'
import { Prec } from '@codemirror/state'

// å¼ºåˆ¶è¦†ç›–é»˜è®¤è¡Œä¸º
const myKeymap = Prec.high(
  keymap.of([
    {
      key: 'Enter',
      run: () => {
        console.log('My Enter!')
        return true
      }
    }
  ])
)
```

#### Selection (EditorSelection)

- **å®šä¹‰**ï¼šCodeMirror 6 åŸç”Ÿæ”¯æŒ**å¤šå…‰æ ‡**ã€‚
- **ç»“æ„**ï¼š
  - `ranges`: æ‰€æœ‰çš„å…‰æ ‡èŒƒå›´æ•°ç»„ã€‚
  - `main`: â€œä¸»â€å…‰æ ‡ï¼ˆé€šå¸¸æ˜¯æœ€åä¸€ä¸ªæ·»åŠ çš„ï¼Œæˆ–è€…ç”¨æˆ·ä¸»è¦å…³æ³¨çš„é‚£ä¸ªï¼‰ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - ç¼–å†™å‘½ä»¤æ—¶ï¼Œæ€»æ˜¯å‡è®¾å¯èƒ½ç”±å¤šä¸ªå…‰æ ‡ã€‚ä½¿ç”¨ `state.changeByRange` è¾…åŠ©å‡½æ•°æ¥å¤„ç†å¤šå…‰æ ‡é€»è¾‘ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®ä½ åˆå¹¶é‡å çš„å˜æ›´ã€‚

```javascript
// å°†é€‰ä¸­çš„æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™çš„å‘½ä»¤ï¼ˆæ”¯æŒå¤šå…‰æ ‡ï¼‰
const upperCaseCommand = view => {
  const transaction = view.state.changeByRange(range => {
    // é’ˆå¯¹æ¯ä¸€ä¸ªå…‰æ ‡èŒƒå›´ range æ‰§è¡Œé€»è¾‘
    const text = view.state.sliceDoc(range.from, range.to)
    const upper = text.toUpperCase()
    return {
      changes: { from: range.from, to: range.to, insert: upper },
      range: EditorSelection.range(range.from, range.from + upper.length) // æ–°çš„å…‰æ ‡ä½ç½®
    }
  })
  view.dispatch(transaction)
  return true
}
```

### æ€»ç»“å›¾è°±

1.  **æ•°æ®ç»“æ„å±‚**ï¼š`RangeSet` (å­˜å‚¨), `ChangeSet` (å˜æ›´), `EditorSelection` (å…‰æ ‡)ã€‚
2.  **é€»è¾‘å±‚**ï¼š`StateField` (çŠ¶æ€), `Facet` (é…ç½®èšåˆ), `Prec` (ä¼˜å…ˆçº§)ã€‚
3.  **è¡¨ç°å±‚**ï¼š`Decoration` (è£…é¥°), `ViewPlugin` (DOM äº¤äº’), `MatchDecorator` (æ­£åˆ™é«˜äº®)ã€‚

æŒæ¡ `mapPos` å’Œ `iterChanges` æ˜¯ä»â€œä½¿ç”¨è€…â€è¿›é˜¶åˆ°â€œå¼€å‘è€…â€çš„åˆ†æ°´å²­ã€‚

---

æ—¢ç„¶è¦â€œæ·±æŒ–â€ï¼Œæˆ‘ä»¬å°±ä¸èƒ½åªåœç•™åœ¨ API çš„è¡¨é¢è°ƒç”¨ä¸Šï¼Œè€Œè¦è¿›å…¥ CodeMirror 6 çš„**æ¶æ„æ ¸å¿ƒ**å’Œ**é«˜çº§å®šåˆ¶**é¢†åŸŸã€‚

ä»¥ä¸‹æ˜¯ 4 ä¸ªæ›´æ·±å±‚æ¬¡çš„æ¦‚å¿µï¼Œé€šå¸¸åªæœ‰åœ¨å¼€å‘å¤æ‚ IDE åŠŸèƒ½ï¼ˆå¦‚ä»£ç è¡¥å…¨ã€ååŒç¼–è¾‘ã€è‡ªå®šä¹‰è¯­è¨€æ”¯æŒï¼‰æ—¶æ‰ä¼šæ¥è§¦åˆ°ã€‚

---

### 1. è¯­æ³•æ ‘ä¸ Lezer é›†æˆ (The Syntax Tree)

CodeMirror 6 æŠ›å¼ƒäº†åŸºäºæ­£åˆ™çš„ç®€å•é«˜äº®ï¼Œå¼•å…¥äº† **Lezer** è§£æå™¨ã€‚è¿™æ„å‘³ç€ç¼–è¾‘å™¨æ—¶åˆ»ç»´æŠ¤ç€ä¸€ä»½å½“å‰ä»£ç çš„ **CST (Concrete Syntax Treeï¼Œå…·ä½“è¯­æ³•æ ‘)**ã€‚

#### æ ¸å¿ƒæ¦‚å¿µï¼š`syntaxTree(state)`

ä½ ä¸å†éœ€è¦è‡ªå·±å†™æ­£åˆ™å»åŒ¹é…â€œå‡½æ•°åâ€æˆ–â€œå˜é‡â€ï¼Œä½ å¯ä»¥ç›´æ¥é—®è¯­æ³•æ ‘ã€‚

**æœ€ä½³å®è·µï¼š**

- **ä¸è¦éå†æ•´ä¸ªæ ‘**ï¼šæ ‘å¯èƒ½å¾ˆå¤§ã€‚ä½¿ç”¨ `Cursor`ï¼ˆæ¸¸æ ‡ï¼‰æ¥éå†ã€‚
- **å¤„ç†ä¸å®Œæ•´æ ‘**ï¼šè§£ææ˜¯å¢é‡çš„ã€å¼‚æ­¥çš„ã€‚åœ¨è§†å£ï¼ˆViewportï¼‰å†…çš„æ ‘é€šå¸¸æ˜¯å‡†å¤‡å¥½çš„ï¼Œä½†æ–‡ä»¶æœ«å°¾çš„å¯èƒ½è¿˜æ²¡è§£æå®Œã€‚

**ä»£ç ç¤ºä¾‹ï¼šæ‰¾åˆ°å…‰æ ‡æ‰€åœ¨çš„æ‰€æœ‰çˆ¶çº§èŠ‚ç‚¹ç±»å‹**

```javascript
import { syntaxTree } from '@codemirror/language'

function getContext(state) {
  const pos = state.selection.main.head
  // è·å–è¯­æ³•æ ‘
  const tree = syntaxTree(state)
  // resolveInner ç”¨äºæ·±å…¥åˆ°æœ€å…·ä½“çš„èŠ‚ç‚¹
  let node = tree.resolveInner(pos, -1)

  const path = []
  while (node) {
    path.push(node.name) // ä¾‹å¦‚: "Identifier", "FunctionDeclaration", "Script"
    node = node.parent
  }
  return path
}
```

**æ·±æŒ–ç‚¹**ï¼šåˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œä½ å¯ä»¥å®ç°â€œæ™ºèƒ½â€çš„å¿«æ·é”®ã€‚ä¾‹å¦‚ï¼šåªæœ‰åœ¨ `Comment` èŠ‚ç‚¹å†…æŒ‰å›è½¦ï¼Œæ‰è‡ªåŠ¨æ’å…¥æ³¨é‡Šç¬¦å·ã€‚

---

### 2. WidgetType ä¸ DOM åè°ƒ (Reconciliation)

å½“ä½ éœ€è¦åœ¨æ–‡æ¡£æµä¸­æ’å…¥å¤æ‚çš„ DOMï¼ˆæ¯”å¦‚ï¼šé¢œè‰²é€‰æ‹©å™¨è‰²å—ã€æŠ˜å åçš„ `...` æŒ‰é’®ã€æˆ–è€…åµŒå…¥çš„è¡¨æ ¼ï¼‰æ—¶ï¼Œä½ éœ€è¦ä½¿ç”¨ `WidgetDecoration`ã€‚

**éš¾ç‚¹**ï¼šCodeMirror å¦‚ä½•çŸ¥é“ä½ çš„ DOM å…ƒç´ æ˜¯å¦éœ€è¦æ›´æ–°ï¼Ÿå¦‚æœæ¯æ¬¡éƒ½é”€æ¯é‡å»ºï¼Œè¾“å…¥ä¼šéå¸¸å¡é¡¿ã€‚

**æ ¸å¿ƒç±»ï¼š`WidgetType`**
ä½ å¿…é¡»ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå¹¶å®ç°ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼š`toDOM` å’Œ `eq`ã€‚

**æœ€ä½³å®è·µï¼š**

- **`eq(other)` æ˜¯æ€§èƒ½çš„å…³é”®**ï¼šCodeMirror ä¼šæ¯”è¾ƒæ–°æ—§ Widgetã€‚å¦‚æœ `eq` è¿”å› `true`ï¼Œå®ƒä¼šç›´æ¥å¤ç”¨æ—§çš„ DOMï¼Œå®Œå…¨è·³è¿‡æ¸²æŸ“ã€‚
- **`updateDOM` (å¯é€‰)**ï¼šå¦‚æœä½ æƒ³å¤ç”¨ DOM ä½†åªä¿®æ”¹å…¶ä¸­ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚æ”¹ä¸ªèƒŒæ™¯è‰²ï¼‰ï¼Œå®ç°è¿™ä¸ªæ–¹æ³•ã€‚

```javascript
import { WidgetType, Decoration } from '@codemirror/view'

class ColorWidget extends WidgetType {
  constructor(color) {
    super()
    this.color = color
  }

  // 1. æ¯”è¾ƒï¼šå†³å®šæ˜¯å¦å¤ç”¨ DOM
  eq(other) {
    return other.color === this.color
  }

  // 2. åˆ›å»ºï¼šåˆæ¬¡æ¸²æŸ“
  toDOM() {
    let span = document.createElement('span')
    span.style.backgroundColor = this.color
    span.className = 'color-box'
    return span
  }

  // 3. å¿½ç•¥äº‹ä»¶ï¼šé€šå¸¸è®¾ä¸º trueï¼Œé˜²æ­¢ç¼–è¾‘å™¨æŠŠå…‰æ ‡æ”¾è¿›ä½ çš„ Widget é‡Œ
  ignoreEvent() {
    return true
  }
}

// ä½¿ç”¨
const deco = Decoration.widget({
  widget: new ColorWidget('red'),
  side: 1
})
```

---

### 3. Transaction Annotations & Effects (å…ƒæ•°æ®ä¸å‰¯ä½œç”¨)

`Transaction` ä¸ä»…ä»…åŒ…å«æ–‡æ¡£å˜åŒ–ï¼ˆChangesï¼‰ï¼Œå®ƒè¿˜æ˜¯ä¸€ä¸ª**æ¶ˆæ¯æ€»çº¿**ã€‚

#### Annotations (æ³¨è§£)

**åœºæ™¯**ï¼šä½ éœ€è¦åŒºåˆ†è¿™ä¸ªå˜åŒ–æ˜¯â€œç”¨æˆ·è¾“å…¥çš„â€è¿˜æ˜¯â€œååŒç¼–è¾‘æ’ä»¶ä»ç½‘ç»œåŒæ­¥è¿‡æ¥çš„â€ï¼Ÿæˆ–è€…æ˜¯â€œæ’¤é”€æ“ä½œäº§ç”Ÿçš„â€ï¼Ÿ
**å®šä¹‰**ï¼š`Annotation` æ˜¯é™„åŠ åœ¨ Transaction ä¸Šçš„å…ƒæ•°æ®ï¼Œä¸ä¼šæ”¹å˜ Stateï¼Œä½†èƒ½è¢« ViewPlugin è¯»å–ã€‚

```javascript
import { Annotation } from '@codemirror/state'

// å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»å‹
const RemoteChange = Annotation.define()

// å‘é€ Transaction æ—¶å¸¦ä¸Šæ³¨è§£
view.dispatch({
  changes: { from: 0, insert: 'Hi' },
  annotations: RemoteChange.of('user-123') // æ ‡è®°æ¥æº
})

// åœ¨ ViewPlugin æˆ– UpdateListener ä¸­æ¶ˆè´¹
if (tr.annotation(RemoteChange)) {
  console.log('è¿™æ˜¯è¿œç¨‹å˜åŒ–ï¼Œä¸è¦è§¦å‘è‡ªåŠ¨è¡¥å…¨ï¼')
}
```

#### Effects (å‰¯ä½œç”¨)

**åœºæ™¯**ï¼šä½ æƒ³é€šè¿‡ Transaction è§¦å‘ä¸€äº›éæ–‡æ¡£çš„å˜æ›´ï¼Œæ¯”å¦‚â€œæŠ˜å ç¬¬ 10 è¡Œâ€æˆ–â€œå±•å¼€æ‰€æœ‰åŒºåŸŸâ€ã€‚
**å®šä¹‰**ï¼š`StateEffect` ç”¨äºæ›´æ–° `StateField`ã€‚å®ƒæ˜¯ State å˜æ›´çš„æœ€å°å•å…ƒã€‚

**æ·±æŒ–ç‚¹**ï¼šCodeMirror çš„æŠ˜å ï¼ˆFoldingï¼‰åŠŸèƒ½å°±æ˜¯å®Œå…¨åŸºäº `StateEffect` å®ç°çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œ DOMã€‚

---

### 4. Atomic Ranges (åŸå­èŒƒå›´)

**åœºæ™¯**ï¼šä½ åœ¨ç¼–è¾‘å™¨é‡Œæ’å…¥äº†ä¸€ä¸ª `@User` æ ‡ç­¾ã€‚ä½ å¸Œæœ›ç”¨æˆ·æŒ‰é€€æ ¼é”®æ—¶ï¼Œæ•´ä¸ªæ ‡ç­¾è¢«ä¸€æ¬¡æ€§åˆ é™¤ï¼Œè€Œä¸æ˜¯åˆ æ‰æœ€åä¸€ä¸ªå­—æ¯ã€‚ä½ ä¹Ÿä¸å¸Œæœ›å…‰æ ‡èƒ½åœåœ¨ `@` å’Œ `U` ä¹‹é—´ã€‚

**è§£å†³æ–¹æ¡ˆï¼š`EditorView.atomicRanges`**

è¿™æ˜¯ä¸€ä¸ª Facetï¼Œå…è®¸ä½ å®šä¹‰æ–‡æ¡£ä¸­çš„æŸäº›èŒƒå›´æ˜¯â€œåŸå­çš„â€ï¼ˆAtomicï¼‰ã€‚

**æœ€ä½³å®è·µï¼š**

- é€šå¸¸é…åˆ `Decoration.replace` ä½¿ç”¨ã€‚
- å½“å…‰æ ‡è¯•å›¾è¿›å…¥åŸå­èŒƒå›´æ—¶ï¼ŒCodeMirror ä¼šè‡ªåŠ¨æŠŠå®ƒå¼¹å°„åˆ°èŒƒå›´çš„è¾¹ç¼˜ã€‚

```javascript
import { EditorView } from '@codemirror/view'
import { RangeSetBuilder } from '@codemirror/state'

const atomicPlugin = EditorView.atomicRanges.of(view => {
  // å‡è®¾æˆ‘ä»¬æƒ³è®©æ–‡æ¡£ä¸­æ‰€æœ‰çš„ "[LOCKED]" å­—ç¬¦ä¸²ä¸å¯è¿›å…¥
  let ranges = new RangeSetBuilder()
  // ... éå†æ–‡æ¡£æ‰¾åˆ°ä½ç½® ...
  // ranges.add(from, to);
  return ranges.finish()
})
```

---

### 5. ç»ˆææ·±æŒ–ï¼šè‡ªå®šä¹‰ Facet çš„ç»„åˆé€»è¾‘

è¿™æ˜¯æ¶æ„å¸ˆçº§åˆ«çš„è§†è§’ã€‚å½“ä½ å®šä¹‰ä¸€ä¸ª `Facet` æ—¶ï¼Œä½ éœ€è¦å†³å®š**å¤šä¸ªæ’ä»¶æä¾›çš„å€¼å¦‚ä½•åˆå¹¶**ã€‚

`Facet.define({ combine: ... })`

- **é»˜è®¤è¡Œä¸º**ï¼šè¿”å›æ•°ç»„ `[value1, value2]`ã€‚
- **é€»è¾‘ä¸/æˆ–**ï¼šæ¯”å¦‚ `EditorView.editable`ï¼Œåªè¦æœ‰ä¸€ä¸ªæ’ä»¶è¯´ `false`ï¼Œç¼–è¾‘å™¨å°±ä¸å¯ç¼–è¾‘ã€‚å®ƒçš„ combine é€»è¾‘å°±æ˜¯ `values => values.every(x => x)`ã€‚
- **ä¼˜å…ˆçº§è¦†ç›–**ï¼šæ¯”å¦‚å¿«æ·é”® `keymap`ï¼Œå®ƒçš„ combine é€»è¾‘æ˜¯æŒ‰ä¼˜å…ˆçº§é¡ºåºå±•å¹³æ•°ç»„ã€‚

**ç†è§£è¿™ä¸€ç‚¹ï¼Œä½ å°±èƒ½æ˜ç™½ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä½ çš„é…ç½®ä¸ç”Ÿæ•ˆâ€”â€”å¯èƒ½æ˜¯è¢«å…¶ä»–é«˜ä¼˜å…ˆçº§çš„ Facet è¦†ç›–äº†ï¼Œæˆ–è€…åˆå¹¶é€»è¾‘ä¸æ˜¯ä½ æƒ³è±¡çš„é‚£æ ·ã€‚**

### æ€»ç»“ï¼šCodeMirror 6 çš„å¿ƒæ™ºæ¨¡å‹

å¦‚æœä½ æƒ³ç²¾é€š CodeMirror 6ï¼Œè¯·æŠŠç¼–è¾‘å™¨æƒ³è±¡æˆä¸€ä¸ª **React + Redux** çš„åº”ç”¨ï¼š

1.  **State** æ˜¯ Redux Storeï¼ˆä¸å¯å˜æ•°æ®ï¼‰ã€‚
2.  **View** æ˜¯ React Componentï¼ˆè´Ÿè´£æ¸²æŸ“ï¼‰ã€‚
3.  **Transaction** æ˜¯ Actionï¼ˆæè¿°å˜åŒ–ï¼‰ã€‚
4.  **StateField** æ˜¯ Reducerï¼ˆå¤„ç†é€»è¾‘ï¼‰ã€‚
5.  **Facet** æ˜¯ Contextï¼ˆä¾èµ–æ³¨å…¥ï¼‰ã€‚
6.  **WidgetType** æ˜¯ React.memoï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ã€‚

---

åœ¨ React ä¸­å°è£… CodeMirror 6 æ˜¯ä¸€ä¸ªç»å…¸çš„æŒ‘æˆ˜ï¼Œå› ä¸ºä½ éœ€è¦åè°ƒ **React çš„å£°æ˜å¼ç”Ÿå‘½å‘¨æœŸ** ä¸ **CodeMirror çš„å‘½ä»¤å¼ç”Ÿå‘½å‘¨æœŸ**ã€‚

å¦‚æœä¸éµå¾ªæœ€ä½³å®è·µï¼Œå¾ˆå®¹æ˜“é‡åˆ°ï¼šå…‰æ ‡è·³åŠ¨ã€æ­»å¾ªç¯æ›´æ–°ã€æ€§èƒ½ä½ä¸‹ã€å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚

ä»¥ä¸‹æ˜¯æ„å»º `useCodeMirror` å’Œç»„ä»¶çš„**å·¥ä¸šçº§æœ€ä½³å®è·µ**ã€‚

### æ ¸å¿ƒæ¶æ„å›¾

1.  **åˆå§‹åŒ–**ï¼š`useEffect` + `useRef` æŒ‚è½½ DOMã€‚
2.  **æ•°æ®æµå‡º (CM -> React)**ï¼šé€šè¿‡ `EditorView.updateListener` æ•è·å˜åŒ– -> è°ƒç”¨ `onChange`ã€‚
3.  **æ•°æ®æµå…¥ (React -> CM)**ï¼š`useEffect` ç›‘å¬ `props.value` -> **æ¯”å¯¹å·®å¼‚** -> `view.dispatch`ã€‚
4.  **é…ç½®æ›´æ–°**ï¼šä½¿ç”¨ `Compartment` (éš”é—´) æˆ– `StateEffect.reconfigure` åŠ¨æ€æ›´æ–°æ‰©å±•ï¼Œè€Œä¸æ˜¯é”€æ¯é‡å»ºã€‚

---

### 1. å®ç° `useCodeMirror` Hook

è¿™æ˜¯æ ¸å¿ƒé€»è¾‘ã€‚

```typescript
import { useEffect, useState, useRef } from 'react'
import { EditorState, Extension } from '@codemirror/state'
import { EditorView, ViewUpdate } from '@codemirror/view'
import { basicSetup } from 'codemirror' // æˆ– @codemirror/basic-setup

interface UseCodeMirrorProps {
  container: HTMLDivElement | null
  value: string
  onChange?: (value: string, viewUpdate: ViewUpdate) => void
  extensions?: Extension[]
  autoFocus?: boolean
  theme?: Extension // å•ç‹¬ä¼ å…¥ä¸»é¢˜ä»¥ä¾¿åŠ¨æ€åˆ‡æ¢
}

export function useCodeMirror(props: UseCodeMirrorProps) {
  const { container, value, onChange, extensions = [], autoFocus, theme } = props

  // å­˜å‚¨ view å®ä¾‹ï¼Œä½†ä¸è§¦å‘é‡æ¸²æŸ“
  const viewRef = useRef<EditorView | null>(null)
  // å­˜å‚¨å½“å‰çš„æ‰©å±•é…ç½®ï¼Œç”¨äºåç»­å¯¹æ¯”æˆ–é‡é…ç½®
  const [view, setView] = useState<EditorView | null>(null)

  // 1. åˆå§‹åŒ–ç¼–è¾‘å™¨
  useEffect(() => {
    if (!container) return

    // åˆå§‹çŠ¶æ€
    const startState = EditorState.create({
      doc: value,
      extensions: [
        basicSetup,
        // å…³é”®ï¼šç»‘å®š Update Listener
        EditorView.updateListener.of(update => {
          if (update.docChanged && onChange) {
            // åªæœ‰æ–‡æ¡£çœŸæ­£å˜äº†æ‰é€šçŸ¥ React
            const docString = update.state.doc.toString()
            onChange(docString, update)
          }
        }),
        ...extensions,
        theme ? theme : []
      ]
    })

    const view = new EditorView({
      state: startState,
      parent: container
    })

    viewRef.current = view
    setView(view)

    if (autoFocus) {
      view.focus()
    }

    // é”€æ¯æ¸…ç†
    return () => {
      view.destroy()
      viewRef.current = null
    }
    // æ³¨æ„ï¼šä¾èµ–é¡¹å°½é‡å°‘ï¼Œé¿å…é‡å¤é”€æ¯é‡å»º
    // è¿™é‡Œæˆ‘ä»¬åªåœ¨ container å˜åŒ–æ—¶åˆå§‹åŒ–ä¸€æ¬¡
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [container])

  // 2. å¤„ç†å¤–éƒ¨ Value å˜åŒ– (React -> CM)
  useEffect(() => {
    const view = viewRef.current
    if (!view) return

    const currentValue = view.state.doc.toString()

    // æ ¸å¿ƒæœ€ä½³å®è·µï¼šLoop Breaker (å¾ªç¯é˜»æ–­)
    // åªæœ‰å½“ä¼ å…¥çš„ value å’Œç¼–è¾‘å™¨å½“å‰å†…å®¹ä¸ä¸€è‡´æ—¶ï¼Œæ‰ dispatch
    // è¿™é˜²æ­¢äº†ï¼šè¾“å…¥ 'a' -> onChange -> setState('a') -> prop update 'a' -> dispatch -> å…‰æ ‡é‡ç½®
    if (value !== currentValue) {
      view.dispatch({
        changes: { from: 0, to: currentValue.length, insert: value || '' }
      })
    }
  }, [value])

  // 3. å¤„ç†åŠ¨æ€æ‰©å±•æ›´æ–° (é«˜çº§æœ€ä½³å®è·µ)
  // å¦‚æœ extensions ç»å¸¸å˜ï¼Œå»ºè®®ä½¿ç”¨ Compartmentï¼Œè¿™é‡Œæ¼”ç¤ºç®€å•çš„ reconfigure
  useEffect(() => {
    const view = viewRef.current
    if (!view) return

    // æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–çš„é‡é…ç½®ã€‚
    // ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ åº”è¯¥ä½¿ç”¨ Compartment æ¥éš”ç¦» Themeã€Language ç­‰
    // é¿å…æ¯æ¬¡ props å˜äº†éƒ½å…¨é‡é‡ç½®æ‰©å±•
    /* 
       view.dispatch({
         effects: StateEffect.reconfigure.of([...extensions, theme])
       })
    */
  }, [extensions, theme])

  return { view }
}
```

---

### 2. å®ç° React ç»„ä»¶

ç»„ä»¶å±‚ä¸»è¦è´Ÿè´£æä¾› DOM å®¹å™¨ã€‚

```tsx
import React, { useRef, useEffect } from 'react'
import { useCodeMirror } from './useCodeMirror'
import { javascript } from '@codemirror/lang-javascript'

export const CodeEditor = ({ value, onChange }) => {
  const ref = useRef<HTMLDivElement>(null)

  const { view } = useCodeMirror({
    container: ref.current,
    value,
    onChange,
    extensions: [javascript()], // ä¼ å…¥è¯­è¨€åŒ…
    theme: undefined // ä¼ å…¥ä¸»é¢˜
  })

  return <div ref={ref} style={{ height: '100%', width: '100%', textAlign: 'left' }} />
}
```

---

### 3. å…³é”®æœ€ä½³å®è·µè§£æ (å¿…è¯»)

#### A. è§£å†³â€œå…‰æ ‡è·³åŠ¨â€ä¸â€œæ­»å¾ªç¯â€

è¿™æ˜¯æ–°æ‰‹æœ€å®¹æ˜“è¸©çš„å‘ã€‚

- **ç°è±¡**ï¼šä½ åœ¨æ‰“å­—ï¼Œæ¯æ¬¡æ‰“ä¸€ä¸ªå­—ï¼Œå…‰æ ‡å°±è·³å›æ–‡æ¡£å¼€å¤´ï¼Œæˆ–è€… React æŠ¥é”™ "Too many re-renders"ã€‚
- **åŸå› **ï¼šReact æ›´æ–° `value` prop -> `useEffect` è§¦å‘ -> `view.dispatch` æ›¿æ¢å…¨æ–‡ -> CodeMirror è®¤ä¸ºè¿™æ˜¯å…¨æ–°çš„å†…å®¹ -> å…‰æ ‡é‡ç½®ã€‚
- **è§£æ³•**ï¼šåœ¨ `useEffect` ä¸­å¿…é¡»åŠ åˆ¤æ–­ `if (value !== currentValue)`ã€‚åªæœ‰å½“å¤–éƒ¨ä¼ å…¥çš„å€¼çœŸçš„å’Œç¼–è¾‘å™¨å†…éƒ¨ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚é‡ç½®è¡¨å•ã€åŠ è½½æ–°æ–‡ä»¶ï¼‰æ—¶ï¼Œæ‰å†™å…¥ã€‚

#### B. åŠ¨æ€é…ç½® (Compartment)

å¦‚æœä½ éœ€è¦åŠ¨æ€åˆ‡æ¢ä¸»é¢˜ï¼ˆLight/Darkï¼‰æˆ–è¯­è¨€ï¼ˆJS/Pythonï¼‰ï¼Œä¸è¦é”€æ¯é‡å»º Viewï¼Œä¹Ÿä¸è¦æš´åŠ› `reconfigure` æ‰€æœ‰æ‰©å±•ã€‚
**æœ€ä½³å®è·µæ˜¯ä½¿ç”¨ `Compartment`**ã€‚

```typescript
import { Compartment } from '@codemirror/state'

// 1. åˆ›å»ºéš”é—´
const languageConf = new Compartment()
const themeConf = new Compartment()

// 2. åˆå§‹åŒ–æ—¶æ”¾å…¥éš”é—´
const state = EditorState.create({
  extensions: [
    languageConf.of(javascript()), // åˆå§‹è¯­è¨€
    themeConf.of(oneDark) // åˆå§‹ä¸»é¢˜
  ]
})

// 3. åŠ¨æ€æ›´æ–°æ—¶ (åœ¨ useEffect ä¸­)
view.dispatch({
  effects: [
    languageConf.reconfigure(python()), // åªæ›¿æ¢è¯­è¨€éƒ¨åˆ†
    themeConf.reconfigure(myLightTheme) // åªæ›¿æ¢ä¸»é¢˜éƒ¨åˆ†
  ]
})
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š**ç¼–è¾‘å™¨çš„æ’¤é”€å†å²(Undo History)ã€æ»šåŠ¨ä½ç½®ã€æŠ˜å çŠ¶æ€éƒ½ä¼šè¢«ä¿ç•™**ã€‚

#### C. æ‰©å±•å¼•ç”¨çš„ç¨³å®šæ€§

åœ¨ React ç»„ä»¶ä¸­ï¼š

```javascript
// âŒ é”™è¯¯ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½ç”Ÿæˆæ–°æ•°ç»„
<CodeEditor extensions={[javascript()]} />
```

è¿™ä¼šå¯¼è‡´ `useCodeMirror` é‡Œçš„ `useEffect` ä¾èµ–é¡¹å˜åŒ–ï¼Œå¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡é…ç½®ã€‚
**å»ºè®®**ï¼šä½¿ç”¨ `useMemo` ç¼“å­˜æ‰©å±•æ•°ç»„ï¼Œæˆ–è€…å°†é™æ€æ‰©å±•å®šä¹‰åœ¨ç»„ä»¶å¤–éƒ¨ã€‚

#### D. CSS å¸ƒå±€

CodeMirror é»˜è®¤é«˜åº¦æ˜¯ `auto`ï¼ˆéšå†…å®¹å¢é•¿ï¼‰ã€‚å¦‚æœä½ å¸Œæœ›å®ƒæ’‘æ»¡çˆ¶å®¹å™¨å¹¶æ»šåŠ¨ï¼š

1.  ç»™çˆ¶å®¹å™¨å®šé«˜ã€‚
2.  è®¾ç½® CodeMirror æ ·å¼ï¼š

```css
.cm-editor {
  height: 100%;
}
.cm-scroller {
  overflow: auto;
}
```

### æ€»ç»“

åšä¸€ä¸ªå¥½çš„ `react-codemirror` å°è£…ï¼Œæ ¸å¿ƒåœ¨äºï¼š

1.  **Ref ç®¡ç†**ï¼šç¡®ä¿ DOM æŒ‚è½½åå†åˆå§‹åŒ–ã€‚
2.  **Diff æ£€æŸ¥**ï¼šå†™å…¥ Value å‰å…ˆæ£€æŸ¥æ˜¯å¦ç›¸ç­‰ï¼Œä¿æŠ¤å…‰æ ‡ã€‚
3.  **Compartment**ï¼šç”¨éš”é—´æŠ€æœ¯åšåŠ¨æ€é…ç½®ï¼Œä¿ç•™ç¼–è¾‘å™¨çŠ¶æ€ã€‚
4.  **é”€æ¯**ï¼šç»„ä»¶å¸è½½æ—¶å¿…é¡» `view.destroy()`ï¼Œå¦åˆ™ä¼šæœ‰å†…å­˜æ³„æ¼ï¼ˆå…¨å±€äº‹ä»¶ç›‘å¬å™¨æœªç§»é™¤ï¼‰ã€‚

---

CodeMirror (ç‰¹åˆ«æ˜¯ v6) è™½ç„¶å¼ºå¤§ï¼Œä½†å› ä¸ºè®¾è®¡ç†å¿µå¤ªè¶…å‰ï¼ˆçº¯å‡½æ•°å¼ã€ä¸å¯å˜æ•°æ®ï¼‰ï¼Œå¯¼è‡´æœ‰å¾ˆå¤šâ€œåç›´è§‰â€çš„å‘ã€‚

ä»¥ä¸‹æ˜¯å¼€å‘è€…ç¤¾åŒºé‡Œæœ€å¸¸é‡åˆ°çš„â€œæœˆç»é—®é¢˜â€ï¼ˆRecurring Issuesï¼‰å’Œç»å…¸å‘ï¼š

### 1. æ ·å¼å‘ï¼šç¼–è¾‘å™¨é«˜åº¦ä¸º 0 æˆ–æ— é™å¢é•¿

**ç°è±¡ï¼š**

- ç¼–è¾‘å™¨æ¸²æŸ“å‡ºæ¥äº†ï¼Œä½†é«˜åº¦åªæœ‰ä¸€è¡Œï¼Œæˆ–è€…æ ¹æœ¬çœ‹ä¸è§ã€‚
- æˆ–è€…ç¼–è¾‘å™¨éšç€å†…å®¹å¢åŠ æ— é™å˜é•¿ï¼Œå¯¼è‡´é¡µé¢æ»šåŠ¨æ¡å’Œç¼–è¾‘å™¨æ»šåŠ¨æ¡åŒé‡å‡ºç°ã€‚

**åŸå› ï¼š**
CodeMirror é»˜è®¤è¡Œä¸ºæ˜¯ `height: auto`ï¼ˆéšå†…å®¹æ’‘å¼€ï¼‰ã€‚å®ƒä¸åƒ `textarea` é‚£æ ·æœ‰ä¸ªé»˜è®¤è¡Œé«˜ã€‚

**æœ€ä½³å®è·µï¼š**
å¿…é¡»æ˜¾å¼è®¾ç½® CSSã€‚

```css
/* æ–¹æ¡ˆ A: å›ºå®šé«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
.cm-editor {
  height: 500px; /* æˆ–è€… 100% ç»§æ‰¿çˆ¶å®¹å™¨ */
}
.cm-scroller {
  overflow: auto;
}

/* æ–¹æ¡ˆ B: æœ€å°/æœ€å¤§é«˜åº¦ */
.cm-editor {
  min-height: 200px;
  max-height: 800px;
}
```

### 2. äº¤äº’å‘ï¼šTab é”®æ— æ³•ç¼©è¿› (Focus Trap)

**ç°è±¡ï¼š**
æŒ‰ä¸‹ `Tab` é”®ï¼Œå…‰æ ‡æ²¡æœ‰ç¼©è¿›ï¼Œè€Œæ˜¯ç›´æ¥è·³å‡ºäº†ç¼–è¾‘å™¨ï¼Œèšç„¦åˆ°äº†é¡µé¢ä¸Šä¸‹ä¸€ä¸ªæŒ‰é’®ä¸Šã€‚

**åŸå› ï¼š**
è¿™æ˜¯ä¸ºäº†ç¬¦åˆ **WAI-ARIA æ— éšœç¢æ ‡å‡†**ã€‚ç½‘é¡µä¸Šçš„æ ‡å‡†è¡Œä¸ºæ˜¯ `Tab` åˆ‡æ¢ç„¦ç‚¹ã€‚CodeMirror é»˜è®¤ä¿ç•™äº†è¿™ä¸ªè¡Œä¸ºã€‚

**æœ€ä½³å®è·µï¼š**
å¦‚æœä½ å†™çš„æ˜¯ä»£ç ç¼–è¾‘å™¨ï¼Œå¿…é¡»æ‰‹åŠ¨ç»‘å®š Tab é”®è¡Œä¸ºã€‚

```javascript
import { keymap } from '@codemirror/view'
import { indentWithTab } from '@codemirror/commands'

const extensions = [
  keymap.of([indentWithTab]) // åŠ ä¸Šè¿™ä¸ª
  // ...å…¶ä»–æ‰©å±•
]
```

### 3. ç¯å¢ƒå‘ï¼šSSR (Next.js/Nuxt) æŠ¥é”™ `document is not defined`

**ç°è±¡ï¼š**
åœ¨ Next.js æˆ– Nuxt ä¸­å¼•å…¥ CodeMirrorï¼Œé¡µé¢åˆ·æ–°ç›´æ¥ç™½å±æŠ¥é”™ã€‚

**åŸå› ï¼š**
CodeMirror çš„æ ¸å¿ƒåŒ…åœ¨ import æ—¶ä¼šç«‹å³å°è¯•è®¿é—® `document` æˆ– `navigator` æ¥æ£€æµ‹ç¯å¢ƒï¼ˆæ¯”å¦‚æ£€æµ‹æ˜¯ä¸æ˜¯ Mac ä»¥å†³å®šç”¨ Cmd è¿˜æ˜¯ Ctrlï¼‰ã€‚æœåŠ¡ç«¯æ²¡æœ‰è¿™äº›å¯¹è±¡ã€‚

**æœ€ä½³å®è·µï¼š**

1.  **åŠ¨æ€å¼•å…¥ (Dynamic Import)**ï¼šç¡®ä¿åªåœ¨å®¢æˆ·ç«¯åŠ è½½ã€‚
2.  **æ£€æŸ¥ç¯å¢ƒ**ï¼š

```javascript
// React/Next.js ç¤ºä¾‹
import dynamic from 'next/dynamic'

const CodeEditor = dynamic(
  () => import('./MyEditorComponent'),
  { ssr: false } // ç¦ç”¨ SSR
)
```

### 4. æ•°æ®å‘ï¼šæ¢è¡Œç¬¦çš„â€œçµå¼‚äº‹ä»¶â€ (`\r\n` vs `\n`)

**ç°è±¡ï¼š**
åç«¯ä¼ æ¥çš„å­—ç¬¦ä¸²é•¿åº¦æ˜¯ 100ï¼Œæ”¾å…¥ CodeMirror åï¼Œè·å–å‡ºæ¥çš„é•¿åº¦å˜æˆäº† 98ã€‚æˆ–è€…æ­£åˆ™åŒ¹é…ä½ç½®æ€»æ˜¯å·®å‡ ä¸ªå­—ç¬¦ã€‚

**åŸå› ï¼š**
CodeMirror v6 ä¼šå¼ºåˆ¶å°†æ‰€æœ‰çš„æ¢è¡Œç¬¦è§„èŒƒåŒ–ä¸º `\n` (LF)ã€‚
å¦‚æœä½ çš„åŸå§‹æ•°æ®åŒ…å« Windows é£æ ¼çš„ `\r\n` (CRLF)ï¼ŒCodeMirror ä¼šæŠŠå®ƒä»¬å˜æˆ `\n`ã€‚

- `\r\n` æ˜¯ 2 ä¸ªå­—ç¬¦ã€‚
- `\n` æ˜¯ 1 ä¸ªå­—ç¬¦ã€‚
  æ¯æœ‰ä¸€è¡Œï¼Œä½ çš„åæ ‡å°±ä¼šåç§» 1ã€‚

**æœ€ä½³å®è·µï¼š**

- **å…¥ï¼š** æ¥å— CodeMirror çš„è§„èŒƒåŒ–ï¼Œä¸è¦ä¾èµ–åŸå§‹å­—ç¬¦ä¸²çš„é•¿åº¦ç´¢å¼•ã€‚
- **å‡ºï¼š** å¦‚æœåç«¯ä¸¥æ ¼è¦æ±‚ `\r\n`ï¼Œåœ¨ `view.state.doc.toString()` ä¹‹åï¼Œæ‰‹åŠ¨ replace å›å»ã€‚

### 5. React å‘ï¼šStrict Mode ä¸‹çš„åŒé‡åˆå§‹åŒ–

**ç°è±¡ï¼š**
å¼€å‘ç¯å¢ƒä¸‹ï¼Œé¡µé¢ä¸Šå‡ºç°äº†ä¸¤ä¸ªç¼–è¾‘å™¨ï¼Œæˆ–è€…æ’ä»¶é€»è¾‘æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚

**åŸå› ï¼š**
React 18 çš„ Strict Mode ä¼šå¼ºåˆ¶æ‰§è¡Œ `mount -> unmount -> mount` æµç¨‹æ¥æ£€æŸ¥å‰¯ä½œç”¨æ¸…ç†ã€‚å¦‚æœä½ çš„ `useEffect` æ¸…ç†å‡½æ•°æ²¡å†™å¥½ï¼Œç¬¬ä¸€ä¸ªç¼–è¾‘å™¨æ²¡é”€æ¯ï¼Œç¬¬äºŒä¸ªåˆåˆ›å»ºäº†ã€‚

**æœ€ä½³å®è·µï¼š**
ç¡®ä¿ `destroy` è¢«è°ƒç”¨ã€‚

```javascript
useEffect(() => {
    const view = new EditorView({ ... });

    return () => {
        view.destroy(); // å¿…é¡»å†™ï¼
    };
}, []);
```

### 6. æ ·å¼å‘ï¼šTooltip/Autocomplete è¢«é®æŒ¡ (z-index)

**ç°è±¡ï¼š**
ç¼–è¾‘å™¨æ”¾åœ¨ä¸€ä¸ª Modal (å¼¹çª—) é‡Œï¼Œè‡ªåŠ¨è¡¥å…¨çš„åˆ—è¡¨å¼¹å‡ºæ¥æ—¶ï¼Œè¢« Modal çš„è¾¹ç¼˜åˆ‡æ–­äº†ï¼Œæˆ–è€…æ˜¾ç¤ºåœ¨ Modal ä¸‹é¢ã€‚

**åŸå› ï¼š**
CodeMirror é»˜è®¤å°† Tooltip æ¸²æŸ“åœ¨ç¼–è¾‘å™¨ DOM å†…éƒ¨ã€‚å¦‚æœç¼–è¾‘å™¨å®¹å™¨æœ‰ `overflow: hidden` æˆ–è€… Modal æœ‰å¤æ‚çš„ `z-index` ä¸Šä¸‹æ–‡ï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚

**æœ€ä½³å®è·µï¼š**
é…ç½® Tooltip æŒ‚è½½åˆ° `body` ä¸Šï¼Œè„±ç¦»å½“å‰ DOM ç»“æ„ã€‚

```javascript
import { tooltips } from '@codemirror/view'

const extensions = [
  tooltips({
    position: 'absolute',
    parent: document.body // æŒ‚è½½åˆ° body
  })
]
```

### 7. æ€§èƒ½å‘ï¼šè¶…é•¿å•è¡Œæ–‡ä»¶ (Minified Code)

**ç°è±¡ï¼š**
æ‰“å¼€ä¸€ä¸ªåªæœ‰ä¸€è¡Œä½†æœ‰ 1MB å¤§å°çš„ `min.js` æˆ– JSON æ–‡ä»¶ï¼Œç¼–è¾‘å™¨ç›´æ¥å¡æ­»ã€‚

**åŸå› ï¼š**
CodeMirror æœ‰â€œè§†å£è™šæ‹ŸåŒ–â€ï¼ˆåªæ¸²æŸ“çœ‹å¾—è§çš„è¡Œï¼‰ï¼Œä½†è¿™ä¾èµ–äºè¡Œæ•°ã€‚å¦‚æœåªæœ‰ä¸€è¡Œï¼Œå®ƒå¿…é¡»æ¸²æŸ“è¿™ä¸€æ•´è¡Œçš„æ‰€æœ‰ DOMã€‚

**æœ€ä½³å®è·µï¼š**
ç›®å‰ CodeMirror å¯¹è¶…é•¿å•è¡Œæ”¯æŒæœ‰é™ã€‚

- **æ–¹æ¡ˆï¼š** æ£€æµ‹åˆ°è¶…é•¿è¡Œæ—¶ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆPrettifyï¼‰åå†æ˜¾ç¤ºã€‚
- **é…ç½®ï¼š** é™åˆ¶å•è¡Œæœ€å¤§é•¿åº¦ï¼ˆè™½ç„¶è¿™åªæ˜¯æˆªæ–­æ˜¾ç¤ºï¼‰ã€‚

### 8. æ¦‚å¿µå‘ï¼šReadOnly vs Editable

**ç°è±¡ï¼š**
è®¾ç½®äº† `readOnly`ï¼Œä½†æ’ä»¶ä¾ç„¶èƒ½ä¿®æ”¹å†…å®¹ï¼Œæˆ–è€…å…‰æ ‡ä¾ç„¶èƒ½é—ªçƒã€‚

**åŒºåˆ«ï¼š**

- `EditorState.readOnly.of(true)`: **çŠ¶æ€å±‚é¢çš„åªè¯»**ã€‚ç”¨æˆ·æ— æ³•é€šè¿‡é”®ç›˜è¾“å…¥ä¿®æ”¹ï¼Œä½†ä½ çš„ä»£ç å¯ä»¥é€šè¿‡ `dispatch` ä¿®æ”¹ã€‚
- `EditorView.editable.of(false)`: **DOM å±‚é¢çš„åªè¯»**ã€‚å°† `contenteditable` è®¾ä¸º falseã€‚é”®ç›˜å¼¹ä¸èµ·ï¼Œå…‰æ ‡å¯èƒ½æ¶ˆå¤±ï¼ˆå–å†³äºæµè§ˆå™¨ï¼‰ã€‚

**æœ€ä½³å®è·µï¼š**
é€šå¸¸ä½ éœ€è¦çš„æ˜¯ç»„åˆæ‹³ï¼š

```javascript
extensions: [
  EditorState.readOnly.of(true), // ç¦æ­¢ä¿®æ”¹å†…å®¹
  EditorView.editable.of(false) // ç¦ç”¨ DOM ç¼–è¾‘å±æ€§ï¼ˆå¯é€‰ï¼Œè§†éœ€æ±‚è€Œå®šï¼‰
]
```

ä½ æåˆ°çš„â€œå¤šæ¬¡é‡å¤æ›´æ–°â€ç¡®å®æ˜¯ CodeMirror é›†æˆä¸­æœ€ä»¤äººå¤´ç§ƒçš„é—®é¢˜ä¹‹ä¸€ï¼Œé€šå¸¸è¢«ç§°ä¸º **â€œä¹’ä¹“æ•ˆåº”â€ (Ping-Pong Effect)** æˆ– **â€œæ›´æ–°æ­»å¾ªç¯â€**ã€‚

é™¤äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æœ‰å‡ ä¸ªéå¸¸éšè”½ä½†ä¸€æ—¦é‡åˆ°å°±å¾ˆéš¾æ’æŸ¥çš„â€œæ·±å‘â€ã€‚

### 1. æ ¸å¿ƒç—›ç‚¹ï¼šæ›´æ–°æ­»å¾ªç¯ (The Update Loop / Ping-Pong)

è¿™æ˜¯ä½ å°è±¡ä¸­æœ€æ·±åˆ»çš„é—®é¢˜ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ React/Vue åŒå‘ç»‘å®šæ—¶ã€‚

**ç°è±¡ï¼š**

- æ§åˆ¶å°æŠ¥é”™ï¼š`Error: Calls to EditorView.update are not allowed while an update is in progress`ã€‚
- æˆ–è€…ï¼šè¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œå…‰æ ‡çªç„¶è·³åˆ°æœ€åæˆ–æœ€å‰ã€‚
- æˆ–è€…ï¼šCPU é£™å‡ï¼ŒReact DevTools æ˜¾ç¤ºç»„ä»¶ç–¯ç‹‚ re-renderã€‚

**åœºæ™¯ Aï¼šReact çš„ `useEffect` ä¾èµ–æ²¡å†™å¥½**

```javascript
// âŒ é”™è¯¯ç¤ºèŒƒ
useEffect(() => {
  // æ¯æ¬¡ç»„ä»¶æ¸²æŸ“ï¼Œéƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ EditorState
  // å¯¼è‡´ç¼–è¾‘å™¨å†…å®¹é‡ç½®ï¼Œå…‰æ ‡ä¸¢å¤±
  const state = EditorState.create({ doc: props.value })
  view.setState(state)
}, [props.value]) // åªè¦ value å˜äº†å°±é‡ç½®
```

**åœºæ™¯ Bï¼šåŒæ­¥æ›´æ–°çš„â€œä¹’ä¹“çƒâ€**

1.  ç”¨æˆ·åœ¨ CM è¾“å…¥ 'A' -> è§¦å‘ CM `updateListener`ã€‚
2.  `updateListener` è°ƒç”¨ React `onChange('A')`ã€‚
3.  React æ›´æ–° State -> è§¦å‘ç»„ä»¶é‡æ¸²æŸ“ã€‚
4.  ç»„ä»¶æ¥æ”¶æ–° Props `value='A'`ã€‚
5.  `useEffect` ç›‘å¬åˆ° `value` å˜äº† -> è°ƒç”¨ `view.dispatch({ insert: 'A' })`ã€‚
6.  **æ­»å¾ªç¯å¼€å§‹**ï¼šCM æ”¶åˆ° dispatch -> å†æ¬¡è§¦å‘ `updateListener`...

**âœ… æœ€ä½³å®è·µï¼ˆå¿…èƒŒå£è¯€ï¼‰ï¼š**
åœ¨å°† Props åŒæ­¥å› CodeMirror ä¹‹å‰ï¼Œ**å¿…é¡»** æ£€æŸ¥å†…å®¹æ˜¯å¦å·²ç»ä¸€è‡´ã€‚

```javascript
useEffect(() => {
  const currentDoc = view.state.doc.toString()
  // ğŸ›‘ å®ˆé—¨å‘˜ï¼šåªæœ‰å½“å¤–éƒ¨ä¼ å…¥çš„å€¼ï¼ŒçœŸçš„å’Œç¼–è¾‘å™¨é‡Œçš„ä¸ä¸€æ ·æ—¶ï¼Œæ‰åŠ¨æ‰‹
  if (props.value !== currentDoc) {
    view.dispatch({
      changes: { from: 0, to: currentDoc.length, insert: props.value }
    })
  }
}, [props.value])
```

---

### 2. ä¸­æ–‡è¾“å…¥æ³• (IME) å‘ï¼šComposition Events

å¯¹äºä¸­æ–‡å¼€å‘è€…ï¼Œè¿™æ˜¯ä»…æ¬¡äºæ­»å¾ªç¯çš„ç¬¬äºŒå¤§å‘ã€‚

**ç°è±¡ï¼š**

- æ­£åœ¨æ‰“æ‹¼éŸ³ï¼ˆæ¯”å¦‚è¾“å…¥ "zhong" è¿˜æ²¡é€‰å­—ï¼‰ï¼Œç»“æœè§¦å‘äº†è‡ªåŠ¨è¡¥å…¨ï¼Œæˆ–è€…è§¦å‘äº†æœç´¢è¿‡æ»¤ã€‚
- æˆ–è€…åœ¨ React ä¸­ï¼Œæ‹¼éŸ³è¿˜æ²¡é€‰å®Œï¼Œè¾“å…¥æ¡†å°±è¢«é‡ç½®äº†ã€‚

**åŸå› ï¼š**
CodeMirror çš„ `updateListener` éå¸¸è¯šå®ã€‚å½“ä½ æ‰“ "zhong" çš„æ—¶å€™ï¼Œæ–‡æ¡£å†…å®¹ç¡®å®å˜äº†ï¼ˆå˜æˆäº†å¸¦æœ‰ä¸‹åˆ’çº¿çš„é¢„è§ˆå­—ç¬¦ï¼‰ã€‚

**âœ… æœ€ä½³å®è·µï¼š**
åœ¨å¤„ç† `onChange` æˆ–å…³é”®é€»è¾‘æ—¶ï¼Œæ£€æŸ¥ `view.composing` çŠ¶æ€ã€‚

```javascript
EditorView.updateListener.of(update => {
  // ğŸ›‘ å¦‚æœç”¨æˆ·æ­£åœ¨ç”¨è¾“å…¥æ³•æ‰“å­—ï¼ˆæ‹¼éŸ³é€‰è¯ä¸­ï¼‰ï¼Œä¸è¦è§¦å‘ä¸šåŠ¡é€»è¾‘
  if (update.view.composing) {
    return
  }

  if (update.docChanged) {
    // å®‰å…¨çš„æ›´æ–°
    props.onChange(update.state.doc.toString())
  }
})
```

---

### 3. å­—ä½“åŠ è½½å‘ï¼šæµ‹é‡é”™è¯¯ (Layout Thrashing)

**ç°è±¡ï¼š**
ç¼–è¾‘å™¨åˆå§‹åŒ–æ—¶ï¼Œå…‰æ ‡ä½ç½®é”™ä½ï¼ˆæ¯”å¦‚å…‰æ ‡åœ¨å­—ç¬¦ä¸­é—´ï¼‰ï¼Œæˆ–è€…è¡Œå·å’Œä»£ç å¯¹ä¸é½ã€‚ç‚¹å‡»æŸä¸€è¡Œï¼Œå…‰æ ‡å´å‡ºç°åœ¨ä¸‹ä¸€è¡Œã€‚

**åŸå› ï¼š**
CodeMirror æå…¶ä¾èµ–**ç²¾ç¡®çš„å­—ç¬¦æµ‹é‡**ã€‚
å¦‚æœç¼–è¾‘å™¨åˆå§‹åŒ–æ—¶ï¼Œä½ çš„è‡ªå®šä¹‰å­—ä½“ï¼ˆæ¯”å¦‚ 'Fira Code'ï¼‰è¿˜æ²¡åŠ è½½å®Œæˆï¼Œæµè§ˆå™¨ä¼šå…ˆç”¨é»˜è®¤å­—ä½“æ¸²æŸ“ã€‚CodeMirror æµ‹é‡äº†é»˜è®¤å­—ä½“çš„å®½åº¦ã€‚
å‡ æ¯«ç§’åï¼Œå­—ä½“åŠ è½½å®Œæˆï¼Œæ–‡å­—å˜å®½æˆ–å˜çª„äº†ï¼Œä½† CodeMirror ç¼“å­˜çš„åæ ‡ç³»ç»Ÿæ²¡æœ‰æ›´æ–°ã€‚

**âœ… æœ€ä½³å®è·µï¼š**

1.  ç¡®ä¿å­—ä½“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼ˆä½¿ç”¨ `document.fonts.ready`ï¼‰ã€‚
2.  æˆ–è€…ï¼Œå¼ºåˆ¶è§¦å‘ä¸€æ¬¡æµ‹é‡ï¼š

```javascript
// å½“ä½ ç¡®ä¿¡å¸ƒå±€å‘ç”Ÿå·¨å¤§å˜åŒ–ä½† CM æ²¡ååº”æ—¶
view.requestMeasure()
```

---

### 4. æµè§ˆå™¨åŸç”Ÿè¡Œä¸ºå†²çªï¼šCtrl+F ä¸ Cmd+S

**ç°è±¡ï¼š**

- ç”¨æˆ·æŒ‰ `Ctrl+F` æƒ³ç”¨æµè§ˆå™¨çš„æœç´¢ï¼Œç»“æœå¼¹å‡ºäº† CodeMirror çš„æœç´¢æ¡†ï¼ˆæˆ–è€…åä¹‹ï¼Œæƒ³ç”¨ç¼–è¾‘å™¨çš„æœç´¢å´å”¤èµ·äº†æµè§ˆå™¨çš„ï¼‰ã€‚
- ç”¨æˆ·æŒ‰ `Ctrl+S` ä¿å­˜ï¼Œç»“æœå¼¹å‡ºäº†æµè§ˆå™¨çš„â€œä¿å­˜ç½‘é¡µâ€å¯¹è¯æ¡†ã€‚

**åŸå› ï¼š**
CodeMirror çš„ `keymap` ä¼˜å…ˆçº§ã€‚

**âœ… æœ€ä½³å®è·µï¼š**

- **æœç´¢**ï¼šå¦‚æœä½ å¼•å…¥äº† `searchKeymap`ï¼Œå®ƒä¼šé»˜è®¤è¦†ç›– `Mod-f`ã€‚å¦‚æœä½ æƒ³ä¿ç•™æµè§ˆå™¨æœç´¢ï¼Œéœ€è¦ä¿®æ”¹ keymap é…ç½®ã€‚
- **ä¿å­˜**ï¼šå¿…é¡»æ˜¾å¼é˜»æ­¢é»˜è®¤è¡Œä¸ºã€‚

```javascript
import { keymap } from '@codemirror/view'

const saveKeymap = keymap.of([
  {
    key: 'Mod-s',
    run: () => {
      saveData()
      return true // ğŸ›‘ è¿”å› true è¡¨ç¤ºâ€œæˆ‘æ¶ˆè´¹äº†è¿™ä¸ªäº‹ä»¶â€ï¼Œé˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
    }
  }
])
```

---

### 5. éšè—å­—ç¬¦å‘ï¼šZero-width space & BOM

**ç°è±¡ï¼š**
ä»£ç çœ‹èµ·æ¥å®Œå…¨æ­£å¸¸ï¼Œä½†è¯­æ³•é«˜äº®ä¹±äº†ï¼Œæˆ–è€…è§£æå™¨æŠ¥é”™ã€‚å¤åˆ¶å‡ºæ¥æ”¾åˆ°è®°äº‹æœ¬é‡Œä¹Ÿçœ‹ä¸å‡ºé—®é¢˜ã€‚

**åŸå› ï¼š**
ç”¨æˆ·å¯èƒ½ä»æŸäº›ç½‘ç«™å¤åˆ¶äº†ä»£ç ï¼Œå¸¦å…¥äº† **é›¶å®½ç©ºæ ¼ (Zero-width space)** æˆ– **BOM å¤´**ã€‚CodeMirror é»˜è®¤ä¼šå¦‚å®æ¸²æŸ“è¿™äº›ä¸å¯è§å­—ç¬¦ã€‚

**âœ… æœ€ä½³å®è·µï¼š**
ä½¿ç”¨ `highlightSpecialChars()` æ‰©å±•ã€‚å®ƒä¼šæŠŠè¿™äº›ä¸å¯è§å­—ç¬¦æ¸²æŸ“æˆä¸€ä¸ªçº¢è‰²çš„ç‚¹æˆ–ç‰¹æ®Šçš„å ä½ç¬¦ï¼Œè®©ç”¨æˆ·çŸ¥é“è¿™é‡Œæœ‰è„ä¸œè¥¿ã€‚

```javascript
import { highlightSpecialChars } from '@codemirror/view'
// é»˜è®¤çš„ basicSetup é‡Œé€šå¸¸åŒ…å«äº†è¿™ä¸ªï¼Œä½†å¦‚æœä½ æ˜¯æ‰‹åŠ¨ç»„è£…æ‰©å±•ï¼Œåƒä¸‡åˆ«æ¼äº†
```

### 6. é”€æ¯å‘ï¼šå†…å­˜æ³„æ¼ (Memory Leak)

**ç°è±¡ï¼š**
SPA åº”ç”¨ï¼ˆå•é¡µåº”ç”¨ï¼‰åˆ‡æ¢è·¯ç”±å‡ æ¬¡åï¼Œé¡µé¢è¶Šæ¥è¶Šå¡ã€‚

**åŸå› ï¼š**
`EditorView` ä¼šåœ¨ `window` å’Œ `document` ä¸Šç»‘å®šå¾ˆå¤šå…¨å±€äº‹ä»¶ï¼ˆresize, mouseup ç­‰ï¼‰ã€‚å¦‚æœç»„ä»¶å¸è½½æ—¶æ²¡æœ‰è°ƒç”¨ `view.destroy()`ï¼Œè¿™äº›ç›‘å¬å™¨æ°¸è¿œä¸ä¼šç§»é™¤ï¼ŒView å®ä¾‹ä¹Ÿæ°¸è¿œä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚

**âœ… æœ€ä½³å®è·µï¼š**
æ°¸è¿œåœ¨ç»„ä»¶å¸è½½é’©å­ä¸­é”€æ¯ã€‚

```javascript
// React
useEffect(() => {
  return () => {
    if (viewRef.current) {
      viewRef.current.destroy() // ğŸ—‘ï¸ å¿…é¡»æ‰‹åŠ¨é”€æ¯
    }
  }
}, [])
```

### æ€»ç»“ï¼šCodeMirror é¿å‘æŒ‡å—

1.  **é˜²æŠ–åŠ¨**ï¼šReact æ›´æ–°å‰å¿…åš `value !== doc` æ£€æŸ¥ã€‚
2.  **é˜²æ‹¼éŸ³**ï¼šå…³é”®é€»è¾‘æ£€æŸ¥ `view.composing`ã€‚
3.  **é˜²é”™ä½**ï¼šå­—ä½“åŠ è½½å®Œå†æ¸²æŸ“ï¼Œæˆ–æ‰‹åŠ¨ `requestMeasure`ã€‚
4.  **é˜²æ³„æ¼**ï¼šç»„ä»¶å¸è½½å¿…è°ƒ `destroy()`ã€‚

---

è¿™ä¸ªé”™è¯¯ `Error: Calls to EditorView.update are not allowed while an update is in progress` çš„æœ¬è´¨å«ä¹‰æ˜¯ï¼š**é‡å…¥ï¼ˆRe-entrancyï¼‰**ã€‚

ç®€å•æ¥è¯´ï¼š**CodeMirror æ­£åœ¨å¿™ç€å¤„ç†ä¸Šä¸€ä¸ªå˜æ›´ï¼ˆè®¡ç®—çŠ¶æ€ã€æ›´æ–° DOMã€é€šçŸ¥æ’ä»¶ï¼‰ï¼Œè¿˜æ²¡å–˜è¿‡æ°”æ¥ï¼Œä½ åˆå¡ç»™å®ƒä¸€ä¸ªæ–°çš„å˜æ›´ï¼ˆdispatchï¼‰ã€‚**

CodeMirror çš„æ›´æ–°æ˜¯**åŒæ­¥ä¸”åŸå­**çš„ï¼Œå®ƒä¸å…è®¸åœ¨â€œæ›´æ–°å‘¨æœŸâ€å†…éƒ¨å†æ¬¡è§¦å‘â€œæ›´æ–°â€ã€‚

ä»¥ä¸‹æ˜¯å¯¼è‡´è¿™ä¸ªæŠ¥é”™çš„ 5 ä¸ªæœ€ç»å…¸åœºæ™¯ï¼ŒæŒ‰å‘ç”Ÿé¢‘ç‡æ’åºï¼š

### 1. åœ¨ `updateListener` ä¸­ç›´æ¥ `dispatch` (æœ€å¸¸è§)

è¿™æ˜¯æ–°æ‰‹æœ€å®¹æ˜“çŠ¯çš„é”™ã€‚ä½ æƒ³ç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œå¦‚æœå‘ç°å†…å®¹ä¸å¯¹ï¼Œç«‹é©¬ä¿®æ­£ã€‚

**é”™è¯¯åœºæ™¯ï¼š**

```javascript
EditorView.updateListener.of((update) => {
    if (update.docChanged) {
        const text = update.state.doc.toString();
        if (text.includes("bad")) {
            // âŒ ç‚¸äº†ï¼updateListener æ‰§è¡Œæ—¶ï¼Œå½“å‰çš„ update è¿˜æ²¡ç»“æŸ
            view.dispatch({ changes: { ... } });
        }
    }
})
```

**âœ… ä¿®å¤æ–¹æ¡ˆï¼š**
å¿…é¡»æŠŠæ–°çš„ dispatch æ”¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆMacro-taskï¼‰ä¸­ã€‚

```javascript
EditorView.updateListener.of((update) => {
    if (update.docChanged && text.includes("bad")) {
        // âœ… æ”¾åˆ° setTimeout é‡Œï¼Œç­‰å½“å‰æ›´æ–°å‘¨æœŸå®Œå…¨ç»“æŸåå†æ‰§è¡Œ
        setTimeout(() => {
            view.dispatch({ changes: { ... } });
        }, 0);
    }
})
```

### 2. åœ¨ `ViewPlugin` çš„ `update` æ–¹æ³•ä¸­ `dispatch`

`ViewPlugin` çš„ `update(update)` æ–¹æ³•æ˜¯ç”¨æ¥æ›´æ–°æ’ä»¶è‡ªå·±çš„ DOM æˆ–å†…éƒ¨çŠ¶æ€çš„ï¼Œä¸æ˜¯ç”¨æ¥æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€çš„ã€‚

**é”™è¯¯åœºæ™¯ï¼š**

```javascript
ViewPlugin.fromClass(class {
    update(update) {
        if (update.viewportChanged) {
            // âŒ ç‚¸äº†ï¼è§†å›¾æ­£åœ¨æ›´æ–°æ¸²æŸ“ä¸­ï¼Œä¸èƒ½æ’å…¥æ–°çš„äº‹åŠ¡
            this.view.dispatch({ ... });
        }
    }
})
```

**âœ… ä¿®å¤æ–¹æ¡ˆï¼š**
åŒä¸Šï¼Œä½¿ç”¨ `setTimeout`ï¼Œæˆ–è€…é‡æ–°æ€è€ƒæ¶æ„ã€‚é€šå¸¸ä½ ä¸éœ€è¦åœ¨ View æ›´æ–°æ—¶åå‘ä¿®æ”¹ Stateã€‚å¦‚æœä½ æ˜¯æƒ³æ ¹æ®çŠ¶æ€å˜åŒ–è‡ªåŠ¨ä¿®æ”¹æ–‡æ¡£ï¼Œåº”è¯¥ä½¿ç”¨ **`EditorState.transactionFilter`** æˆ– **`EditorState.transactionExtender`**ï¼ˆåœ¨äº‹åŠ¡å‘ç”Ÿ**å‰**æ‹¦æˆªå¹¶ä¿®æ”¹å®ƒï¼Œè€Œä¸æ˜¯å‘ç”Ÿ**å**å†è¡¥ä¸€åˆ€ï¼‰ã€‚

### 3. React/Vue çš„åŒæ­¥æ›´æ–°å›æµ (Sync Loop)

å¦‚æœä½ çš„æ¡†æ¶æ›´æ–°é€»è¾‘å¤ªå¿«ï¼ˆåŒæ­¥ï¼‰ï¼Œä¼šåœ¨åŒä¸€ä¸ª Call Stack é‡ŒæŠŠæ•°æ®æ¨å›æ¥ã€‚

**é”™è¯¯åœºæ™¯ï¼š**

1.  ç”¨æˆ·è¾“å…¥ 'A'ã€‚
2.  CM è§¦å‘ `updateListener`ã€‚
3.  ä½ è°ƒç”¨ `props.onChange('A')`ã€‚
4.  **å…³é”®ç‚¹**ï¼šçˆ¶ç»„ä»¶æ˜¯ä¸€ä¸ªåŒæ­¥æ›´æ–°çš„ç»„ä»¶ï¼ˆæ²¡æœ‰å¼‚æ­¥æ‰¹å¤„ç†ï¼‰ï¼Œå®ƒç«‹å³è®¡ç®—å‡ºæ–° Propsï¼Œå¹¶è§¦å‘å­ç»„ä»¶é‡æ¸²æŸ“ã€‚
5.  å­ç»„ä»¶çš„ `useEffect` (æˆ– Vue çš„ `watch`) ç«‹å³æ‰§è¡Œã€‚
6.  `useEffect` é‡Œè°ƒç”¨ `view.dispatch`ã€‚
7.  æ­¤æ—¶ï¼Œç¬¬ 2 æ­¥çš„ `updateListener` å…¶å®è¿˜æ²¡å®Œå…¨è·‘å®Œï¼ˆæˆ–è€…å¤„äºåŒä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—å°¾éƒ¨ï¼‰ã€‚

**âœ… ä¿®å¤æ–¹æ¡ˆï¼š**
åœ¨ `useEffect` é‡ŒåŠ é”ï¼Œæˆ–è€…ç¡®ä¿ `onChange` æ˜¯å¼‚æ­¥çš„ã€‚ä½†æœ€ç¨³å¦¥çš„è¿˜æ˜¯æˆ‘åœ¨ä¸Šä¸€ä¸ªå›ç­”é‡Œæåˆ°çš„ï¼š**æ¯”å¯¹å†…å®¹**ã€‚

```javascript
// å¦‚æœå†…å®¹æ²¡å˜ï¼Œæ ¹æœ¬ä¸è¦ dispatchï¼Œç›´æ¥åˆ‡æ–­å¾ªç¯
if (view.state.doc.toString() !== newValue) {
    view.dispatch(...)
}
```

### 4. åœ¨ DOM äº‹ä»¶å¤„ç†å™¨ä¸­åŒæ­¥ Dispatch (æå°‘æ•°æƒ…å†µ)

é€šå¸¸ DOM äº‹ä»¶ï¼ˆå¦‚ `click`, `keydown`ï¼‰æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä»¬æœ¬èº«å°±æ˜¯æ–°çš„å®ä»»åŠ¡ã€‚ä½†åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ä¼šå‡ºé—®é¢˜ã€‚

**é”™è¯¯åœºæ™¯ï¼š**
ä½ ä½¿ç”¨ `EditorView.domEventHandlers` æ‹¦æˆªäº†æŸä¸ªäº‹ä»¶ï¼Œä½†åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä½ è§¦å‘äº†å¦ä¸€ä¸ªä¼šå¼•èµ·ç¼–è¾‘å™¨æ›´æ–°çš„å‰¯ä½œç”¨ï¼Œè€Œè¿™ä¸ªå‰¯ä½œç”¨åˆåŒæ­¥å›è°ƒäº†ç¼–è¾‘å™¨ã€‚

**âœ… ä¿®å¤æ–¹æ¡ˆï¼š**
åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ï¼Œå°½é‡ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ `changes` æ‰“åŒ…è¿›ä¸€ä¸ª `dispatch`ï¼Œä¸è¦åˆ†å¤šæ¬¡è°ƒç”¨ã€‚

### 5. å¤šä¸ªæ’ä»¶äº’ç›¸æ‰“æ¶ (è¿é”ååº”)

**é”™è¯¯åœºæ™¯ï¼š**

- æ’ä»¶ A ç›‘å¬æ›´æ–° -> `setTimeout` -> `dispatch`ã€‚
- æ’ä»¶ B ç›‘å¬æ›´æ–° -> å‘ç°æ’ä»¶ A æ”¹äº†ä¸œè¥¿ -> `dispatch`ã€‚
- æ’ä»¶ A ç›‘å¬åˆ°æ’ä»¶ B æ”¹äº†ä¸œè¥¿ -> `dispatch`ã€‚

è™½ç„¶è¿™é€šå¸¸ä¼šå¯¼è‡´â€œæ­»å¾ªç¯â€è€Œä¸æ˜¯â€œUpdate in progressâ€é”™è¯¯ï¼ˆå› ä¸º `setTimeout` éš”å¼€äº†ï¼‰ï¼Œä½†å¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªæ’ä»¶æ²¡æœ‰ç”¨ `setTimeout` è€Œæ˜¯ç›´æ¥è°ƒç”¨ï¼Œå°±ä¼šæŠ¥è¿™ä¸ªé”™ã€‚

### æ€»ç»“ï¼šå¦‚ä½•å½»åº•æ ¹æ²»ï¼Ÿ

å½“ä½ çœ‹åˆ°è¿™ä¸ªé”™è¯¯ï¼Œè„‘å­é‡Œè¦æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š

1.  **â€œæˆ‘è¦æ”¹æ—¶æœºâ€ (The Hacky Fix)**:
    åªè¦æŠŠ `view.dispatch` åŒ…åœ¨ `setTimeout(() => { ... }, 0)` é‡Œï¼Œ99% çš„è¿™ä¸ªæŠ¥é”™éƒ½ä¼šæ¶ˆå¤±ã€‚è¿™æ˜¯å› ä¸º `setTimeout` å¼ºè¡ŒæŠŠæ“ä½œæ¨åˆ°äº†å½“å‰æ›´æ–°å‘¨æœŸç»“æŸä¹‹åã€‚

2.  **â€œæˆ‘è¦æ”¹æ¶æ„â€ (The Proper Fix)**:
    é—®è‡ªå·±ï¼š_â€œä¸ºä»€ä¹ˆæˆ‘è¦åœ¨â€˜æ›´æ–°å‘ç”Ÿåâ€™ç«‹åˆ»è§¦å‘â€˜å¦ä¸€ä¸ªæ›´æ–°â€™ï¼Ÿâ€_

    - å¦‚æœæ˜¯ä¸ºäº†**ä¿®æ­£ç”¨æˆ·è¾“å…¥**ï¼ˆä¾‹å¦‚å¼ºåˆ¶å¤§å†™ï¼‰ï¼šè¯·ä½¿ç”¨ `EditorState.transactionFilter`ã€‚å®ƒå…è®¸ä½ åœ¨å˜æ›´**åº”ç”¨åˆ° State ä¹‹å‰**å°±ä¿®æ”¹å®ƒï¼Œè¿™æ ·å°±åªéœ€è¦ä¸€æ¬¡æ›´æ–°ï¼Œæ•ˆç‡æ›´é«˜ï¼Œä¸”ç»ä¸ä¼šæŠ¥é”™ã€‚

    ```javascript
    // âœ… æ­£ç¡®åšæ³•ï¼šåœ¨äº‹åŠ¡å‘ç”Ÿå‰æ‹¦æˆª
    const upperCaseFilter = EditorState.transactionFilter.of(tr => {
      if (tr.docChanged) {
        // æ£€æŸ¥å˜æ›´ï¼Œå¦‚æœæœ‰å°å†™ï¼Œç›´æ¥ä¿®æ”¹è¿™ä¸ª transaction çš„ changes
        // è¿”å›ä¿®æ”¹åçš„ transactionï¼Œæˆ–è€… null (ä¸æ‹¦æˆª)
      }
      return tr
    })
    ```
