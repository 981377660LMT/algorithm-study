# 如何打破死锁

## 一、死锁回顾

死锁是指多个线程（或进程）互相等待对方持有的资源，永远无法继续。  
Coffman 四个必要条件

1. 互斥，Mutual Exclusion
2. 占有并等待，Hold and Wait
3. 不可抢占，No Preemption
4. 循环等待，Circular Wait

---

## 二、破死锁的三大策略（记忆术：“预避检回”）

1. **预防（Prevent）**

   - 消除四条件中的至少一个  
     • 破互斥：尽量使用可共享资源或乐观锁  
     • 破占有并等待：申请所有资源一次性分配  
     • 破不可抢占：允许抢占已分配资源  
     • 破循环等待：为资源排序，按序申请

2. **避免（Avoid）**

   - 在运行时动态检测“安全状态”
   - 银行家算法（Banker’s Algorithm）：只有在满足安全状态时才分配资源

3. **检测与恢复（Detect & Recover）**
   - **检测**：构建资源分配图，周期检测是否有环
   - **恢复**：  
     • 回滚（Rollback）：撤销部分事务或线程  
     • 剥夺（Preemption）：强制回收资源  
     • 杀死进程：最激进，直接终止持有资源的线程

---

## “预避检回”在何环节？

1. **预防 (Prevent)**  
   环节：系统设计 / 资源请求前  
   说明：在系统架构或资源申请阶段就破除死锁的必要条件——

   - 设计共享资源或可抢占策略
   - 要么一次性申请所有资源，要么按全序申请

2. **避免 (Avoid)**  
   环节：每次资源分配决策时  
   说明：运行时在真正分配前做“安全性检查”——

   - 银行家算法判定分配后系统是否仍处于安全状态
   - 只有安全时才允许分配

3. **检测与恢复 (Detect & Recover)**  
   环节：系统运行中 / 死锁发生后  
   说明：周期性或触发时检测资源分配图中的环
   - **检测**：发现环即死锁
   - **恢复**：回滚、剥夺资源或终止进程以打破死锁
