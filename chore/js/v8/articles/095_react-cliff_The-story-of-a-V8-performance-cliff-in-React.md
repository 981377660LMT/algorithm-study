# React 中的 V8 性能陷阱：隐藏类与多态的代价

# The story of a V8 performance cliff in React

这是一次关于 V8 内部机制如何深刻影响前端框架设计细节的经典分析。

### 1. 案例背景：React Fiber 的性能骤降

React 团队发现，在特定负载下，Fiber 架构的性能会莫名其妙地进入平稳期（Performance Cliff），且没有任何业务代码变动。

### 2. 真凶：多态化的 Map (Polymorphic Maps)

Fiber 对象是一个具有大量字段的大对象。React 会根据需要在不同阶段给它动态添加属性。

- 如果属性 A、B、C 以 `ABC` 顺序添加，V8 生成 Map 1。
- 如果属性以 `ACB` 顺序添加，V8 生成 Map 2。
  V8 认为这是两种截然不同的对象形状。当 React 的核心循环同时处理这两种形状的对象时，该访问点的内联缓存（IC）会由单态（Monomorphic）变为多态（Polymorphic）。

### 3. 性能雪崩

多态访问意味着 V8 无法直接内联偏移量，必须通过虚函数表跳转或哈希查找。在每秒数百万次的 Fiber 遍历中，这种微小的开销累计成了宏观的性能鸿沟。

### 4. 一针见血的见解

不要挑战 V8 的隐藏类（Hidden Class）优化。文章给出的黄金法则是：**始终在构造函数中以相同的顺序初始化所有属性**。即使初值为 `undefined`，也要先占住位置，因为“先占坑”比“动态加坑”能快出一个数量级。
