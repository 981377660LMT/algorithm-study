# 提升 V8 正则表达式性能：分层分发的艺术

# Improving V8 regular expressions: The new tier-up architecture

V8 彻底重构了其著名的正则引擎 Irregexp，解决了代码膨胀与启动速度的平衡问题。

### 1. 痛点：JIT 编译的代码过载

长期以来，V8 的策略是只要有正则表达式出现，就直接将其编译为机器码（Native Code）。然而，正则编译出的机器码体积巨大。对于拥有成千上万个短命正则的页面（如大型社交媒体），这会造成惊人的内存浪费，并拖慢初次解析速度。

### 2. 核心架构：正则解释器 (RegExp Interpreter)

V8 引入了分层执行机制：

- **第一层**：正则初次执行时，由专门的字节码解释器（RegExp Interpreter）处理。其占用的脚本空间极小，启动延迟极低。
- **第二层**：只有当某个正则变“热”被频繁匹配时，V8 才会动用后台线程将其 JIT 编译为优化后的机器码。

### 3. 基于内存反馈的自适应

这一策略在保证高性能的同时，显著减少了约 5MB 的 Code Space 占用。对于移动设备，这种动态平衡策略比“一刀切”的全编译模式更加友好。

### 4. 一针见血的见解

正则性能不只是“匹配速度”，更包括“编译代价”。V8 的这次重构通过引入解释器，完美契合了“二八原则”——即只有少数正则值得昂贵的 JIT 投入，这一哲学转变标志着 V8 引擎在内存平衡上的极度成熟。
