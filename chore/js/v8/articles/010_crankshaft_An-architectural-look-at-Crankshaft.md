# 曲轴发动机：开启自适应编译时代

# Crankshaft: An architectural look

这是 V8 史上最重要的文章之一，定义了此后十年的 JS 引擎性能范式。

### 1. 为什么叫 Crankshaft（曲轴）？

在机械工业中，曲轴是将往复运动转化为旋转动力的核心。V8 借此隐喻：这是一个将“杂乱、往复”的动态 JS 转化为“高速、单向”机器指令的引擎。

### 2. 双编译器模型

Crankshaft 确立了 V8 的经典分层策略：

- **Full-codegen (基准编译器)**：不求优化，但求快。它直接生成机器码，并负责在运行点埋下 **Inline Caches (IC)**。
- **Hydrogen (HIR)**：基于 **SSA (静态单赋值)** 的高级编译器。它读取 IC 收集的类型反馈，进行推测性优化（Speculative Optimization），如全局值编号（GVN）和逃逸分析。
- **Lithium (LIR)**：底层的寄存器分配和零散指令优化，最终产出特定平台的汇编。

### 3. 去优化 (Deoptimization)

这是 Crankshaft 的灵魂。因为它是基于“赌博”（推测）来优化代码的（比如赌你传的一直是整数），一旦赌输了（类型变了），引擎必须通过复杂的机制回滚到基准代码。这保证了即便是推测失败，程序逻辑也永远正确。

### 4. 一针见血的见解

Crankshaft 的诞生标志着 JS 引擎从简单的“解释 + 缓存”阶段进化到了“深度理解 + 大胆推测”阶段。它证明了通过编译器工程的卓越设计，可以让原本“无序”的动态语言在极速运转时呈现出静态语言般的规律与锋利。
