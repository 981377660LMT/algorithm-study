## FaRM

### 核心观点

FaRM 是一个专为**单数据中心**设计的、追求极致性能的内存分布式事务系统。其核心思想是，通过采用**乐观并发控制（OCC）**，来最大化利用 **RDMA（远程直接内存访问）** 这一高速网络硬件的潜力。具体来说，FaRM 允许事务在“执行阶段”使用极速的单向 RDMA 操作直接读取远程服务器内存中的数据，无需服务器 CPU 的任何干预；然后，在“提交阶段”通过一个基于版本号检查的验证协议来保证事务的**可序列化**。这种设计将一致性检查的开销后置，从而为“读”操作铺平了道路，实现了比传统基于锁的悲观并发控制（如 Spanner）快几个数量级的事务处理速度，但其代价是仅适用于低冲突场景，并且其架构不适合地理上分散的广域网环境。

---

### 逻辑梳理

#### 1. FaRM 的设计目标与性能武器

FaRM 与 Spanner 走了完全不同的技术路线，其目标不是地理容灾，而是榨干单个数据中心内的硬件性能。

- **核心武器库：**
  1.  **RDMA (远程直接内存访问):** 允许一台机器的网卡直接读写另一台机器的内存，无需目标机器 CPU 的参与。这是 FaRM 实现超低延迟（约 5µs）读操作的基石。
  2.  **内核旁路 (Kernel Bypass):** 应用程序直接与网卡通信，消除了操作系统内核带来的性能开销。
  3.  **全内存存储:** 所有数据都存储在 RAM 中，避免了缓慢的磁盘 I/O。
  4.  **伪非易失性内存 (NVRAM):** 通过“机架电池 + 断电时内存转存 SSD”的方案，使 RAM 在断电时能够持久化，解决了全内存存储的持久性问题，但此方案对软件崩溃无效，因此仍需副本容灾。

#### 2. 核心矛盾：RDMA 与传统事务模型的冲突

- **问题：** RDMA 是一种“哑”操作，它只会单纯地读写内存。而传统的**悲观并发控制**（如两阶段锁）需要在访问数据前进行复杂的逻辑判断（如检查锁、设置锁），这需要服务器 CPU 的**主动参与**，与 RDMA 的核心优势（绕过 CPU）背道而驰。
- **结论：** 如果想用 RDMA 来加速读操作，就不能在读之前加锁。

#### 3. FaRM 的解决方案：乐观并发控制 (OCC)

FaRM 被其对 RDMA 的追求“逼上”了乐观并发控制的道路。

- **OCC 流程：**
  1.  **执行阶段 (Execute):**
      - 事务**自由地**读取数据。FaRM 在此阶段使用**单向 RDMA 读**来获取对象及其**版本号**，速度极快。
      - 所有写操作都先**缓存在客户端本地**。
  2.  **验证阶段 (Validate):**
      - 当事务提交时，进入一个类 2PC 的协议。
      - **核心检查：** 验证在此期间（从读取到准备提交），它所依赖的数据是否已被其他事务修改。FaRM 通过**检查版本号**来实现这一点。
  3.  **提交/中止阶段 (Commit/Abort):**
      - 如果验证通过（版本号未变），则提交事务，将缓存的写入应用到服务器。
      - 如果验证失败（版本号已变或对象被锁定），则**中止 (Abort)** 事务并重试。

#### 4. FaRM 的 OCC 协议细节 (简化版)

FaRM 的提交协议是一个精巧的、为 RDMA 优化的类 2PC 流程。

1.  **对于只读数据 (Validate 优化):**

    - 在提交时，客户端再次使用**单向 RDMA 读**来重新获取它只读过的对象的头部（包含版本号和锁位）。
    - 它在客户端本地检查版本号是否与初次读取时相同，且锁位是否未被设置。
    - **优势：** 整个验证过程完全在客户端完成，无需服务器 CPU 参与，速度极快。

2.  **对于读写数据 (Lock-Validate-Commit):**
    - **Lock 阶段:** 客户端使用 RDMA 写，将一个包含“对象 ID、读取时的版本号、新值”的日志条目追加到主副本的日志中。
    - 主副本的 CPU 轮询此日志，然后使用**原子指令 (Compare-and-Swap)** 来执行关键的验证+锁定操作：**当且仅当**当前对象的版本号与客户端日志中的版本号匹配且锁位未设置时，才将该对象的锁位设置为 1。
    - 如果 CAS 失败（版本号不匹配或已被锁定），主副本投票“否决”，事务中止。如果成功，则投票“同意”。
    - **Commit 阶段:** 如果所有主副本都同意，协调者（客户端）会向所有主副本的日志中追加“提交”记录，主副本收到后应用新值、增加版本号并清除锁位。

**结论：** FaRM 的设计展示了如何通过算法（OCC）与硬件（RDMA）的深度协同，将分布式事务的性能推向新的高度。它放弃了地理分布的灵活性，专注于解决数据中心内部的 CPU 和网络瓶颈，其核心思想——**用乐观验证代替悲观锁定，为高速硬件直通数据铺平道路**——对后续的高性能系统设计产生了深远影响。
