## 证书透明度

### 核心观点

证书透明度（Certificate Transparency, CT）是一个旨在修复 HTTPS 安全生态系统核心漏洞的审计系统。其根本问题在于：任何一个证书颁发机构（CA）都可能被攻破或恶意地为任意网站（如 `google.com`）签发一个“假”证书，从而让攻击者能够发起中间人攻击，而网站所有者对此却毫不知情。CT 的核心思想是**放弃“事前预防”，转向“事后审计”**：它通过建立一个公开的、仅可追加的日志系统，并强制要求浏览器只信任那些被记录在日志中的证书，从而迫使所有证书（无论是合法的还是恶意的）都必须“公之于众”。这样一来，网站所有者就可以通过监控这些日志，及时发现未经授权的证书并采取行动。为了防止日志服务器本身作恶（如对不同人展示不同日志），CT 引入了基于**默克尔树（Merkle Tree）**的加密证明机制，确保日志的完整性和一致性，最终实现了一个即使在互不信任的参与者之间也能建立信任的透明审计框架。

---

### 逻辑梳理

#### 1. 问题根源：HTTPS 的信任模型已然“破产”

1.  **HTTPS 依赖证书：** 为了防止中间人攻击，网站（如 `gmail.com`）会向浏览器出示一个数字证书，以证明“我就是我”。
2.  **证书依赖 CA：** 证书由证书颁发机构（CA）签发。浏览器内置了一个包含数百个受信任 CA 的列表。
3.  **核心漏洞：** **任何一个**受信任的 CA 都可以为**任何一个**域名签发证书。这意味着，只要这数百个 CA 中有一个被攻破、管理不善或本身就是恶意的，攻击者就能拿到一个看似合法的 `gmail.com` 假证书。
4.  **秘密攻击：** 在 CT 出现之前，这种攻击可以秘密进行。攻击者可以只向少数目标用户出示这个假证书，而真正的 Google 公司可能永远不会发现这个假证书的存在。

#### 2. CT 的核心策略：从“预防”到“审计”

由于无法建立一个全球统一、绝对可信的权威来“预防”假证书的签发，CT 改变了思路。

- **核心规则：** 现代浏览器（如 Chrome）只接受那些被发布到公开的“证书透明度日志”中的证书。
- **带来的改变：**
  1.  **强制公开：** 攻击者如果想让他的假证书生效，就必须把它提交到这个公开的日志里。
  2.  **启用审计：** 网站所有者（如 Google）可以运行一个“监控器”（Monitor）程序，持续扫描所有 CT 日志。
  3.  **及时发现：** 一旦监控器在日志中发现一个并非自己申请的、针对自己域名的证书，就能立即警觉，并采取措施（如联系浏览器厂商吊销该证书）。

#### 3. 新的挑战：如何信任“日志服务器”？

这个策略很好，但前提是日志服务器本身是可信的。如果日志服务器也是恶意的，它会如何破坏这个系统？

- **攻击一：删除记录。** 日志服务器向浏览器展示了一个假证书，攻击完成后，在监控器发现之前将该记录从日志中删除。
- **攻击二：分裂/分叉 (Fork)。** 这是最危险的攻击。日志服务器向受害者浏览器展示一个包含假证书的“特供版”日志，同时向全世界的监控器展示一个不包含该证书的“正常版”日志。

#### 4. CT 的技术基石：用密码学构建信任

CT 使用基于**默克尔树**的加密技术来解决对日志服务器的不信任问题。

1.  **默克尔树 (Merkle Tree):**

    - 日志服务器将所有证书构建成一棵哈希树。树的根节点是一个简短的哈希值，称为**签名树头 (Signed Tree Head, STH)**。
    - **特性：** STH 是对整个日志内容的唯一加密承诺。日志中任何微小的改动都会导致 STH 发生变化。

2.  **解决方案：**
    - **防删除/防篡改 (Proof of Inclusion):** 当浏览器收到一个证书时，它会向日志服务器索要一个“包含证明”。这个证明可以让浏览器在不下载整个日志的情况下，仅通过 STH 和几个中间哈希值，就能独立验证该证书确实存在于由当前 STH 所代表的日志版本中。
    - **防分叉 (Proof of Consistency & Gossip):**
      - **一致性证明：** CT 定义了一种“一致性证明”，可以证明一个新的日志版本（新的 STH）是旧版本（旧的 STH）的超集，即只是在末尾追加了新记录，而没有修改历史。
      - **强制连续性：** 浏览器会记住它上次看到的 STH。当日志服务器提供一个新的 STH 时，浏览器会要求一个“一致性证明”，确保新旧 STH 之间是连续的、无分叉的。如果日志服务器试图将浏览器从一个分叉切换到另一个，这个证明就会失败。
      - **八卦协议 (Gossip):** 浏览器和监控器之间会互相“八卦”它们看到的 STH。如果一个恶意的日志服务器给不同参与者看了不同的 STH（即制造了分叉），这些不一致的 STH 很快就会在八卦网络中被发现，因为它们之间无法提供有效的一致性证明，从而暴露恶意行为。

**结论：** CT 通过一套精巧的加密证明机制，构建了一个“可验证的”公共账本。它不信任任何单一参与者，而是依赖于密码学和多方审计，确保了“如果一个证书被使用，那么它一定会被发现”，从而极大地提高了整个互联网证书生态系统的安全性。
