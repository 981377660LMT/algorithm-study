ä»¥ä¸‹æ˜¯å¯¹ Go è¯­è¨€ä¸­ä½¿ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆPrepared Statementsï¼‰çš„æ·±åº¦è§£æï¼Œæ¶µç›–æ ¸å¿ƒåŸç†ã€å®è·µæŠ€å·§ä¸é¿å‘æŒ‡å—ï¼š

---

# Go é¢„å¤„ç†è¯­å¥ï¼ˆPrepared Statementsï¼‰è¯¦è§£

## ä¸€ã€é¢„å¤„ç†è¯­å¥çš„æ ¸å¿ƒä»·å€¼

- **å®‰å…¨æ€§æå‡**ï¼šè‡ªåŠ¨å¤„ç†å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé¢„é˜² SQL æ³¨å…¥æ”»å‡»
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤ç”¨æŸ¥è¯¢è®¡åˆ’ï¼ˆæ”¯æŒè¯¥ç‰¹æ€§çš„æ•°æ®åº“ï¼‰
- **ä»£ç æ¸…æ™°æ€§**ï¼šSQL ç»“æ„ä¸å‚æ•°åˆ†ç¦»

---

## äºŒã€Go é¢„å¤„ç†å®ç°æœºåˆ¶

### 1. ä¸ä¼ ç»Ÿå®ç°çš„å…³é”®å·®å¼‚

åœ¨ Go ä¸­ï¼Œé¢„å¤„ç†è¯­å¥ä¸ä¸å•ä¸€è¿æ¥ç»‘å®šçš„ç‰¹ç‚¹ï¼š

```go
// è¿™ä¸ªæ“ä½œè™½ç„¶ç§°ä¸ºâ€œPrepareâ€ï¼Œä½†ä¸æ•°æ®åº“è¿æ¥æ— å…³
stmt, _ := db.Prepare("SELECT ... WHERE id = ?")

stmt.Query(1) // ç¬¬1æ¬¡æ‰§è¡Œå¯èƒ½ä½¿ç”¨è¿æ¥A
stmt.Query(2) // è‹¥è¿æ¥Aå¿™ï¼Œå¯èƒ½æ¢ç”¨è¿æ¥Bé‡æ–°Prepare
```

ğŸ“Œ **é‡å‡†å¤‡ï¼ˆReprepareï¼‰æœºåˆ¶**ï¼š

- å½“åŸè¿æ¥ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é‡æ–°å‡†å¤‡è¯­å¥
- å¯èƒ½å¼•å‘æ€§èƒ½å¼€é”€ï¼ˆé¢‘ç¹é‡å‡†å¤‡ï¼‰
- å­˜åœ¨æœåŠ¡å™¨ç«¯é¢„å¤„ç†è¯­å¥æ•°é‡çˆ†ç‚¸çš„é£é™©

---

## ä¸‰ã€é¢„å¤„ç†è¯­å¥çš„æ¨èä¸è§„é¿åœºæ™¯

### 1. **åº”è¯¥ä½¿ç”¨**çš„æƒ…å†µï¼š

- å®‰å…¨æ•æ„Ÿæ“ä½œï¼ˆç”¨æˆ·è¾“å…¥å¤„ç†ï¼‰
- é‡å¤æ‰§è¡Œç›¸åŒ SQL æ¨¡æ¿ï¼ˆæ‰¹é‡æ’å…¥ã€å¤šæ¬¡æŸ¥è¯¢ï¼‰

```go
// æ‰¹é‡æ’å…¥æœ€ä½³å®è·µ
stmt, _ := db.Prepare("INSERT INTO logs(msg) VALUES (?)")
for _, msg := range logMessages {
    stmt.Exec(msg)
}
stmt.Close()
```

### 2. **é¿å…ä½¿ç”¨**çš„åœºæ™¯ï¼š

- é SQL æ ‡å‡†åè®®æ•°æ®åº“ï¼ˆå¦‚ MemSQLã€Sphinxï¼‰
- è¶…é«˜å¹¶å‘å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼ˆ[å‚è€ƒæ¡ˆä¾‹](https://www.vividcortex.com)ï¼‰
- ä¸€æ¬¡æ€§æŸ¥è¯¢ä¸”å‚æ•°ç®€å•çš„åœºæ™¯

```go
// ç›´æ¥æ–‡æœ¬æŸ¥è¯¢
db.Query(fmt.Sprintf("SELECT * FROM cache_%d", shardID))
```

---

## å››ã€äº‹åŠ¡ï¼ˆTransactionï¼‰ä¸­çš„ç‰¹æ®Šè§„åˆ™

### 1. æ ¸å¿ƒç‰¹ç‚¹ï¼š

- **è¿æ¥ç‹¬å **ï¼šäº‹åŠ¡å†…çš„é¢„å¤„ç†è¯­å¥ç»‘å®šåˆ°å›ºå®šè¿æ¥
- **æ€§èƒ½ä¼˜åŠ¿**ï¼šæ— éœ€é‡å‡†å¤‡ï¼Œé¿å…å¤šè¿æ¥ä¸Šä¸‹æ–‡åˆ‡æ¢
- **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šè¯­å¥éšäº‹åŠ¡æäº¤/å›æ»šè‡ªåŠ¨å¤±æ•ˆ

### 2. ä½¿ç”¨è§„èŒƒï¼š

```go
tx, _ := db.Begin()
defer tx.Rollback()

// âŒ å±é™©æ“ä½œï¼šäº‹åŠ¡å¤–é¢„å¤„ç†è¯­å¥ç›´æ¥ä½¿ç”¨
globalStmt, _ := db.Prepare("...")
txStmt := tx.Stmt(globalStmt) // å¯èƒ½è§¦å‘é‡å‡†å¤‡ï¼

// âœ… æ¨èåšæ³•ï¼šå§‹ç»ˆåœ¨äº‹åŠ¡å†… Prepare
txStmt, _ := tx.Prepare("UPDATE accounts SET balance=? WHERE id=?")
txStmt.Exec(100.0, 123)
```

---

## äº”ã€å…³é”®é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

### 1. äº‹åŠ¡ä¸­ defer çš„å…³é—­é¡ºåºé—®é¢˜

```go
tx, _ := db.Begin()
stmt, _ := tx.Prepare("...")
defer stmt.Close() // Go â‰¤1.4 çš„å±é™©æ“ä½œ

// ä¿®å¤æ–¹æ¡ˆï¼šæ˜¾å¼å…³é—­
err := tx.Commit()
stmt.Close() // ç¡®ä¿åœ¨äº‹åŠ¡æäº¤å‰å…³é—­
```

### 2. è·¨æ•°æ®åº“å ä½ç¬¦è¯­æ³•å·®å¼‚

å¯¹ä¸åŒæ•°æ®åº“çš„æ”¯æŒæ–¹æ¡ˆï¼š

| æ•°æ®åº“     | å ä½ç¬¦ç¤ºä¾‹       | å¤„ç†æ–¹å¼                           |
| ---------- | ---------------- | ---------------------------------- |
| MySQL      | `WHERE id = ?`   | ç›´æ¥ä½¿ç”¨?                          |
| PostgreSQL | `WHERE id = $1`  | ä½¿ç”¨$1, $2â€¦é¡ºåºå‚æ•°                |
| Oracle     | `WHERE id = :id` | å…·åå‚æ•°éœ€é©±åŠ¨æ”¯æŒï¼Œå¦‚ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ |
| SQLite     | `WHERE id = ?`   | åŒ MySQL                           |

ğŸ“ **è·¨æ•°æ®åº“ç­–ç•¥**ï¼š

```go
// ä½¿ç”¨é¢„å¤„ç†è¯­å¥é©±åŠ¨è‡ªåŠ¨é€‚é…
var query = "SELECT * FROM users WHERE age > ?"
if usingPostgres {
    query = "SELECT * FROM users WHERE age > $1"
}
db.Prepare(query)
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è¿æ¥æ± ç®¡ç†

- ç›‘æ§ `db.Stats()` ä¸­çš„ `Idle` å’Œ `OpenConnections`
- åˆç†è®¾ç½® `SetMaxOpenConns()` é˜²æ­¢è¿‡åº¦è¿æ¥

### 2. æ‰¹é‡æ“ä½œæŠ€å·§

```go
// SQL Server BULK INSERT ç¤ºä¾‹
tx, _ := db.Begin()
stmt, _ := tx.Prepare("INSERT INTO orders VALUES (?, ?)")
for _, order := range orders {
    stmt.Exec(order.ID, order.Amount)
}
tx.Commit()
```

### 3. ç›‘æ§é¢„å¤„ç†è¯­å¥æ³„æ¼

```go
// ä½¿ç”¨runtimeç›‘æ§Stmtæ•°é‡
go func() {
    for {
        var stats = db.Stats()
        log.Printf("Stmts: %d", stats.StmtCnt)
        time.Sleep(1 * time.Minute)
    }
}()
```

---

## ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“

1. **Prepared First**ï¼šé»˜è®¤ä¼˜å…ˆä½¿ç”¨é¢„å¤„ç†è¯­å¥
2. **äº‹åŠ¡æœ¬åœ°åŒ–**ï¼šå§‹ç»ˆåœ¨äº‹åŠ¡å†…éƒ¨åˆ›å»ºæ‰€éœ€é¢„å¤„ç†è¯­å¥
3. **å‚æ•°éªŒè¯**ï¼šå³ä½¿ä½¿ç”¨é¢„å¤„ç†ï¼Œä»éœ€éªŒè¯è¾“å…¥æœ‰æ•ˆæ€§
4. **è¿æ¥ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥è¿æ¥æ± çŠ¶æ€ä¸é¢„å¤„ç†è¯­å¥æ•°é‡
5. **ç‰ˆæœ¬é€‚é…**ï¼šæ³¨æ„ Go ç‰ˆæœ¬å·®å¼‚ï¼ˆå°¤å…¶æ˜¯ â‰¤1.4 çš„äº‹åŠ¡å¤„ç†ï¼‰

---

é€šè¿‡æ·±å…¥ç†è§£ Go é¢„å¤„ç†è¯­å¥çš„ç‹¬ç‰¹å·¥ä½œæœºåˆ¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨å®‰å…¨æ€§ä¸æ€§èƒ½ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡
