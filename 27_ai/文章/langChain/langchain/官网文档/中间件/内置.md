这份文档详细介绍了 **LangChain.js 中的内置中间件 (Built-in Middleware)**。这些中间件是开箱即用的生产级组件，旨在解决 Agent 开发中的常见问题，如上下文管理、成本控制、安全合规和容错处理。

以下是对核心内置中间件的分类解读：

### 1. 上下文与记忆管理 (Context & Memory)
*   **Summarization (总结)**:
    *   **痛点**：对话太长，超过 Token 限制。
    *   **功能**：当 Token 数达到阈值（`trigger`）时，自动调用一个小模型（如 `gpt-4o-mini`）将旧的历史记录压缩成摘要，同时保留最近的 N 条消息（`keep`）。
*   **Context Editing (上下文编辑)**:
    *   **痛点**：工具调用的结果（如搜索到的长网页）非常占 Token，但用完即弃。
    *   **功能**：自动清理旧的工具输出结果（替换为 `[cleared]`），只保留最近几次调用的结果。

### 2. 安全与合规 (Safety & Compliance)
*   **Human-in-the-loop (人机协同)**:
    *   **痛点**：高风险操作（如转账、发邮件）不能让 AI 自动执行。
    *   **功能**：在特定工具执行前**暂停**，等待人类批准、修改参数或拒绝。需要配合 Checkpointer 使用。
*   **PII Detection (敏感信息检测)**:
    *   **痛点**：用户输入或 AI 输出包含手机号、邮箱等隐私信息。
    *   **功能**：自动检测并处理（屏蔽、脱敏、哈希化）敏感数据。支持自定义正则或检测函数。

### 3. 成本与控制 (Cost & Control)
*   **Model Call Limit (模型调用限制)**:
    *   **痛点**：Agent 陷入死循环，疯狂消耗 Token。
    *   **功能**：限制单次运行或整个线程的最大模型调用次数。
*   **Tool Call Limit (工具调用限制)**:
    *   **痛点**：防止滥用昂贵的 API（如付费搜索）。
    *   **功能**：限制特定工具或全局工具的调用次数。

### 4. 容错与增强 (Resilience & Enhancement)
*   **Model/Tool Retry (重试机制)**:
    *   **痛点**：网络波动或 API 临时故障。
    *   **功能**：自动进行指数退避重试（Exponential Backoff）。
*   **Model Fallback (模型回退)**:
    *   **痛点**：主模型（如 GPT-4）挂了。
    *   **功能**：自动切换到备用模型（如 Claude 3.5）。
*   **LLM Tool Selector (智能工具选择)**:
    *   **痛点**：工具太多（100+），全部塞进 Prompt 会超长且干扰模型。
    *   **功能**：先用一个小模型筛选出当前任务可能需要的 3-5 个工具，再传给主模型。

### 5. 开发与测试 (Dev & Test)
*   **LLM Tool Emulator (工具模拟器)**:
    *   **痛点**：开发时没有真实 API，或 API 调用太慢/太贵。
    *   **功能**：用 LLM 伪造工具的返回结果，用于快速原型开发或测试。

### 总结
这些内置中间件极大地降低了开发复杂 Agent 的门槛。你不需要自己写复杂的逻辑来处理 Token 溢出、API 重试或敏感词过滤，只需在 `createAgent` 的 `middleware` 数组中配置即可。

**示例：构建一个安全、抗干扰且节省成本的 Agent**
```typescript
const agent = createAgent({
  model: "gpt-4o",
  tools: [paymentTool, searchTool],
  middleware: [
    // 1. 防止死循环
    modelCallLimitMiddleware({ runLimit: 10 }),
    // 2. 敏感信息脱敏
    piiMiddleware("credit_card", { strategy: "mask" }),
    // 3. 高风险操作需人工审批
    humanInTheLoopMiddleware({ interruptOn: { paymentTool: true } }),
    // 4. 自动压缩历史记录
    summarizationMiddleware({ model: "gpt-4o-mini", trigger: { tokens: 4000 } })
  ]
});
```