这份文档介绍了 LangChain.js 中的 **Human-in-the-loop (HITL, 人机协同)** 中间件。它允许 Agent 在执行敏感工具（如写入文件、执行 SQL）之前暂停，等待人工审核。

以下是核心概念和使用方法的总结：

### 1. 核心功能
当模型尝试调用受控工具时，中间件会触发 **中断 (Interrupt)** 并保存当前状态。人类审查员可以对该操作做出以下三种决定：

*   ✅ **Approve (批准)**：按原样执行工具调用。
*   ✏️ **Edit (编辑)**：修改工具调用的参数后执行（需注意不要大幅修改，以免模型困惑）。
*   ❌ **Reject (拒绝)**：阻止执行，并向 Agent 提供拒绝原因的反馈。

### 2. 配置 Agent
要启用此功能，你需要：
1.  在 `middleware` 中添加 `humanInTheLoopMiddleware`。
2.  配置 `interruptOn` 策略（指定哪些工具需要审核）。
3.  **必须**配置 `checkpointer`（如 `MemorySaver` 或 `AsyncPostgresSaver`）以保存暂停时的状态。

```typescript
import { createAgent, humanInTheLoopMiddleware } from "langchain";
import { MemorySaver } from "@langchain/langgraph";

const agent = createAgent({
    model: "gpt-4o",
    tools: [executeSQLTool, readDataTool],
    middleware: [
        humanInTheLoopMiddleware({
            interruptOn: {
                // 对 execute_sql 工具启用审核，允许批准和拒绝
                execute_sql: { allowedDecisions: ["approve", "reject"] },
                // read_data 不需要审核
                read_data: false,
            },
        }),
    ],
    // 必须配置 checkpointer 来持久化状态
    checkpointer: new MemorySaver(),
});
```

### 3. 处理中断与恢复
HITL 流程依赖于 `thread_id` 来追踪对话状态。

**步骤 1：触发中断**
调用 Agent 时传入 `thread_id`。如果触发中断，返回结果中会包含 `__interrupt__` 字段。

```typescript
const config = { configurable: { thread_id: "thread-1" } };

const result = await agent.invoke(
    { messages: [{ role: "user", content: "Delete all records" }] },
    config
);

// 检查是否触发了中断
if (result.__interrupt__) {
    console.log("需审核的操作:", result.__interrupt__);
}
```

**步骤 2：人工决策并恢复**
使用 `Command` 对象和相同的 `thread_id` 来恢复执行。你需要传入 `resume` 对象，其中包含对每个挂起操作的 `decisions`。

```typescript
import { Command } from "@langchain/langgraph";

// 恢复执行（例如：批准操作）
await agent.invoke(
    new Command({
        resume: {
            decisions: [
                { type: "approve" } 
                // 或者 { type: "reject", message: "权限不足" }
                // 或者 { type: "edit", editedAction: { ... } }
            ]
        }
    }),
    config // 使用相同的 thread_id
);
```

### 关键注意事项
*   **持久化**：没有 `checkpointer` 和 `thread_id`，Agent 无法暂停和恢复。
*   **多操作**：如果一次暂停涉及多个工具调用，`decisions` 数组中的决策顺序必须与中断请求中的操作顺序一致。