# LangSmith 可观测性 (Tracing) 快速上手

### 1. 核心逻辑：Trace vs Run

- **Trace (追踪):** 整个请求的生命周期（如：一次完整的 RAG 问答）。
- **Run (运行):** Trace 内部的具体原子操作（如：一次向量检索、一次 LLM 调用）。

### 2. 极简配置

只需环境变量，即可开启追踪：

```bash
export LANGSMITH_TRACING=true
export LANGSMITH_API_KEY="lsv2_pt_..."
export OPENAI_API_KEY="sk-..."
```

### 3. 两种接入深度

- **深度 A：仅监控 LLM (Wrapper 模式)**
  - **做法：** 使用 `wrap_openai` (Python) 或 `wrapOpenAI` (TS) 包装客户端。
  - **效果：** 自动记录 Prompt、Completion、Token 数和耗时。
- **深度 B：监控全链路 (Traceable 模式)**
  - **做法：** 在业务函数（如 `rag()`）上加 `@traceable` 装饰器或包装器。
  - **效果：** 在 UI 中生成**嵌套树状图**，清晰展示 `rag` 内部各步骤的调用关系和耗时。

### 4. 关键点

- **LangChain/LangGraph:** 只要配好环境变量，**自动开启**，无需修改代码。
- **原生 SDK:** 必须使用 `wrap` 或 `traceable` 显式声明，否则数据不会上传。
- **多工作区:** 若 API Key 关联多个工作区，需指定 `LANGSMITH_WORKSPACE_ID`。

### 5. 进阶概念

- **Threads (会话/线程):**
  - **作用:** 将多轮对话（多个 Trace）关联在一起。
  - **实现:** 在 Trace 的 metadata 中传入 `session_id` 或 `thread_id`。
- **Projects (项目):**
  - **作用:** Trace 的逻辑容器。默认是 `default` 项目，建议按应用或环境（如 `prod-rag`）划分。
- **Feedback (反馈):**
  - **作用:** 为 Run 打分（点赞/点踩/分数）。
  - **来源:** 用户界面手动标注、自动化评估器、或通过 SDK 编程上传。
- **Tags & Metadata (标签与元数据):**
  - **Tags:** 字符串列表（如 `["beta", "test-user"]`），用于快速过滤。
  - **Metadata:** 键值对（如 `{"version": "1.2.0", "env": "prod"}`），用于存储结构化上下文。

---

正在收集工作区信息在 TypeScript 中，使用 `traceable` 的主要方式是将其作为包装函数（Wrapper）来包裹你的业务逻辑函数。这与 Python 中的装饰器用法有所不同。

1. 从 `langsmith/traceable` 导入 `traceable`。
2. 使用 `traceable` 包裹异步或同步函数。

示例代码如下：

```typescript
import { traceable } from 'langsmith/traceable'
import { OpenAI } from 'openai'
import { wrapOpenAI } from 'langsmith/wrappers'

const openAIClient = wrapOpenAI(new OpenAI())

// 使用 traceable 包装业务函数
const rag = traceable(
  async function rag(question: string) {
    // 内部逻辑，例如调用 retriever
    const docs = ['Harrison worked at Kensho']

    const systemMessage =
      'Answer the users question using only the provided information below:\n\n' + docs.join('\n')

    return await openAIClient.chat.completions.create({
      messages: [
        { role: 'system', content: systemMessage },
        { role: 'user', content: question }
      ],
      model: 'gpt-4o-mini'
    })
  },
  { name: 'rag_pipeline' }
) // 可选：指定在 LangSmith UI 中显示的名称

// 调用包装后的函数
await rag('where did harrison work')
```

### 关键点：

- **嵌套追踪**：如果在 `traceable` 函数内部调用了其他同样被 `traceable` 包装的函数，LangSmith 会自动在 UI 中生成**嵌套树状图**。
- **环境变量**：确保已配置 `LANGSMITH_TRACING=true`，否则数据不会上传。
- **手动传入 Run ID**：如果需要手动关联反馈，可以在调用时传入 `langsmith_extra`。
