# LLM observability, evaluation, and deployment

![alt text](image.png)
`类似字节的 fornax 平台。`
LangSmith 是一个用于构建、调试、测试和监控基于 LLM（大型语言模型）应用程序的统一 DevOps 平台。它由 LangChain 团队开发，旨在解决 LLM 应用从原型到生产环境中的可观测性和质量控制问题。

以下是对 LangSmith 的深入分析和讲解：

### 1. 核心功能架构

LangSmith 的功能主要围绕 LLM 应用开发的生命周期展开：

- **Tracing (追踪与调试):**

  - **全链路可视化:** 记录每一次 LLM 调用、Chain 执行、Agent 动作以及工具使用的输入输出。
  - **延迟与 Token 统计:** 详细展示每一步的耗时和 Token 消耗，帮助优化成本和性能。
  - **嵌套视图:** 清晰展示复杂的 Chain 或 Agent 的内部逻辑结构。

- **Evaluation (评估与测试):**

  - **数据集管理:** 允许创建、上传和管理测试数据集（输入/输出对）。
  - **自动化评估:** 可以在数据集上运行你的应用，并使用评估器（可以是基于 LLM 的评估器或启发式规则）来打分（如准确性、相关性）。
  - **回归测试:** 对比不同版本的 Prompt 或模型在同一数据集上的表现。

- **Monitoring (监控与生产):**

  - **实时指标:** 监控生产环境中的错误率、延迟分布和 Token 使用量。
  - **反馈循环:** 收集用户反馈（如点赞/点踩），并将这些数据关联到具体的 Trace 中，用于后续微调或改进。

- **Prompt Hub (提示词管理):**
  - 虽然是独立功能，但与 LangSmith 紧密集成，用于版本化管理 Prompt，并在 LangSmith 中直接测试不同版本的 Prompt。

### 2. 工作原理 (Tracing 机制)

LangSmith 通过在代码中注入回调（Callback）或包装器来工作。

- **LangChain 集成:** 如果你使用 LangChain，只需设置环境变量，LangSmith 会自动捕获所有运行数据。
- **非 LangChain 集成:** 对于直接使用 OpenAI SDK 或其他库的情况，可以使用 LangSmith SDK 手动包装函数进行追踪。

---

LangSmith 的管理架构可以概括为：**一套层级、两种密钥、三档角色、以及“按需升级”的计费逻辑。**

### 1. 资源层级：从钱包到项目

- **Organization (组织):** 顶层单位，对应**计费和账单**。
  - **个人版 (Personal):** 登录即自动创建，限 1 个工作区，不可邀请他人。
  - **共享版 (Shared):** 需绑定信用卡，支持多工作区和团队协作。
- **Workspace (工作区):** 核心隔离边界，对应**权限控制 (RBAC)**。建议按团队划分。
- **Application (应用):** 逻辑分组，通过 **Resource Tag** 实现。用于在 UI 中过滤特定 Agent 或项目的资源。
  - **关键建议：** 不要为开发/生产环境创建独立工作区（资源无法跨区共享），应使用 **Resource Tags**（如 `Environment: prod`）进行环境隔离。

### 2. 访问控制：谁在调用 API

- **PAT (个人访问令牌):** 以前缀 `lsv2_pt_` 开头，代表**个人身份**，用于脚本或工具。
- **Service Key (服务密钥):** 以前缀 `lsv2_sk_` 开头，代表**系统身份**，用于生产环境集成。
  - **注意：** 必须配合 `X-Tenant-Id` 请求头来指定目标工作区。

### 3. 角色与权限 (RBAC)

- **Organization Role (组织角色):**
  - **Org Admin:** 拥有最高权限，可管理账单、成员及**所有**工作区。
  - **Org User:** 仅能查看组织信息，无法执行写操作。需被显式加入特定工作区。
- **Workspace Role (工作区角色):** 决定在具体工作区内的操作权限。
  - _Admin:_ 全能，可管理成员。
  - _Editor:_ 可增删改资源（Trace, Prompt 等），但不能管人。
  - _Viewer:_ 只读。
  - _注：自定义角色是 Enterprise 专有功能。_

### 4. 计费与存储：数据“越有用越贵”

LangSmith 将 Trace 分为两档：

- **Base (基础版):** $0.5/1k traces，存 14 天。
- **Extended (扩展版):** $5/1k traces，存 400 天。
  - **自动升级机制：** 一旦你对 Trace 进行了**人工反馈 (Feedback)**、**进入标注队列**或**触发了自动化规则**，系统认为该数据“有价值”，会自动将其从 Base 升级为 Extended 档次计费。

### 5. 频率限制 (Rate Limits)

- **429 错误：** 可能是触发了每分钟 API 调用限制，也可能是达到了你设置的**月度用量上限**。
- **应对：** SDK 内置了带抖动的指数退避重试机制。
