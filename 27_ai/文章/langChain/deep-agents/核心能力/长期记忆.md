这份文档介绍了如何为 **Deep Agents** 添加**长期记忆 (Long-term Memory)** 能力，使其能够在不同的对话线程（Threads）之间持久化保存文件和数据。

默认情况下，Deep Agents 的文件系统是临时的（Ephemeral），仅在当前对话线程中有效。通过使用 `CompositeBackend` 和 `StoreBackend`，你可以实现跨线程的持久化存储。

以下是核心配置和使用指南：

### 1. 核心原理：混合后端 (CompositeBackend)

通过 `CompositeBackend`，你可以将文件系统划分为两个区域：
*   **短期记忆 (Ephemeral)**: 使用 `StateBackend`。文件保存在 Agent 状态中，随线程结束而丢失。通常用于临时草稿。
*   **长期记忆 (Persistent)**: 使用 `StoreBackend`。文件保存在 LangGraph Store 中，**跨线程持久化**。通常挂载在特定路径下（如 `/memories/`）。

### 2. 配置代码

你需要配置 `store` 并使用 `CompositeBackend` 将特定路径路由到 `StoreBackend`。

```typescript
import { createDeepAgent, CompositeBackend, StateBackend, StoreBackend } from "deepagents";
import { InMemoryStore } from "@langchain/langgraph-checkpoint";

const agent = createDeepAgent({
  // 1. 必须提供一个 Store 实例 (生产环境建议使用 PostgresStore)
  store: new InMemoryStore(),
  
  // 2. 配置混合后端
  backend: (config) => new CompositeBackend(
    new StateBackend(config),  // 默认路由：临时存储
    { 
      "/memories/": new StoreBackend(config) // 特殊路由：持久化存储
    }
  ),
  
  // 3. 在提示词中告知 Agent 如何使用
  systemPrompt: `Save user preferences and long-term notes to /memories/ to remember them across conversations.`,
});
```

### 3. 使用场景

*   **用户偏好**: 将用户的设置保存到 `/memories/preferences.txt`，Agent 在新的对话中也能读取。
*   **自我进化**: Agent 可以将收到的反馈写入 `/memories/instructions.txt`，并在每次启动时读取该文件以优化自身行为。
*   **跨会话项目**: 在一次对话中进行研究并保存到 `/memories/research/`，在下一次对话中继续基于之前的成果工作。

### 4. 存储实现

*   **开发环境**: 使用 `InMemoryStore`，重启后数据丢失。
*   **生产环境**: 使用 `PostgresStore` (来自 `@langchain/langgraph-checkpoint-postgres`) 或其他持久化 Store 实现，确保数据真正落地。

### 5. 最佳实践

*   **路径规划**: 使用清晰的路径结构，如 `/memories/user/` 或 `/memories/project_a/`。
*   **提示词引导**: 在 System Prompt 中明确告诉 Agent 哪些路径是持久化的，以及它应该在什么情况下使用这些路径。