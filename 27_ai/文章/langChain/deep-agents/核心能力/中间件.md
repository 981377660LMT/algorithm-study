这份文档介绍了 **Deep Agents** 的中间件架构。Deep Agents 采用模块化设计，通过中间件赋予 Agent 规划、文件系统操作和子智能体委派的能力。

当使用 `create_deep_agent` 时，系统会自动挂载以下三个核心中间件：

### 1. TodoListMiddleware (规划与追踪)

该中间件赋予 Agent 规划复杂任务的能力，类似于 Claude Code 的工作方式。

*   **功能**: 提供 `write_todos` 工具。
*   **用途**: Agent 在执行多步骤任务前和执行过程中，使用此工具记录、更新和追踪待办事项列表。
*   **优势**: 帮助 Agent 在面对复杂问题时保持条理，根据新信息动态调整计划。

```typescript
// 示例：手动添加中间件（createDeepAgent 默认已包含）
const agent = createAgent({
  middleware: [
    todoListMiddleware({
      systemPrompt: "Use the write_todos tool to track your progress...",
    }),
  ],
});
```

### 2. FilesystemMiddleware (上下文管理)

该中间件解决了 Agent 上下文窗口限制的问题，特别是处理变长工具输出（如搜索结果）时。

*   **功能**: 提供 `ls`, `read_file`, `write_file`, `edit_file` 工具。
*   **存储后端**:
    *   **短期记忆 (默认)**: 使用 `StateBackend`，文件保存在 Agent 状态中，随线程结束而消失。
    *   **长期记忆**: 通过配置 `CompositeBackend` 和 `StoreBackend`，可以将特定路径（如 `/memories/`）下的文件持久化保存，跨线程访问。

```typescript
// 示例：配置混合存储后端
const agent = createAgent({
  store, // 需要传入 store 实例
  middleware: [
    createFilesystemMiddleware({
      backend: (config) => new CompositeBackend(
        new StateBackend(config), // 默认临时存储
        { "/memories/": new StoreBackend(config) } // /memories/ 路径持久化
      ),
    }),
  ],
});
```

### 3. SubAgentMiddleware (任务委派与隔离)

该中间件允许主 Agent 将任务委派给子智能体，核心目的是**隔离上下文**，防止主 Agent 的上下文被中间步骤的详细日志填满。

*   **功能**: 提供 `task` 工具。
*   **配置**: 可以定义具有特定名称、描述、提示词、工具甚至特定模型的子智能体。
*   **通用子智能体**: 系统默认提供一个 `general-purpose` 子智能体，它继承主 Agent 的配置，专门用于无需特殊指令但需要上下文隔离的任务。

```typescript
// 示例：定义一个天气查询子智能体
const agent = createAgent({
  middleware: [
    createSubAgentMiddleware({
      subagents: [
        {
          name: "weather",
          description: "Get weather information",
          tools: [getWeather],
          model: "gpt-4o", // 可使用不同模型
        },
      ],
    }),
  ],
});
