è¿™ä»½æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† **LangGraph** ä¸­çš„ **Interrupts (ä¸­æ–­)** æœºåˆ¶ã€‚ä¸­æ–­å…è®¸åœ¨å›¾æ‰§è¡Œè¿‡ç¨‹ä¸­æš‚åœï¼Œç­‰å¾…å¤–éƒ¨è¾“å…¥ï¼ˆå¦‚äººå·¥å®¡æ‰¹ã€ç¼–è¾‘æˆ–éªŒè¯ï¼‰ï¼Œç„¶åå†ç»§ç»­æ‰§è¡Œã€‚è¿™æ˜¯å®ç° **Human-in-the-loop (äººæœºååŒ)** å·¥ä½œæµçš„æ ¸å¿ƒåŠŸèƒ½ã€‚

ä»¥ä¸‹æ˜¯æ ¸å¿ƒæ¦‚å¿µå’Œæœ€ä½³å®è·µçš„æ€»ç»“ï¼š

### 1. æ ¸å¿ƒæœºåˆ¶
*   **æš‚åœ (Pause)**: åœ¨èŠ‚ç‚¹å†…éƒ¨è°ƒç”¨ `interrupt(payload)` å‡½æ•°ã€‚
    *   LangGraph ä¼šä¿å­˜å½“å‰çŠ¶æ€ï¼ˆéœ€è¦é…ç½® Checkpointerï¼‰ã€‚
    *   æ‰§è¡Œæš‚åœï¼Œ`payload` ä¼šé€šè¿‡ `__interrupt__` å­—æ®µè¿”å›ç»™è°ƒç”¨è€…ã€‚
*   **æ¢å¤ (Resume)**: ä½¿ç”¨ `Command` å¯¹è±¡é‡æ–°è°ƒç”¨å›¾ã€‚
    *   å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ `thread_id`ã€‚
    *   è¯­æ³•ï¼š`await graph.invoke(new Command({ resume: value }), config)`ã€‚
    *   ä¼ å…¥çš„ `value` ä¼šä½œä¸ºèŠ‚ç‚¹å†… `interrupt()` å‡½æ•°çš„è¿”å›å€¼ï¼Œå›¾ç»§ç»­æ‰§è¡Œã€‚

### 2. å¸¸è§æ¨¡å¼
*   **å®¡æ‰¹ (Approve/Reject)**: æš‚åœå…³é”®æ“ä½œï¼ˆå¦‚ API è°ƒç”¨ï¼‰ï¼Œç­‰å¾…äººå·¥ç¡®è®¤ã€‚
*   **å®¡æŸ¥ä¸ç¼–è¾‘ (Review & Edit)**: å…è®¸äººå·¥ä¿®æ”¹ LLM ç”Ÿæˆçš„å†…å®¹æˆ–çŠ¶æ€ï¼Œç„¶åå°†ä¿®æ”¹åçš„å†…å®¹ä¼ å›å›¾ã€‚
*   **å·¥å…·ä¸­æ–­ (Interrupts in Tools)**: ç›´æ¥åœ¨ Tool å®šä¹‰ä¸­ä½¿ç”¨ `interrupt`ï¼Œåœ¨å·¥å…·æ‰§è¡Œå‰è¿›è¡Œæ‹¦æˆªå’Œä¿®æ”¹ã€‚
*   **éªŒè¯å¾ªç¯**: å¦‚æœè¾“å…¥æ— æ•ˆï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ `interrupt` ç›´åˆ°è·å–æœ‰æ•ˆæ•°æ®ã€‚

### 3. å…³é”®è§„åˆ™ (è‡³å…³é‡è¦)
ç”±äºæ¢å¤æ‰§è¡Œæ—¶ï¼ŒLangGraph ä¼š**ä»èŠ‚ç‚¹çš„å¼€å¤´é‡æ–°è¿è¡Œ**ï¼ˆReplayï¼‰ï¼Œå› æ­¤å¿…é¡»éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š

*   **ä¸è¦ä½¿ç”¨ try/catch åŒ…è£¹ `interrupt`**: `interrupt` é€šè¿‡**æŠ›å‡ºç‰¹æ®Šå¼‚å¸¸æ¥æš‚åœæ‰§è¡Œã€‚æ•è·è¯¥å¼‚å¸¸ä¼šå¯¼è‡´ä¸­æ–­å¤±æ•ˆã€‚**
*   **ä¿æŒè°ƒç”¨é¡ºåºç¡®å®šæ€§**: èŠ‚ç‚¹å†…çš„å¤šä¸ª `interrupt` è°ƒç”¨æ˜¯åŸºäºç´¢å¼•åŒ¹é…çš„ã€‚ä¸è¦åœ¨æ¡ä»¶åˆ†æ”¯ä¸­åŠ¨æ€æ”¹å˜ `interrupt` çš„è°ƒç”¨é¡ºåºæˆ–æ•°é‡ã€‚
*   **ä»…ä¼ é€’å¯åºåˆ—åŒ–æ•°æ®**: `interrupt(payload)` ä¸­çš„ payload **å¿…é¡»æ˜¯ JSON å¯åºåˆ—åŒ–çš„ï¼ˆä¸è¦ä¼ é€’å‡½æ•°æˆ–ç±»å®ä¾‹ï¼‰**ã€‚
*   **å‰¯ä½œç”¨å¿…é¡»å¹‚ç­‰**: ç”±äºèŠ‚ç‚¹åœ¨æ¢å¤æ—¶ä¼šä»å¤´é‡æ–°è¿è¡Œï¼Œ`interrupt` **ä¹‹å‰**çš„ä»£ç ä¼šè¢«å†æ¬¡æ‰§è¡Œã€‚ç¡®ä¿è¿™äº›ä»£ç ï¼ˆå¦‚æ•°æ®åº“å†™å…¥ã€API è°ƒç”¨ï¼‰æ˜¯å¹‚ç­‰çš„ï¼Œæˆ–è€…å°†å…¶æ‹†åˆ†åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹ä¸­ã€‚

### 4. è°ƒè¯•
*   **é™æ€ä¸­æ–­**: å¯ä»¥ä½¿ç”¨ `interruptBefore` å’Œ `interruptAfter` åœ¨ç¼–è¯‘å›¾æ—¶è®¾ç½®æ–­ç‚¹ï¼Œä½†è¿™ä¸»è¦ç”¨äºè°ƒè¯•ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ HITL é€»è¾‘ã€‚

### ä»£ç ç¤ºä¾‹

**æš‚åœä¸æ¢å¤ï¼š**
```typescript
// åœ¨èŠ‚ç‚¹ä¸­æš‚åœ
const result = interrupt("Do you approve?"); // æš‚åœï¼Œç­‰å¾…æ¢å¤

// åœ¨å¤–éƒ¨æ¢å¤
// result å˜é‡å°†å˜ä¸º true
await graph.invoke(new Command({ resume: true }), config);
```

**å·¥å…·ä¸­çš„ä¸­æ–­ï¼š**
```typescript
const myTool = tool(async (input) => {
  // åœ¨å·¥å…·æ‰§è¡Œé€»è¾‘å‰æš‚åœ
  const confirmation = interrupt({ ...input, msg: "Approve tool call?" });
  
  if (confirmation === "yes") {
    return "Tool executed";
  }
  return "Cancelled";
}, { ... });
```

---

åŸºäºæ‚¨æä¾›çš„å…³äº **LangGraph ä¸­æ–­ (Interrupts)** çš„æ€»ç»“ï¼Œç‰¹åˆ«æ˜¯ **å·¥å…·ä¸­æ–­ (Interrupts in Tools)** è¿™ä¸€é«˜çº§æ¨¡å¼ï¼Œæˆ‘ä¸ºæ‚¨ç¼–å†™äº†ä¸€ä¸ªå®Œæ•´çš„ã€å¯è¿è¡Œçš„ä»£ç ç¤ºä¾‹ã€‚

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªâ€œå‘é€é‚®ä»¶â€çš„å·¥å…·å†…éƒ¨æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥å®¡æ‰¹ã€‚å¦‚æœè·å¾—æ‰¹å‡†ï¼Œå·¥å…·ç»§ç»­æ‰§è¡Œï¼›å¦‚æœè¢«æ‹’ç»ï¼Œå·¥å…·ç»ˆæ­¢æ“ä½œã€‚

```typescript
import { 
  StateGraph, 
  START, 
  END, 
  MemorySaver, 
  interrupt, 
  Command, 
  MessagesAnnotation 
} from "@langchain/langgraph";
import { ToolNode } from "@langchain/langgraph/prebuilt";
import { tool } from "@langchain/core/tools";
import { HumanMessage, AIMessage } from "@langchain/core/messages";
import { ChatOpenAI } from "@langchain/openai";
import { z } from "zod";

// 1. å®šä¹‰å¸¦æœ‰ä¸­æ–­æœºåˆ¶çš„å·¥å…·
const sendEmailTool = tool(
  async ({ recipient, content }) => {
    console.log(`[Tool] æ­£åœ¨å°è¯•å‘é€é‚®ä»¶ç»™: ${recipient}...`);

    // --- æ ¸å¿ƒé€»è¾‘ï¼šåœ¨æ­¤å¤„æš‚åœ ---
    // LangGraph ä¼šæŒ‚èµ·æ‰§è¡Œï¼Œå¹¶å°†æ­¤å¯¹è±¡è¿”å›ç»™å®¢æˆ·ç«¯
    const humanReview = interrupt({
      type: "approval_request",
      msg: `å³å°†å‘é€é‚®ä»¶ç»™ ${recipient}ã€‚å†…å®¹: "${content}"ã€‚æ˜¯å¦æ‰¹å‡†ï¼Ÿ`,
      data: { recipient, content }
    });

    // --- æ¢å¤åçš„é€»è¾‘ ---
    // humanReview æ˜¯æˆ‘ä»¬é€šè¿‡ Command ä¼ å…¥çš„ resume å€¼
    if (humanReview.action === "approve") {
      // å…è®¸ä¿®æ”¹å†…å®¹ (Human-in-the-loop ç¼–è¾‘æ¨¡å¼)
      const finalContent = humanReview.editedContent || content;
      return `âœ… é‚®ä»¶å·²æˆåŠŸå‘é€ç»™ ${recipient}ã€‚å†…å®¹: ${finalContent}`;
    } else {
      return "âŒ é‚®ä»¶å‘é€è¢«ç”¨æˆ·æ‹’ç»ã€‚";
    }
  },
  {
    name: "send_email",
    description: "å‘é€é‚®ä»¶ç»™æŒ‡å®šç”¨æˆ·",
    schema: z.object({
      recipient: z.string(),
      content: z.string(),
    }),
  }
);

// 2. æ„å»ºå›¾
const tools = [sendEmailTool];
const toolNode = new ToolNode(tools);

// ä½¿ç”¨ç®€å•çš„æ¨¡å‹ (éœ€è¦é…ç½® OPENAI_API_KEY)
const model = new ChatOpenAI({ model: "gpt-4o-mini" }).bindTools(tools);

const workflow = new StateGraph(MessagesAnnotation)
  .addNode("agent", async (state) => {
    const response = await model.invoke(state.messages);
    return { messages: [response] };
  })
  .addNode("tools", toolNode)
  .addEdge(START, "agent")
  .addConditionalEdges("agent", (state) => {
    const lastMessage = state.messages[state.messages.length - 1] as AIMessage;
    if (lastMessage.tool_calls?.length) {
      return "tools";
    }
    return END;
  })
  .addEdge("tools", "agent");

// 3. ç¼–è¯‘å›¾ (å¿…é¡»é…ç½® checkpointer ä»¥æ”¯æŒä¸­æ–­)
const checkpointer = new MemorySaver();
const app = workflow.compile({ checkpointer });

// 4. æ¨¡æ‹Ÿæ‰§è¡Œæµç¨‹
async function runDemo() {
  const threadConfig = { configurable: { thread_id: "email-thread-1" } };

  console.log("--- æ­¥éª¤ 1: è§¦å‘å·¥å…·è°ƒç”¨ ---");
  const input = "è¯·å¸®æˆ‘å‘ä¸€å°é‚®ä»¶ç»™ alice@example.comï¼Œè¯´ä¼šè®®æ¨è¿Ÿäº†ã€‚";
  
  // ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè¿è¡Œç›´åˆ°é‡åˆ° interrupt
  const result1 = await app.invoke(
    { messages: [new HumanMessage(input)] },
    threadConfig
  );

  // æ£€æŸ¥æ˜¯å¦è§¦å‘äº†ä¸­æ–­
  if (result1.__interrupt__) {
    console.log("\nâ¸ï¸  å›¾æ‰§è¡Œå·²æš‚åœï¼æ”¶åˆ°ä¸­æ–­è¯·æ±‚ï¼š");
    console.log(JSON.stringify(result1.__interrupt__[0].value, null, 2));
    
    // æ¨¡æ‹Ÿäººå·¥å†³ç­–ï¼šæ‰¹å‡†å¹¶ä¿®æ”¹å†…å®¹
    console.log("\n--- æ­¥éª¤ 2: äººå·¥å®¡æ‰¹å¹¶æ¢å¤ ---");
    console.log("ğŸ‘®â€â™‚ï¸ ç”¨æˆ·å†³å®šï¼šæ‰¹å‡†ï¼Œä½†ä¿®æ”¹é‚®ä»¶å†…å®¹ã€‚");

    const resumePayload = {
      action: "approve",
      editedContent: "ä¼šè®®æ¨è¿Ÿåˆ°ä¸‹å‘¨ä¸€ï¼Œè¯·çŸ¥æ‚‰ã€‚" // ä¿®æ”¹åçš„å†…å®¹
    };

    // ä½¿ç”¨ Command æ¢å¤æ‰§è¡Œ
    const result2 = await app.invoke(
      new Command({ resume: resumePayload }),
      threadConfig
    );

    console.log("\nâœ… å›¾æ‰§è¡Œå®Œæˆã€‚æœ€ç»ˆçŠ¶æ€ï¼š");
    const lastMsg = result2.messages[result2.messages.length - 1];
    console.log(lastMsg.content);
  } else {
    console.log("æœªè§¦å‘ä¸­æ–­ï¼Œç›´æ¥å®Œæˆã€‚");
  }
}

runDemo().catch(console.error);
```

### ä»£ç å…³é”®ç‚¹è§£æ

1.  **`interrupt` çš„ä½ç½®**ï¼šæˆ‘ä»¬ç›´æ¥å°† `interrupt` æ”¾åœ¨äº† `sendEmailTool` çš„å‡½æ•°ä½“å†…ã€‚è¿™æ„å‘³ç€æ¯å½“ LLM å†³å®šè°ƒç”¨è¿™ä¸ªå·¥å…·æ—¶ï¼Œæ‰§è¡Œéƒ½ä¼šè‡ªåŠ¨æš‚åœã€‚
2.  **å¹‚ç­‰æ€§**ï¼šç”±äºæ¢å¤æ—¶å·¥å…·å‡½æ•°ä¼š**ä»å¤´é‡æ–°è¿è¡Œ**ï¼Œæˆ‘ä»¬åœ¨ `interrupt` ä¹‹å‰åªåšäº† `console.log`ï¼ˆæ— å‰¯ä½œç”¨ï¼‰ã€‚çœŸæ­£çš„å‰¯ä½œç”¨ï¼ˆâ€œå‘é€é‚®ä»¶â€çš„é€»è¾‘ï¼‰æ”¾åœ¨äº† `interrupt` ä¹‹åã€‚
3.  **åŠ¨æ€ä¿®æ”¹**ï¼šåœ¨æ¢å¤æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…ä¼ å…¥äº† `approve` åŠ¨ä½œï¼Œè¿˜ä¼ å…¥äº† `editedContent`ã€‚å·¥å…·é€»è¾‘ä¼˜å…ˆä½¿ç”¨è¿™ä¸ªä¿®æ”¹åçš„å†…å®¹ï¼Œå®ç°äº†â€œå®¡æŸ¥ä¸ç¼–è¾‘â€æ¨¡å¼ã€‚
4.  **`Command` å¯¹è±¡**ï¼šè¿™æ˜¯æ¢å¤æ‰§è¡Œçš„æ ‡å‡†æ–¹å¼ï¼Œ`resume` å­—æ®µçš„å€¼ä¼šç›´æ¥èµ‹å€¼ç»™å·¥å…·å†…éƒ¨çš„ `humanReview` å˜é‡ã€‚