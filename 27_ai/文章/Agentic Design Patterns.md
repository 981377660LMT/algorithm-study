https://github.com/ginobefun/agentic-design-patterns-cn

# 目录 (Table of Contents)

### 前置内容 (Front Matter)

- **献辞**：作者的献辞与致敬
- **致谢**：致谢与感谢名单
- **序言**：本书的序言与背景介绍
- **思想领袖的洞见**：权力与责任的深度思考
- **介绍**：全书引言与核心概念
- **什么是"智能体"？**：定义 AI 系统的"智能体"特征
  Agent 通常被定义为具有 感知 (Perception)、大脑/决策 (Brain/Decision) 和 行动 (Action) 能力的系统。

### 第一部分：核心设计模式 (Part One: Core Patterns)

这七章构成了 Agent 的“骨架”和“神经系统”。

### 第 1 章：提示链 (Prompt Chaining)

- **核心逻辑**：**线性流水线 (Linear Pipeline)**。
- **一针见血**：LLM 的注意力是有限的，试图在一个 Prompt 里做完所有事是灾难。提示链就是把一个复杂的“大黑盒”拆解成一组确定的“小黑盒”。上一个环节的输出（Output）严格作为下一个环节的输入（Input）。
- **架构价值**：**确定性与可控性**。通过牺牲一点延迟，换取每一步的高精度，是处理长文档处理、ETL 任务的基石。

### 第 2 章：路由 (Routing)

- **核心逻辑**：**网关分发 (Gateway / Dispatcher)**。
- **一针见血**：不是所有问题都需要最贵的模型（如 Claude 3.5 Opus），也不是所有问题都需要查数据库。路由就是 Agent 的“前台”，根据用户意图的分类（Intent Classification），决定把请求转发给哪个模型、哪个 Prompt 模板或哪条处理路径。
- **架构价值**：**成本与性能的平衡**。杀鸡不用牛刀，让小模型处理闲聊，大模型处理逻辑，工具处理查询。

### 第 3 章：并行化 (Parallelization)

- **核心逻辑**：**Map-Reduce / 投票机制**。
- **一针见血**：当任务之间没有依赖关系时，不要串行。
  1.  **分片 (Sectioning)**：同时翻译一本书的 10 个章节。
  2.  **投票 (Voting)**：让同一个模型生成 3 个不同的方案，再用另一个 Prompt 选出最好的一个（Best-of-N）。
- **架构价值**：**速度与质量的上限突破**。利用并发换取时间，利用多样性消除幻觉。

### 第 4 章：反思 (Reflection)

- **核心逻辑**：**反馈循环 (Feedback Loop)**。
- **一针见血**：LLM 往往“写代码”的能力不如“看代码”的能力强。反思模式就是强迫模型在输出最终结果前，先扮演“审查员”角色，检查自己的输出是否有误，并进行自我修正。
- **架构价值**：**从“生成”到“解决”的质变**。这是 Agent 产生“智能感”的关键，它模拟了人类的“系统 2”思维（慢思考），显著提升复杂任务的成功率。

### 第 5 章：工具使用 (Tool Use)

- **核心逻辑**：**函数调用 (Function Calling) / 外部挂载**。
- **一针见血**：LLM 本质是“缸中之脑”，只懂概率不懂事实。工具使用就是给它装上“手”和“眼”。模型不再直接回答问题，而是输出一个结构化的指令（如 JSON），由宿主环境执行（查库、算数、调 API），再把结果喂回给模型。
- **架构价值**：**落地能力的边界**。这是区分“聊天机器人”和“AI 助理”的分水岭，连接了概率性的 AI 世界和确定性的软件世界。

### 第 6 章：规划 (Planning)

- **核心逻辑**：**动态编排 (Dynamic Orchestration)**。
- **一针见血**：面对模糊的宏大目标（如“帮我写个游戏”），模型不能直接上手。规划模式要求模型先生成一个“任务清单（To-Do List）”，然后逐个执行，并根据执行结果动态调整后续计划（ReAct 模式）。
- **架构价值**：**处理复杂度的能力**。让 Agent 具备了处理长周期、多步骤、非确定性任务的能力。

### 第 7 章：多智能体协作 (Multi-Agent Collaboration)

- **核心逻辑**：**角色扮演与分布式系统 (Role-Playing & Microservices)**。
- **一针见血**：一个全能的 Prompt 很难写好。多智能体就是把复杂的任务拆给不同的“专家角色”（如：产品经理 Agent、开发 Agent、测试 Agent）。它们共享上下文，通过标准化的协议互相“对话”或“交接工作”。
- **架构价值**：**解耦与涌现**。通过角色隔离，降低了单个 Prompt 的复杂度；通过交互，系统往往能涌现出超越单个模型能力的解决方案。

### 第二部分：高级设计模式 (Part Two: Advanced Patterns)

如果说第一部分是构建 Agent 的“骨架”，那么这一部分就是赋予它“灵魂”和“成长能力”。

### 第 8 章：记忆管理 (Memory Management)

- **核心逻辑**：**状态持久化与上下文窗口优化 (State Persistence & Context Optimization)**。
- **一针见血**：LLM 本质是无状态的（像金鱼一样，只有 7 秒记忆）。记忆管理就是给它外挂一个“硬盘”。
  - **短期记忆**：就是当前的 Context Window（上下文窗口），类似于计算机的 RAM，昂贵且有限。
  - **长期记忆**：通常通过向量数据库（Vector DB）或摘要日志实现，类似于硬盘。
  - **关键点**：不在于“记住所有事”，而在于**“遗忘”**。如何从海量历史中只提取当前任务最需要的 1% 信息，塞进有限的 Context Window 里，是本章的核心。
- **架构价值**：**连续性与个性化**。让 Agent 能够跨越多次会话保持连贯，并记住用户的偏好。

### 第 9 章：学习与适应 (Learning and Adaptation)

- **核心逻辑**：**动态少样本学习 (Dynamic Few-Shot) / 经验库更新**。
- **一针见血**：真正的“学习”通常不指重新训练模型（Fine-tuning 成本太高），而是指**更新 Prompt 中的示例**。
  - 当 Agent 做对了一件事，把这个案例存入“成功库”。
  - 当 Agent 做错了一件事，把修正后的逻辑存入“规则库”。
  - 下次遇到类似任务时，动态地把这些经验作为 Few-Shot 示例注入 Prompt。
- **架构价值**：**自我进化**。系统越用越聪明，错误率随时间推移指数级下降，而无需修改一行代码。

### 第 10 章：模型上下文协议 (Model Context Protocol, MCP)

- **核心逻辑**：**标准化接口 (Standardized Interface / USB for AI)**。
- **一针见血**：这是目前 AI 领域最前沿的工程标准（Anthropic 大力推崇）。
  - 在 MCP 出现之前，连接一个数据库、一个 Notion 文档或一个本地文件系统，需要写各种胶水代码。
  - MCP 定义了一套通用的协议，让数据源（Server）和 AI 模型（Client）解耦。AI 可以像操作系统挂载 U 盘一样，自动“发现”并“读取”任何支持 MCP 的资源。
- **架构价值**：**互操作性与生态扩展**。它解决了“N 个模型 x M 个工具”的集成爆炸问题，让 Agent 的能力可以即插即用。

### 第 11 章：目标设定与监控 (Goal Setting and Monitoring)

- **核心逻辑**：**分层任务网络 (HTN) 与 遥测 (Telemetry)**。
- **一针见血**：
  - **目标设定**：不仅仅是“我要做什么”，而是将模糊的意图转化为可度量的 KPI 或里程碑（Milestones）。
  - **监控**：Agent 很容易陷入“死循环”或“幻觉风暴”。这需要一个独立的“监工进程”（Supervisor），实时检查 Agent 的轨迹。如果它在同一个步骤卡了 5 次，或者输出了乱码，监控器会强制通过信号（Signal）打断并重置它。
- **架构价值**：**对齐与鲁棒性**。确保 Agent 在长时间运行的任务中不跑偏，且在失控时有熔断机制。

### 第三部分：集成设计模式 (Part Three: Integration Patterns)

如果说前两部分是关于 Agent 如何“独处”和“成长”，那么这一部分就是关于 Agent 如何**“融入真实世界”**。真实世界是混乱的、需要人类监管的、且信息海量的。

### 第 12 章：异常处理与恢复 (Exception Handling and Recovery)

- **核心逻辑**：**弹性工程 (Resilience Engineering) / 熔断与重试**。
- **一针见血**：在传统软件中，Bug 是异常；在 AI Agent 中，**错误是常态**。
  - LLM 会产生幻觉，API 会超时，生成的 JSON 格式会乱掉。
  - 这一章不讲 `try-catch`，讲的是**“自愈”**。
  - 比如：当 Agent 生成的代码运行报错时，不要直接抛出异常给用户，而是把错误日志喂回给 Agent，让它自己尝试修复（Self-Correction）。`如果连续 3 次修复失败，再触发“人工干预”或“降级服务”。`
- **架构价值**：**可用性 (Availability)**。让系统在不可靠的模型之上构建出可靠的服务。

### 第 13 章：人机协作 (Human-AI Collaboration)

- **核心逻辑**：**人机回环 (Human-in-the-loop, HITL) / 混合智能**。
- **一针见血**：全自动是神话，半自动才是王道。
  - 这一章的核心在于**“权限分级”**和**“主动求助”**。
  - 对于低风险操作（如整理文件），Agent 全权负责；对于高风险操作（如转账、删除数据库），Agent 必须暂停并请求人类批准（Approval Workflow）。
  - 更高级的模式是，当 Agent 发现置信度（Confidence Score）低于阈值时，主动向人类提问：“我不确定这个发票的日期是哪一个，请帮我确认。”
- **架构价值**：**信任与安全 (Trust & Safety)**。这是 Agent 走出实验室、进入企业生产环境的“签证”。

### 第 14 章：知识检索 (RAG)

- **核心逻辑**：**动态上下文注入 (Dynamic Context Injection)**。
- **一针见血**：LLM 的训练数据是过期的（Frozen Weights），而企业的业务数据是实时的。
  - RAG (Retrieval-Augmented Generation) 本质上是**“开卷考试”**。
  - 不要让模型“背诵”知识，而是教它“查阅”知识。
  - 这一章不仅讲向量数据库，更讲**“混合检索”**（Hybrid Search = 向量 + 关键词）和**“重排序”**（Rerank）。关键不在于搜到多少文档，而在于如何把最关键的 500 个字精准地喂给模型，防止“大海捞针”变成“垃圾进，垃圾出”。
- **架构价值**：**准确性与时效性**。解决了大模型的“幻觉”问题和“知识截止”问题，是企业级 Agent 的标配。

### 第四部分：生产设计模式 (Part Four: Production Patterns)

如果说前三部分是关于如何构建一个“能用的”Agent，那么第四部分就是关于如何构建一个**“能赚钱、可扩展、且不会把公司搞破产”**的生产级系统。这是从“Demo”到“Product”的跨越。

### 第 15 章：智能体间通信 (A2A)

- **核心逻辑**：**标准化协议与握手 (Standardized Protocols & Handshakes)**。
- **一针见血**：Agent 之间对话不应该用自然语言（英语/中文），而应该用**结构化数据**（JSON/Protobuf）。
  - 人类对话充满歧义，机器对话追求精确。
  - A2A 模式定义了 Agent 之间如何“谈判”、如何“移交任务”、以及如何“共享状态”。
  - 例如：客服 Agent 发现用户要退款，它不应该对财务 Agent 说“嘿，帮这人退个钱”，而应该发送一个签名的 `{ "action": "refund", "amount": 50, "auth_token": "xyz" }` 数据包。
- **架构价值**：**解耦与协作效率**。让不同团队开发的 Agent 能够像微服务一样无缝协作，构建“Agent Swarm（智能体集群）”。

### 第 16 章：资源感知优化 (Resource-Aware Optimization)

- **核心逻辑**：**成本控制与计算经济学 (Cost Control & Computational Economics)**。
- **一针见血**：Token 就是钱，延迟就是用户流失。
  - 生产环境不能无脑用 GPT-4。这一章讲的是**“动态算力分配”**。
  - **Token 压缩**：在不丢失关键信息的前提下，把 10k 的 Context 压缩成 1k。
  - **模型级联**：先用极低成本的模型（如 Llama-3-8B）尝试解决，只有当置信度低时，才升级（Escalate）到昂贵的模型。
  - **缓存**：对相似的 Query 直接返回缓存结果（Semantic Caching）。
- **架构价值**：**商业可行性 (Unit Economics)**。确保你的 Agent 产生的价值大于它消耗的电费和 API 费用。

### 第 17 章：推理技术 (Reasoning Techniques)

- **核心逻辑**：**算法引导的思维 (Algorithm-Guided Thinking)**。
- **一针见血**：Prompt Engineering 只是皮毛，推理技术是骨相。
  - 这一章超越了简单的 CoT（思维链），深入到 **ToT (Tree of Thoughts)** 和 **GoT (Graph of Thoughts)**。
  - 它不只是让模型“一步步想”，而是让模型“生成三个方案 -> 评估每个方案的优劣 -> 回溯 -> 选择最佳路径”。这是把**搜索算法（BFS/DFS）**的思想应用到思维过程中。
- **架构价值**：**解决复杂难题**。让 Agent 能够处理数学证明、复杂代码重构或侦探推理类任务。

### 第 18 章：护栏/安全模式 (Guardrails / Safety Patterns)

- **核心逻辑**：**确定性防御层 (Deterministic Defense Layer)**。
- **一针见血**：永远不要相信 LLM 会自己遵守规则。
  - 护栏是包裹在 LLM 外面的一层**非 AI 代码**。
  - **输入护栏**：检测 Prompt 注入、PII（个人隐私信息）泄露。
  - **输出护栏**：检测有害内容、竞争对手提及、格式错误。
  - 如果 LLM 输出了不该说的，护栏会直接拦截并返回预设的安全回复，而不是让用户看到乱七八糟的东西。
- **架构价值**：**合规与品牌安全**。这是企业级应用上线的红线，防止 Agent 变成“公关灾难”。

### 第 19 章：评估与监控 (Evaluation and Monitoring)

- **核心逻辑**：**LLM-as-a-Judge 与 可观测性 (Observability)**。
- **一针见血**：你怎么知道你的 Agent 变好了还是变坏了？
  - 传统的单元测试（assert x == 5）对 Agent 无效。
  - 这一章讲的是构建**“评估数据集 (Golden Dataset)”**和使用**“裁判模型”**。让 GPT-4 去给 Llama-3 的回答打分。
  - 监控不仅仅是看延迟，还要看**“意图识别准确率”**、**“工具调用成功率”**和**“幻觉率”**。
- **架构价值**：**数据驱动的迭代**。告别“凭感觉调优”，建立科学的质量度量体系。

### 第 20 章：优先级排序 (Prioritization)

- **核心逻辑**：**任务调度与注意力管理 (Task Scheduling & Attention Management)**。
- **一针见血**：当 Agent 同时面对 10 个任务时，该先做哪个？
  - 这不仅仅是队列管理，更是**“上下文切换成本”**的管理。
  - Agent 需要具备评估任务**“紧急度”**和**“重要度”**的能力。
  - 对于长耗时任务（如写代码），Agent 应该将其放入后台（Async），先快速响应用户的短查询，避免阻塞交互。
- **架构价值**：**用户体验与吞吐量**。让 Agent 表现得像一个训练有素、处变不惊的行政助理，而不是一个单线程的脚本。

### 第 21 章：探索与发现 (Exploration and Discovery)

- **核心逻辑**：**主动学习与好奇心 (Active Learning & Curiosity)**。
- **一针见血**：普通的 Agent 是被动的（你问它答），高级的 Agent 是主动的。
  - 当 Agent 发现现有工具无法解决问题时，它是否能**自主搜索新工具**？
  - 当 Agent 发现数据缺失时，它是否能**主动提出问题**来获取信息？
  - 这一章探讨的是赋予 Agent 一种“探索未知”的机制，在安全边界内尝试新的路径，从而发现人类未曾预设的解决方案。
- **架构价值**：**创新与鲁棒性**。这是通往 AGI（通用人工智能）的一扇小窗，让系统具备应对“未见过的世界”的能力。
