# TypeScript 实现 Barrier 同步原语

Barrier（屏障）是一种同步原语，它允许多个任务在某一点同步等待，直到所有任务都到达该点后才能继续执行。下面是一个完整的 TypeScript 实现：

## Barrier 实现详解

### 核心属性

1. `_parties`: 需要等待的任务总数
2. `_waitCount`: 当前已到达屏障的任务数
3. `_generation`: 代数计数器，用于区分屏障的不同使用周期
4. `_broken`: 表示屏障是否处于损坏状态
5. `_waiters`: 等待队列，存储所有已到达但尚未通过屏障的任务
6. `_onReset`: 当所有任务到达屏障时执行的回调函数

### 主要方法

1. **构造函数**:

   - 接受需要同步的任务数量
   - 可选的接受一个在所有任务到达时执行的回调函数

2. **wait(timeout?)**:

   - 异步方法，表示当前任务已到达屏障
   - 增加等待计数，并检查是否为最后一个到达的任务
   - 如果是最后一个到达的任务，触发重置过程
   - 否则加入等待队列，直到所有任务都到达
   - 支持超时机制，在指定时间内如果屏障未打开，则标记为损坏并抛出错误
   - 返回当前任务在此屏障上的到达索引（0到parties-1）

3. **reset()** (私有方法):

   - 重置屏障状态，准备下一次使用
   - 递增代数计数器，使旧的等待状态失效
   - 执行回调函数(如果提供)
   - 唤醒所有等待的任务
   - 返回最后到达任务的索引

4. **breakBarrier()**:

   - 将屏障置于损坏状态
   - 唤醒所有等待的任务，但拒绝它们的Promise
   - 后续对wait()的调用将立即失败

5. **reset_manually()**:
   - 手动重置屏障状态
   - 清除损坏标志，允许屏障再次使用

### 特性

1. **自动重置**:

   - 屏障在所有任务到达后会自动重置，可以重复使用

2. **到达索引**:

   - 每个任务获得一个唯一的到达索引，可用于协调工作

3. **屏障动作**:

   - 可以指定一个在所有任务到达时执行的回调函数
   - 如果回调抛出异常，屏障将进入损坏状态

4. **超时机制**:

   - wait()方法支持超时参数
   - 超时后屏障会被破坏，所有等待任务收到错误

5. **损坏状态**:
   - 当发生异常或调用breakBarrier()时，屏障进入损坏状态
   - 可以通过reset_manually()恢复

### 使用场景

1. **并行计算**:

   - 多个任务共同处理问题的不同部分，然后在同步点汇总结果

2. **多阶段算法**:

   - 当算法有多个阶段，每个阶段都需要等待所有任务完成

3. **并发测试**:

   - 确保多个并发操作在特定点同步

4. **模拟分布式系统**:
   - 在模拟环境中协调多个组件

这个实现与Java的CyclicBarrier类似，提供了完整的功能集，适合在TypeScript/JavaScript异步环境中使用。
